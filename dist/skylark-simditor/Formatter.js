/**
 * skylark-simditor - A version of simditor.js that ported to running on skylarkjs
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylark-integration/skylark-simditor/
 * @license MIT
 */
define(["skylark-jquery","./_extend","./Module"],function(t,e,n){var r=[].indexOf,o=n.inherit({});return o.pluginName="Formatter",o.prototype.opts={allowedTags:[],allowedAttributes:{},allowedStyles:{}},o.prototype._init=function(){return this.editor=this._module,this._allowedTags=t.merge(["br","span","a","img","b","strong","i","strike","u","font","p","ul","ol","li","blockquote","pre","code","h1","h2","h3","h4","hr"],this.opts.allowedTags),this._allowedAttributes=t.extend({img:["src","alt","width","height","data-non-image"],a:["href","target"],font:["color"],code:["class"]},this.opts.allowedAttributes),this._allowedStyles=t.extend({span:["color","font-size"],b:["color","font-size"],i:["color","font-size"],strong:["color","font-size"],strike:["color","font-size"],u:["color","font-size"],p:["margin-left","text-align"],h1:["margin-left","text-align"],h2:["margin-left","text-align"],h3:["margin-left","text-align"],h4:["margin-left","text-align"]},this.opts.allowedStyles),this.editor.body.on("click","a",function(t){return!1})},o.prototype.decorate=function(t){return null==t&&(t=this.editor.body),this.editor.trigger("decorate",[t]),t},o.prototype.undecorate=function(t){return null==t&&(t=this.editor.body.clone()),this.editor.trigger("undecorate",[t]),t},o.prototype.autolink=function(e){var n,r,o,i,l,s,a,d,u,p,h,c,f;for(null==e&&(e=this.editor.body),a=[],(o=function(n){return n.contents().each(function(n,r){var i,l;if(!(i=t(r)).is("a")&&!i.closest("a, pre",e).length)return!i.is("iframe")&&i.contents().length?o(i):(l=i.text())&&/https?:\/\/|www\./gi.test(l)?a.push(i):void 0})})(e),u=/(https?:\/\/|www\.)[\w\-\.\?&=\/#%:,@\!\+]+/gi,i=0,s=a.length;i<s;i++){for(c=(r=a[i]).text(),p=[],d=null,l=0;null!==(d=u.exec(c));)h=c.substring(l,d.index),p.push(document.createTextNode(h)),l=u.lastIndex,f=/^(http(s)?:\/\/|\/)/.test(d[0])?d[0]:"http://"+d[0],n=t('<a href="'+f+'" rel="nofollow"></a>').text(d[0]),p.push(n[0]);p.push(document.createTextNode(c.substring(l))),r.replaceWith(t(p))}return e},o.prototype.format=function(e){var n,r,o,i,l,s,a,d,u,p;if(null==e&&(e=this.editor.body),e.is(":empty"))return e.append("<p>"+this.editor.util.phBr+"</p>"),e;for(o=0,l=(u=e.contents()).length;o<l;o++)a=u[o],this.cleanNode(a,!0);for(i=0,s=(p=e.contents()).length;i<s;i++)d=p[i],(n=t(d)).is("br")?(void 0!==r&&null!==r&&(r=null),n.remove()):this.editor.util.isBlockNode(d)?n.is("li")?r&&r.is("ul, ol")?r.append(d):(r=t("<ul/>").insertBefore(d)).append(d):r=null:(r&&!r.is("ul, ol")||(r=t("<p/>").insertBefore(d)),r.append(d),this.editor.util.isEmptyNode(r)&&r.append(this.editor.util.phBr));return e},o.prototype.cleanNode=function(e,n){var o,i,l,s,a,d,u,p,h,c,f,g,m,y,b,w,v,x;if((l=t(e)).length>0){if(3!==l[0].nodeType){if(p=l.is("iframe")?null:l.contents(),h=this.editor.util.isDecoratedNode(l),l.is(this._allowedTags.join(","))||h){if(l.is("a")&&(i=l.find("img")).length>0&&(l.replaceWith(i),l=i,p=null),l.is("td")&&(o=l.find(this.editor.util.blockNodes.join(","))).length>0&&(o.each(function(e,n){return t(n).contents().unwrap()}),p=l.contents()),l.is("img")&&l.hasClass("uploading")&&l.remove(),!h){for(d=this._allowedAttributes[l[0].tagName.toLowerCase()],c=0,g=(b=t.makeArray(l[0].attributes)).length;c<g;c++)"style"!==(u=b[c]).name&&(null!=d&&(w=u.name,r.call(d,w)>=0)||l.removeAttr(u.name));this._cleanNodeStyles(l),l.is("span")&&(0===l[0].attributes.length&&l.contents().first().unwrap(),2===l[0].style.length&&"rgb(51, 51, 51)"===l[0].style.color&&"16px"===l[0].style.fontSize&&l.contents().unwrap())}}else 1!==l[0].nodeType||l.is(":empty")?(l.remove(),p=null):l.is("div, article, dl, header, footer, tr")?(l.append("<br/>"),p.first().unwrap()):l.is("table")?(s=t("<p/>"),l.find("tr").each(function(e,n){return s.append(t(n).text()+"<br/>")}),l.replaceWith(s),p=null):l.is("thead, tfoot")?(l.remove(),p=null):l.is("th")?(a=t("<td/>").append(l.contents()),l.replaceWith(a)):p.first().unwrap();if(n&&null!=p&&!l.is("pre"))for(f=0,m=p.length;f<m;f++)y=p[f],this.cleanNode(y,!0);return null}(v=l.text().replace(/(\r\n|\n|\r)/gm,""))?(x=document.createTextNode(v),l.replaceWith(x)):l.remove()}},o.prototype._cleanNodeStyles=function(e){var n,o,i,l,s,a,d,u,p;if(u=e.attr("style")){if(e.removeAttr("style"),!((n=this._allowedStyles[e[0].tagName.toLowerCase()])&&n.length>0))return e;for(p={},o=0,i=(s=u.split(";")).length;o<i;o++)d=s[o],2===(l=(d=t.trim(d)).split(":")).length&&("font-size"===l[0]&&l[1].indexOf("px")>0&&parseInt(l[1],10)<12||(a=l[0],r.call(n,a)>=0&&(p[t.trim(l[0])]=t.trim(l[1]))));return Object.keys(p).length>0&&e.css(p),e}},o.prototype.clearHtml=function(e,n){var r,o,i,l;return null==n&&(n=!0),r=t("<div/>").append(e),o=r.contents(),i="",o.each((l=this,function(e,r){var s,a;return 3===r.nodeType?i+=r.nodeValue:1===r.nodeType&&((a=(s=t(r)).is("iframe")?null:s.contents())&&a.length>0&&(i+=l.clearHtml(a)),n&&e<o.length-1&&s.is("br, p, div, li,tr, pre, address, artticle, aside, dl, figcaption, footer, h1, h2,h3, h4, header"))?i+="\n":void 0})),i},o.prototype.beautify=function(e){var n;return n=function(t){return!!(t.is("p")&&!t.text()&&t.children(":not(br)").length<1)},e.each(function(e,r){var o;return((o=t(r)).is(':not(img, br, col, td, hr, [class^="simditor-"]):empty')||n(o))&&o.remove(),o.find(':not(img, br, col, td, hr, [class^="simditor-"]):empty').remove()})},o});
//# sourceMappingURL=sourcemaps/Formatter.js.map
