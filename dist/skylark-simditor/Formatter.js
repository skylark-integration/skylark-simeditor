/**
 * skylark-simditor - A version of simditor.js that ported to running on skylarkjs
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylark-integration/skylark-simditor/
 * @license MIT
 */
define(["skylark-langx/langx","skylark-jquery"],function(t,e){var n=[].indexOf,i=t.Evented.inherit({opts:{allowedTags:[],allowedAttributes:{},allowedStyles:{}},init:function(t){this.editor=t,this._allowedTags=e.merge(["br","span","a","img","b","strong","i","strike","u","font","p","ul","ol","li","blockquote","pre","code","h1","h2","h3","h4","hr"],this.opts.allowedTags),this._allowedAttributes=e.extend({img:["src","alt","width","height","data-non-image"],a:["href","target"],font:["color"],code:["class"]},this.opts.allowedAttributes),this._allowedStyles=e.extend({span:["color","font-size"],b:["color","font-size"],i:["color","font-size"],strong:["color","font-size"],strike:["color","font-size"],u:["color","font-size"],p:["margin-left","text-align"],h1:["margin-left","text-align"],h2:["margin-left","text-align"],h3:["margin-left","text-align"],h4:["margin-left","text-align"]},this.opts.allowedStyles),this.editor.body.on("click","a",function(t){return!1})},decorate:function(t){return null==t&&(t=this.editor.body),this.editor.trigger("decorate",[t]),t},undecorate:function(t){return null==t&&(t=this.editor.body.clone()),this.editor.trigger("undecorate",[t]),t},autolink:function(t){var n,i,r,l,o,s,a,d,u,h,c,p,f;for(null==t&&(t=this.editor.body),a=[],(r=function(n){return n.contents().each(function(n,i){var l,o;if(!(l=e(i)).is("a")&&!l.closest("a, pre",t).length)return!l.is("iframe")&&l.contents().length?r(l):(o=l.text())&&/https?:\/\/|www\./gi.test(o)?a.push(l):void 0})})(t),u=/(https?:\/\/|www\.)[\w\-\.\?&=\/#%:,@\!\+]+/gi,l=0,s=a.length;l<s;l++){for(p=(i=a[l]).text(),h=[],d=null,o=0;null!==(d=u.exec(p));)c=p.substring(o,d.index),h.push(document.createTextNode(c)),o=u.lastIndex,f=/^(http(s)?:\/\/|\/)/.test(d[0])?d[0]:"http://"+d[0],n=e('<a href="'+f+'" rel="nofollow"></a>').text(d[0]),h.push(n[0]);h.push(document.createTextNode(p.substring(o))),i.replaceWith(e(h))}return t},format:function(t){var n,i,r,l,o,s,a,d,u,h;if(null==t&&(t=this.editor.body),t.is(":empty"))return t.append("<p>"+this.editor.util.phBr+"</p>"),t;for(r=0,o=(u=t.contents()).length;r<o;r++)a=u[r],this.cleanNode(a,!0);for(l=0,s=(h=t.contents()).length;l<s;l++)d=h[l],(n=e(d)).is("br")?(void 0!==i&&null!==i&&(i=null),n.remove()):this.editor.util.isBlockNode(d)?n.is("li")?i&&i.is("ul, ol")?i.append(d):(i=e("<ul/>").insertBefore(d)).append(d):i=null:(i&&!i.is("ul, ol")||(i=e("<p/>").insertBefore(d)),i.append(d),this.editor.util.isEmptyNode(i)&&i.append(this.editor.util.phBr));return t},cleanNode:function(t,i){var r,l,o,s,a,d,u,h,c,p,f,g,m,y,b,w,v,x;if((o=e(t)).length>0){if(3!==o[0].nodeType){if(h=o.is("iframe")?null:o.contents(),c=this.editor.util.isDecoratedNode(o),o.is(this._allowedTags.join(","))||c){if(o.is("a")&&(l=o.find("img")).length>0&&(o.replaceWith(l),o=l,h=null),o.is("td")&&(r=o.find(this.editor.util.blockNodes.join(","))).length>0&&(r.each(function(t,n){return e(n).contents().unwrap()}),h=o.contents()),o.is("img")&&o.hasClass("uploading")&&o.remove(),!c){for(d=this._allowedAttributes[o[0].tagName.toLowerCase()],p=0,g=(b=e.makeArray(o[0].attributes)).length;p<g;p++)"style"!==(u=b[p]).name&&(null!=d&&(w=u.name,n.call(d,w)>=0)||o.removeAttr(u.name));this._cleanNodeStyles(o),o.is("span")&&(0===o[0].attributes.length&&o.contents().first().unwrap(),2===o[0].style.length&&"rgb(51, 51, 51)"===o[0].style.color&&"16px"===o[0].style.fontSize&&o.contents().unwrap())}}else 1!==o[0].nodeType||o.is(":empty")?(o.remove(),h=null):o.is("div, article, dl, header, footer, tr")?(o.append("<br/>"),h.first().unwrap()):o.is("table")?(s=e("<p/>"),o.find("tr").each(function(t,n){return s.append(e(n).text()+"<br/>")}),o.replaceWith(s),h=null):o.is("thead, tfoot")?(o.remove(),h=null):o.is("th")?(a=e("<td/>").append(o.contents()),o.replaceWith(a)):h.first().unwrap();if(i&&null!=h&&!o.is("pre"))for(f=0,m=h.length;f<m;f++)y=h[f],this.cleanNode(y,!0);return null}(v=o.text().replace(/(\r\n|\n|\r)/gm,""))?(x=document.createTextNode(v),o.replaceWith(x)):o.remove()}},_cleanNodeStyles:function(t){var i,r,l,o,s,a,d,u,h;if(u=t.attr("style")){if(t.removeAttr("style"),!((i=this._allowedStyles[t[0].tagName.toLowerCase()])&&i.length>0))return t;for(h={},r=0,l=(s=u.split(";")).length;r<l;r++)d=s[r],2===(o=(d=e.trim(d)).split(":")).length&&("font-size"===o[0]&&o[1].indexOf("px")>0&&parseInt(o[1],10)<12||(a=o[0],n.call(i,a)>=0&&(h[e.trim(o[0])]=e.trim(o[1]))));return Object.keys(h).length>0&&t.css(h),t}},clearHtml:function(t,n){var i,r,l,o;return null==n&&(n=!0),i=e("<div/>").append(t),r=i.contents(),l="",r.each((o=this,function(t,i){var s,a;return 3===i.nodeType?l+=i.nodeValue:1===i.nodeType&&((a=(s=e(i)).is("iframe")?null:s.contents())&&a.length>0&&(l+=o.clearHtml(a)),n&&t<r.length-1&&s.is("br, p, div, li,tr, pre, address, artticle, aside, dl, figcaption, footer, h1, h2,h3, h4, header"))?l+="\n":void 0})),l},beautify:function(t){var n;return n=function(t){return!!(t.is("p")&&!t.text()&&t.children(":not(br)").length<1)},t.each(function(t,i){var r;return((r=e(i)).is(':not(img, br, col, td, hr, [class^="simditor-"]):empty')||n(r))&&r.remove(),r.find(':not(img, br, col, td, hr, [class^="simditor-"]):empty').remove()})}});return i.pluginName="Formatter",i});
//# sourceMappingURL=sourcemaps/Formatter.js.map
