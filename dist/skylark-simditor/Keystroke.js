/**
 * skylark-simditor - A version of simditor.js that ported to running on skylarkjs
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylark-integration/skylark-simditor/
 * @license MIT
 */
define(["skylark-jquery","./_extend","./Module"],function(e,t,r){var i=r.inherit({});return i.pluginName="Keystroke",i.prototype._init=function(){return this.editor=this._module,this._keystrokeHandlers={},this._initKeystrokeHandlers()},i.prototype.add=function(e,t,r){return e=e.toLowerCase(),e=this.editor.hotkeys.constructor.aliases[e]||e,this._keystrokeHandlers[e]||(this._keystrokeHandlers[e]={}),this._keystrokeHandlers[e][t]=r},i.prototype.respondTo=function(t){var r,i,n,o,s;if(i=null!=(n=this.editor.hotkeys.constructor.keyNameMap[t.which])?n.toLowerCase():void 0)return!!(i in this._keystrokeHandlers&&((o="function"==typeof(r=this._keystrokeHandlers[i])["*"]?r["*"](t):void 0)||this.editor.selection.startNodes().each((s=this,function(r,n){var d,l;if(n.nodeType===Node.ELEMENT_NODE)return d=null!=(l=s._keystrokeHandlers[i])?l[n.tagName.toLowerCase()]:void 0,!0!==(o="function"==typeof d?d(t,e(n)):void 0)&&!1!==o&&void 0})),o))||void 0},i.prototype._initKeystrokeHandlers=function(){var t,r;return this.editor.util.browser.safari&&this.add("enter","*",(r=this,function(t){var i,n;if(t.shiftKey&&!(i=r.editor.selection.blockNodes().last()).is("pre"))return n=e("<br/>"),r.editor.selection.rangeAtEndOf(i)?(r.editor.selection.insertNode(n),r.editor.selection.insertNode(e("<br/>")),r.editor.selection.setRangeBefore(n)):r.editor.selection.insertNode(n),!0})),(this.editor.util.browser.webkit||this.editor.util.browser.msie)&&(t=function(t){return function(r,i){var n;if(t.editor.selection.rangeAtEndOf(i))return n=e("<p/>").append(t.editor.util.phBr).insertAfter(i),t.editor.selection.setRangeAtStartOf(n),!0}}(this),this.add("enter","h1",t),this.add("enter","h2",t),this.add("enter","h3",t),this.add("enter","h4",t),this.add("enter","h5",t),this.add("enter","h6",t)),this.add("backspace","*",function(e){return function(t){var r,i,n;return(i=(n=e.editor.selection.rootNodes().first()).prev()).is("hr")&&e.editor.selection.rangeAtStartOf(n)?(e.editor.selection.save(),i.remove(),e.editor.selection.restore(),!0):((r=e.editor.selection.blockNodes().last()).is(".simditor-resize-handle")&&n.is(".simditor-table")&&(t.preventDefault(),n.remove(),e.editor.selection.setRangeAtEndOf(i)),i.is(".simditor-table")&&!r.is("table")&&e.editor.util.isEmptyNode(r)&&(t.preventDefault(),r.remove(),e.editor.selection.setRangeAtEndOf(i)),e.editor.util.browser.webkit&&e.editor.selection.rangeAtStartOf(r)?(e.editor.selection.save(),e.editor.formatter.cleanNode(r,!0),e.editor.selection.restore(),null):void 0)}}(this)),this.add("enter","div",function(t){return function(r,i){var n;if(i.is(".simditor-table")&&t.editor.selection.blockNodes().last().is(".simditor-resize-handle"))return r.preventDefault(),n=e("<p/>").append(t.editor.util.phBr).insertAfter(i),t.editor.selection.setRangeAtStartOf(n)}}(this)),this.add("enter","li",function(t){return function(r,i){var n,o,s,d;if((n=i.clone()).find("ul, ol").remove(),t.editor.util.isEmptyNode(n)&&i.is(t.editor.selection.blockNodes().last())){if(o=i.parent(),i.next("li").length>0){if(!t.editor.util.isEmptyNode(i))return;o.parent("li").length>0?(s=e("<li/>").append(t.editor.util.phBr).insertAfter(o.parent("li")),d=e("<"+o[0].tagName+"/>").append(i.nextAll("li")),s.append(d)):(s=e("<p/>").append(t.editor.util.phBr).insertAfter(o),d=e("<"+o[0].tagName+"/>").append(i.nextAll("li")),s.after(d))}else o.parent("li").length>0?(s=e("<li/>").insertAfter(o.parent("li")),i.contents().length>0?s.append(i.contents()):s.append(t.editor.util.phBr)):(s=e("<p/>").append(t.editor.util.phBr).insertAfter(o),i.children("ul, ol").length>0&&s.after(i.children("ul, ol")));return i.prev("li").length?i.remove():i.prev("ul").length||i.prev("ol").length?i.remove():o.remove(),t.editor.selection.setRangeAtStartOf(s),!0}}}(this)),this.add("enter","pre",function(t){return function(r,i){var n,o,s;return r.preventDefault(),r.shiftKey?(n=e("<p/>").append(t.editor.util.phBr).insertAfter(i),t.editor.selection.setRangeAtStartOf(n),!0):(o=null,(s=t.editor.selection.range()).deleteContents(),o=!t.editor.util.browser.msie&&t.editor.selection.rangeAtEndOf(i)?document.createTextNode("\n\n"):document.createTextNode("\n"),s.insertNode(o),s.setEnd(o,1),s.collapse(!1),t.editor.selection.range(s),!0)}}(this)),this.add("enter","blockquote",function(e){return function(t,r){var i,n;if((i=e.editor.selection.blockNodes().last()).is("p")&&!i.next().length&&e.editor.util.isEmptyNode(i))return r.after(i),n=document.createRange(),e.editor.selection.setRangeAtStartOf(i,n),!0}}(this)),this.add("backspace","li",function(t){return function(r,i){var n,o,s,d,l,a,c,u,p;return o=i.children("ul, ol"),l=i.prev("li"),o.length>0&&l.length>0&&(p="",a=null,i.contents().each(function(t,r){return(1!==r.nodeType||!/UL|OL/.test(r.nodeName))&&(1===r.nodeType&&/BR/.test(r.nodeName)?void 0:(3===r.nodeType&&r.nodeValue?p+=r.nodeValue:1===r.nodeType&&(p+=e(r).text()),a=e(r)))}),c=t.editor.util.browser.firefox&&!a.next("br").length,a&&1===p.length&&c?(n=e(t.editor.util.phBr).insertAfter(a),a.remove(),t.editor.selection.setRangeBefore(n),!0):!(p.length>0)&&(u=document.createRange(),(d=l.children("ul, ol")).length>0?(s=e("<li/>").append(t.editor.util.phBr).appendTo(d),d.append(o.children("li")),i.remove(),t.editor.selection.setRangeAtEndOf(s,u)):(t.editor.selection.setRangeAtEndOf(l,u),l.append(o),i.remove(),t.editor.selection.range(u)),!0))}}(this)),this.add("backspace","pre",function(t){return function(r,i){var n,o,s;if(t.editor.selection.rangeAtStartOf(i))return o=i.html().replace("\n","<br/>")||t.editor.util.phBr,n=e("<p/>").append(o).insertAfter(i),i.remove(),s=document.createRange(),t.editor.selection.setRangeAtStartOf(n,s),!0}}(this)),this.add("backspace","blockquote",function(e){return function(t,r){var i,n;if(e.editor.selection.rangeAtStartOf(r))return i=r.children().first().unwrap(),n=document.createRange(),e.editor.selection.setRangeAtStartOf(i,n),!0}}(this))},i});
//# sourceMappingURL=sourcemaps/Keystroke.js.map
