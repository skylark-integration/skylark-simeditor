/**
 * skylark-simditor - A version of simditor.js that ported to running on skylarkjs
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylark-integration/skylark-simditor/
 * @license MIT
 */
define(["skylark-langx/langx","skylark-jquery"],function(t,e){var i=t.Evented.inherit({init:function(t){var e,i,n;this.editor=t,this._stack=[],this.editor.util.os.mac?(i="cmd+z",e="shift+cmd+z"):this.editor.util.os.win?(i="ctrl+z",e="ctrl+y"):(i="ctrl+z",e="shift+ctrl+z"),this.editor.hotkeys.add(i,(n=this,function(t){return t.preventDefault(),n.undo(),!1})),this.editor.hotkeys.add(e,function(t){return function(e){return e.preventDefault(),t.redo(),!1}}(this)),this.throttledPushState=this.editor.util.throttle(function(t){return function(){return t._pushUndoState()}}(this),2e3),this.editor.on("valuechanged",function(t){return function(e,i){if("undo"!==i&&"redo"!==i)return t.throttledPushState()}}(this)),this.editor.on("selectionchanged",function(t){return function(e){return t.resetCaretPosition(),t.update()}}(this)),this.editor.on("focus",function(t){return function(e){if(0===t._stack.length)return t._pushUndoState()}}(this)),this.editor.on("blur",function(t){return function(e){return t.resetCaretPosition()}}(this))}});return i.pluginName="UndoManager",i.prototype._index=-1,i.prototype._capacity=20,i.prototype._startPosition=null,i.prototype._endPosition=null,i.prototype.resetCaretPosition=function(){return this._startPosition=null,this._endPosition=null},i.prototype.startPosition=function(){return this.editor.selection._range&&(this._startPosition||(this._startPosition=this._getPosition("start"))),this._startPosition},i.prototype.endPosition=function(){var t;return this.editor.selection._range&&(this._endPosition||(this._endPosition=(t=this,function(){return t.editor.selection.range().collapsed?t._startPosition:t._getPosition("end")})())),this._endPosition},i.prototype._pushUndoState=function(){if(!1!==this.editor.triggerHandler("pushundostate")&&this.caretPosition().start)return this._index+=1,this._stack.length=this._index,this._stack.push({html:this.editor.body.html(),caret:this.caretPosition()}),this._stack.length>this._capacity?(this._stack.shift(),this._index-=1):void 0},i.prototype.currentState=function(){return this._stack.length&&this._index>-1?this._stack[this._index]:null},i.prototype.undo=function(){var t;if(!(this._index<1||this._stack.length<2))return this.editor.hidePopover(),this._index-=1,t=this._stack[this._index],this.editor.body.get(0).innerHTML=t.html,this.caretPosition(t.caret),this.editor.body.find(".selected").removeClass("selected"),this.editor.sync(),this.editor.trigger("valuechanged",["undo"])},i.prototype.redo=function(){var t;if(!(this._index<0||this._stack.length<this._index+2))return this.editor.hidePopover(),this._index+=1,t=this._stack[this._index],this.editor.body.get(0).innerHTML=t.html,this.caretPosition(t.caret),this.editor.body.find(".selected").removeClass("selected"),this.editor.sync(),this.editor.trigger("valuechanged",["redo"])},i.prototype.update=function(){var t;if(t=this.currentState())return t.html=this.editor.body.html(),t.caret=this.caretPosition()},i.prototype._getNodeOffset=function(t,i){var n,o,s;return n=e.isNumeric(i)?e(t):e(t).parent(),s=0,o=!1,n.contents().each(function(e,n){return t!==n&&(i!==e||0!==e)&&(n.nodeType===Node.TEXT_NODE?!o&&n.nodeValue.length>0&&(s+=1,o=!0):(s+=1,o=!1),i-1!==e&&null)}),s},i.prototype._getPosition=function(t){var i,n,o,s,r,d,h;if(null==t&&(t="start"),s=this.editor.selection.range()[t+"Offset"],(n=(i=this.editor.selection[t+"Nodes"]()).first()[0]).nodeType===Node.TEXT_NODE){for(d=n.previousSibling;d&&d.nodeType===Node.TEXT_NODE;)n=d,s+=this.editor.util.getNodeLength(d),d=d.previousSibling;(o=i.get())[0]=n,i=e(o)}else s=this._getNodeOffset(n,s);return r=[s],i.each((h=this,function(t,e){return r.unshift(h._getNodeOffset(e))})),r},i.prototype._getNodeByPosition=function(t){var i,n,o,s,r,d,h,a;for(d=this.editor.body[0],o=s=0,r=(a=t.slice(0,t.length-1)).length;s<r;o=++s){if((h=a[o])>(n=d.childNodes).length-1){if(o!==t.length-2||!e(d).is(":empty")){d=null;break}i=document.createTextNode(""),d.appendChild(i),n=d.childNodes}d=n[h]}return d},i.prototype.caretPosition=function(t){var e,i,n,o,s;if(t){if(!t.start)return;return o=this._getNodeByPosition(t.start),s=t.start[t.start.length-1],t.collapsed?(e=o,i=s):(e=this._getNodeByPosition(t.end),i=t.start[t.start.length-1]),o&&e?((n=document.createRange()).setStart(o,s),n.setEnd(e,i),this.editor.selection.range(n)):void("undefined"!=typeof console&&null!==console&&"function"==typeof console.warn&&console.warn("simditor: invalid caret state"))}return n=this.editor.selection.range(),t=this.editor.inputManager.focused&&null!=n?{start:this.startPosition(),end:this.endPosition(),collapsed:n.collapsed}:{}},i});
//# sourceMappingURL=sourcemaps/UndoManager.js.map
