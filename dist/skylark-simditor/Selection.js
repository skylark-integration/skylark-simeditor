/**
 * skylark-simditor - A version of simditor.js that ported to running on skylarkjs
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylark-integration/skylark-simditor/
 * @license MIT
 */
define(["skylark-jquery","./_extend","./Module"],function(t,e,n){var r=n.inherit({});return r.pluginName="Selection",r.prototype._range=null,r.prototype._startNodes=null,r.prototype._endNodes=null,r.prototype._containerNode=null,r.prototype._nodes=null,r.prototype._blockNodes=null,r.prototype._rootNodes=null,r.prototype._init=function(){var t;return this.editor=this._module,this._selection=document.getSelection(),this.editor.on("selectionchanged",(t=this,function(e){return t.reset(),t._range=t._selection.getRangeAt(0)})),this.editor.on("blur",function(t){return function(e){return t.reset()}}(this)),this.editor.on("focus",function(t){return function(e){return t.reset(),t._range=t._selection.getRangeAt(0)}}(this))},r.prototype.reset=function(){return this._range=null,this._startNodes=null,this._endNodes=null,this._containerNode=null,this._nodes=null,this._blockNodes=null,this._rootNodes=null},r.prototype.clear=function(){try{this._selection.removeAllRanges()}catch(t){t}return this.reset()},r.prototype.range=function(t){var e;return t?(this.clear(),this._selection.addRange(t),this._range=t,e=this.editor.util.browser.firefox||this.editor.util.browser.msie,!this.editor.inputManager.focused&&e&&this.editor.body.focus()):!this._range&&this.editor.inputManager.focused&&this._selection.rangeCount&&(this._range=this._selection.getRangeAt(0)),this._range},r.prototype.startNodes=function(){var e;return this._range&&(this._startNodes||(this._startNodes=(e=this,function(){var n;return(n=t(e._range.startContainer).parentsUntil(e.editor.body).get()).unshift(e._range.startContainer),t(n)})())),this._startNodes},r.prototype.endNodes=function(){var e;return this._range&&(this._endNodes||(this._endNodes=this._range.collapsed?this.startNodes():((e=t(this._range.endContainer).parentsUntil(this.editor.body).get()).unshift(this._range.endContainer),t(e)))),this._endNodes},r.prototype.containerNode=function(){return this._range&&(this._containerNode||(this._containerNode=t(this._range.commonAncestorContainer))),this._containerNode},r.prototype.nodes=function(){var e;return this._range&&(this._nodes||(this._nodes=(e=this,function(){var n;return n=[],e.startNodes().first().is(e.endNodes().first())?n=e.startNodes().get():(e.startNodes().each(function(r,o){var s,i,a,d,l,u,c;return i=t(o),e.endNodes().index(i)>-1?n.push(o):i.parent().is(e.editor.body)||(u=e.endNodes().index(i.parent()))>-1?(s=u&&u>-1?e.endNodes().eq(u-1):e.endNodes().last(),c=(a=i.parent().contents()).index(i),d=a.index(s),t.merge(n,a.slice(c,d).get())):(l=(a=i.parent().contents()).index(i),t.merge(n,a.slice(l).get()))}),e.endNodes().each(function(r,o){var s,i,a;return(s=t(o)).parent().is(e.editor.body)||e.startNodes().index(s.parent())>-1?(n.push(o),!1):(a=(i=s.parent().contents()).index(s),t.merge(n,i.slice(0,a+1)))})),t(t.unique(n))})())),this._nodes},r.prototype.blockNodes=function(){var t;if(this._range)return this._blockNodes||(this._blockNodes=(t=this,function(){return t.nodes().filter(function(e,n){return t.editor.util.isBlockNode(n)})})()),this._blockNodes},r.prototype.rootNodes=function(){var e;if(this._range)return this._rootNodes||(this._rootNodes=(e=this,function(){return e.nodes().filter(function(n,r){var o;return(o=t(r).parent()).is(e.editor.body)||o.is("blockquote")})})()),this._rootNodes},r.prototype.rangeAtEndOf=function(e,n){var r,o,s,i,a,d;if(null==n&&(n=this.range()),n&&n.collapsed)return e=t(e)[0],s=n.endContainer,i=this.editor.util.getNodeLength(s),o=n.endOffset===i-1,a=t(s).contents().last().is("br"),r=n.endOffset===i,!!(o&&a||r)&&(e===s||!!t.contains(e,s)&&(d=!0,t(s).parentsUntil(e).addBack().each(function(e,n){var r,o,s;if(s=(r=t(n).parent().contents().filter(function(){return!(this!==n&&3===this.nodeType&&!this.nodeValue)}).last()).get(0)===n,o=r.is("br")&&r.prev().get(0)===n,!s&&!o)return d=!1,!1}),d))},r.prototype.rangeAtStartOf=function(e,n){var r,o;if(null==n&&(n=this.range()),n&&n.collapsed)return e=t(e)[0],o=n.startContainer,0===n.startOffset&&(e===o||!!t.contains(e,o)&&(r=!0,t(o).parentsUntil(e).addBack().each(function(e,n){if(t(n).parent().contents().filter(function(){return!(this!==n&&3===this.nodeType&&!this.nodeValue)}).first().get(0)!==n)return r=!1}),r))},r.prototype.insertNode=function(e,n){if(null==n&&(n=this.range()),n)return e=t(e)[0],n.insertNode(e),this.setRangeAfter(e,n)},r.prototype.setRangeAfter=function(e,n){if(null==n&&(n=this.range()),null!=n)return e=t(e)[0],n.setEndAfter(e),n.collapse(!1),this.range(n)},r.prototype.setRangeBefore=function(e,n){if(null==n&&(n=this.range()),null!=n)return e=t(e)[0],n.setEndBefore(e),n.collapse(!1),this.range(n)},r.prototype.setRangeAtStartOf=function(e,n){return null==n&&(n=this.range()),e=t(e).get(0),n.setEnd(e,0),n.collapse(!1),this.range(n)},r.prototype.setRangeAtEndOf=function(e,n){var r,o,s,i,a,d,l;if(null==n&&(n=this.range()),e=(o=t(e))[0])return o.is("pre")?(s=o.contents()).length>0?(d=(i=s.last()).text(),a=this.editor.util.getNodeLength(i[0]),"\n"===d.charAt(d.length-1)?n.setEnd(i[0],a-1):n.setEnd(i[0],a)):n.setEnd(e,0):(l=this.editor.util.getNodeLength(e),3!==e.nodeType&&l>0&&((r=t(e).contents().last()).is("br")?l-=1:3!==r[0].nodeType&&this.editor.util.isEmptyNode(r)&&(r.append(this.editor.util.phBr),e=r[0],l=0)),n.setEnd(e,l)),n.collapse(!1),this.range(n)},r.prototype.deleteRangeContents=function(t){var e,n,r,o;return null==t&&(t=this.range()),o=t.cloneRange(),r=t.cloneRange(),o.collapse(!0),r.collapse(!1),n=this.rangeAtStartOf(this.editor.body,o),e=this.rangeAtEndOf(this.editor.body,r),!t.collapsed&&n&&e?(this.editor.body.empty(),t.setStart(this.editor.body[0],0),t.collapse(!0),this.range(t)):t.deleteContents(),t},r.prototype.breakBlockEl=function(e,n){var r;return null==n&&(n=this.range()),r=t(e),n.collapsed?(n.setStartBefore(r.get(0)),n.collapsed?r:r.before(n.extractContents())):r},r.prototype.save=function(e){var n,r,o;if(null==e&&(e=this.range()),!this._selectionSaved)return(r=e.cloneRange()).collapse(!1),o=t("<span/>").addClass("simditor-caret-start"),n=t("<span/>").addClass("simditor-caret-end"),r.insertNode(n[0]),e.insertNode(o[0]),this.clear(),this._selectionSaved=!0},r.prototype.restore=function(){var t,e,n,r,o,s,i;return!!this._selectionSaved&&(o=this.editor.body.find(".simditor-caret-start"),t=this.editor.body.find(".simditor-caret-end"),o.length&&t.length?(i=(s=o.parent()).contents().index(o),n=(e=t.parent()).contents().index(t),s[0]===e[0]&&(n-=1),(r=document.createRange()).setStart(s.get(0),i),r.setEnd(e.get(0),n),o.remove(),t.remove(),this.range(r)):(o.remove(),t.remove()),this._selectionSaved=!1,r)},r});
//# sourceMappingURL=sourcemaps/Selection.js.map
