{"version":3,"sources":["Button.js"],"names":["define","$","extend","Module","Simditor","Button","inherit","init","opts","this","editor","title","_t","name","prototype","call","_tpl","item","menuWrapper","menuItem","separator","icon","text","htmlTag","disableTag","menu","active","disabled","needFocus","shortcut","_init","k","len","ref","tag","_this","render","el","on","e","noFocus","param","preventDefault","inputManager","focused","hasClass","focus","wrapper","toggleClass","siblings","removeClass","is","offset","left","outerWidth","css","right","trigger","data","command","btn","currentTarget","toolbar","body","clipboard","pasting","setActive","setDisabled","hotkeys","add","mousedown","split","length","trim","inArray","formatter","_allowedTags","push","_status","iconClassOf","setIcon","find","addClass","appendTo","list","attr","renderMenu","$menuBtnEl","ref1","results","isArray","menuEl","data-param","_disableStatus","endNodes","startNodes","selection","filter","_activeStatus","endNode","startNode","node","args","result","arguments","Array","slice","apply"],"mappings":"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","file":"../Button.js","sourcesContent":["define([\r\n  \"skylark-jquery\",\r\n  \"./_extend\",\r\n  \"./Module\",\r\n  \"./Simditor\"\r\n],function($,extend,Module,Simditor){ \r\n  var slice = [].slice;\r\n\r\n  var Button = Module.inherit( {\r\n    init : function(opts) {\r\n      this.editor = opts.editor;\r\n      this.title = this._t(this.name);\r\n      Module.prototype.init.call(this, opts);\r\n    }\r\n  }); \r\n\r\n  Button.prototype._tpl = {\r\n    item: '<li><a tabindex=\"-1\" unselectable=\"on\" class=\"toolbar-item\" href=\"javascript:;\"><span></span></a></li>',\r\n    menuWrapper: '<div class=\"toolbar-menu\"></div>',\r\n    menuItem: '<li><a tabindex=\"-1\" unselectable=\"on\" class=\"menu-item\" href=\"javascript:;\"><span></span></a></li>',\r\n    separator: '<li><span class=\"separator\"></span></li>'\r\n  };\r\n\r\n  Button.prototype.name = '';\r\n\r\n  Button.prototype.icon = '';\r\n\r\n  Button.prototype.title = '';\r\n\r\n  Button.prototype.text = '';\r\n\r\n  Button.prototype.htmlTag = '';\r\n\r\n  Button.prototype.disableTag = '';\r\n\r\n  Button.prototype.menu = false;\r\n\r\n  Button.prototype.active = false;\r\n\r\n  Button.prototype.disabled = false;\r\n\r\n  Button.prototype.needFocus = true;\r\n\r\n  Button.prototype.shortcut = null;\r\n\r\n\r\n  Button.prototype._init = function() {\r\n    var k, len, ref, tag;\r\n    this.render();\r\n    this.el.on('mousedown', (function(_this) {\r\n      return function(e) {\r\n        var exceed, noFocus, param;\r\n        e.preventDefault();\r\n        noFocus = _this.needFocus && !_this.editor.inputManager.focused;\r\n        if (_this.el.hasClass('disabled')) {\r\n          return false;\r\n        }\r\n        if (noFocus) {\r\n          _this.editor.focus();\r\n        }\r\n        if (_this.menu) {\r\n          _this.wrapper.toggleClass('menu-on').siblings('li').removeClass('menu-on');\r\n          if (_this.wrapper.is('.menu-on')) {\r\n            exceed = _this.menuWrapper.offset().left + _this.menuWrapper.outerWidth() + 5 - _this.editor.wrapper.offset().left - _this.editor.wrapper.outerWidth();\r\n            if (exceed > 0) {\r\n              _this.menuWrapper.css({\r\n                'left': 'auto',\r\n                'right': 0\r\n              });\r\n            }\r\n            _this.trigger('menuexpand');\r\n          }\r\n          return false;\r\n        }\r\n        param = _this.el.data('param');\r\n        _this.command(param);\r\n        return false;\r\n      };\r\n    })(this));\r\n    this.wrapper.on('click', 'a.menu-item', (function(_this) {\r\n      return function(e) {\r\n        var btn, noFocus, param;\r\n        e.preventDefault();\r\n        btn = $(e.currentTarget);\r\n        _this.wrapper.removeClass('menu-on');\r\n        noFocus = _this.needFocus && !_this.editor.inputManager.focused;\r\n        if (btn.hasClass('disabled') || noFocus) {\r\n          return false;\r\n        }\r\n        _this.editor.toolbar.wrapper.removeClass('menu-on');\r\n        param = btn.data('param');\r\n        _this.command(param);\r\n        return false;\r\n      };\r\n    })(this));\r\n    this.wrapper.on('mousedown', 'a.menu-item', function(e) {\r\n      return false;\r\n    });\r\n    this.editor.on('blur', (function(_this) {\r\n      return function() {\r\n        var editorActive;\r\n        editorActive = _this.editor.body.is(':visible') && _this.editor.body.is('[contenteditable]');\r\n        if (!(editorActive && !_this.editor.clipboard.pasting)) {\r\n          return;\r\n        }\r\n        _this.setActive(false);\r\n        return _this.setDisabled(false);\r\n      };\r\n    })(this));\r\n    if (this.shortcut != null) {\r\n      this.editor.hotkeys.add(this.shortcut, (function(_this) {\r\n        return function(e) {\r\n          _this.el.mousedown();\r\n          return false;\r\n        };\r\n      })(this));\r\n    }\r\n    ref = this.htmlTag.split(',');\r\n    for (k = 0, len = ref.length; k < len; k++) {\r\n      tag = ref[k];\r\n      tag = $.trim(tag);\r\n      if (tag && $.inArray(tag, this.editor.formatter._allowedTags) < 0) {\r\n        this.editor.formatter._allowedTags.push(tag);\r\n      }\r\n    }\r\n    return this.editor.on('selectionchanged', (function(_this) {\r\n      return function(e) {\r\n        if (_this.editor.inputManager.focused) {\r\n          return _this._status();\r\n        }\r\n      };\r\n    })(this));\r\n  };\r\n\r\n  Button.prototype.iconClassOf = function(icon) {\r\n    if (icon) {\r\n      return \"simditor-icon simditor-icon-\" + icon;\r\n    } else {\r\n      return '';\r\n    }\r\n  };\r\n\r\n  Button.prototype.setIcon = function(icon) {\r\n    return this.el.find('span').removeClass().addClass(this.iconClassOf(icon)).text(this.text);\r\n  };\r\n\r\n  Button.prototype.render = function() {\r\n    this.wrapper = $(this._tpl.item).appendTo(this.editor.toolbar.list);\r\n    this.el = this.wrapper.find('a.toolbar-item');\r\n    this.el.attr('title', this.title).addClass(\"toolbar-item-\" + this.name).data('button', this);\r\n    this.setIcon(this.icon);\r\n    if (!this.menu) {\r\n      return;\r\n    }\r\n    this.menuWrapper = $(this._tpl.menuWrapper).appendTo(this.wrapper);\r\n    this.menuWrapper.addClass(\"toolbar-menu-\" + this.name);\r\n    return this.renderMenu();\r\n  };\r\n\r\n  Button.prototype.renderMenu = function() {\r\n    var $menuBtnEl, $menuItemEl, k, len, menuItem, ref, ref1, results;\r\n    if (!$.isArray(this.menu)) {\r\n      return;\r\n    }\r\n    this.menuEl = $('<ul/>').appendTo(this.menuWrapper);\r\n    ref = this.menu;\r\n    results = [];\r\n    for (k = 0, len = ref.length; k < len; k++) {\r\n      menuItem = ref[k];\r\n      if (menuItem === '|') {\r\n        $(this._tpl.separator).appendTo(this.menuEl);\r\n        continue;\r\n      }\r\n      $menuItemEl = $(this._tpl.menuItem).appendTo(this.menuEl);\r\n      $menuBtnEl = $menuItemEl.find('a.menu-item').attr({\r\n        'title': (ref1 = menuItem.title) != null ? ref1 : menuItem.text,\r\n        'data-param': menuItem.param\r\n      }).addClass('menu-item-' + menuItem.name);\r\n      if (menuItem.icon) {\r\n        results.push($menuBtnEl.find('span').addClass(this.iconClassOf(menuItem.icon)));\r\n      } else {\r\n        results.push($menuBtnEl.find('span').text(menuItem.text));\r\n      }\r\n    }\r\n    return results;\r\n  };\r\n\r\n  Button.prototype.setActive = function(active) {\r\n    if (active === this.active) {\r\n      return;\r\n    }\r\n    this.active = active;\r\n    return this.el.toggleClass('active', this.active);\r\n  };\r\n\r\n  Button.prototype.setDisabled = function(disabled) {\r\n    if (disabled === this.disabled) {\r\n      return;\r\n    }\r\n    this.disabled = disabled;\r\n    return this.el.toggleClass('disabled', this.disabled);\r\n  };\r\n\r\n  Button.prototype._disableStatus = function() {\r\n    var disabled, endNodes, startNodes;\r\n    startNodes = this.editor.selection.startNodes();\r\n    endNodes = this.editor.selection.endNodes();\r\n    disabled = startNodes.filter(this.disableTag).length > 0 || endNodes.filter(this.disableTag).length > 0;\r\n    this.setDisabled(disabled);\r\n    if (this.disabled) {\r\n      this.setActive(false);\r\n    }\r\n    return this.disabled;\r\n  };\r\n\r\n  Button.prototype._activeStatus = function() {\r\n    var active, endNode, endNodes, startNode, startNodes;\r\n    startNodes = this.editor.selection.startNodes();\r\n    endNodes = this.editor.selection.endNodes();\r\n    startNode = startNodes.filter(this.htmlTag);\r\n    endNode = endNodes.filter(this.htmlTag);\r\n    active = startNode.length > 0 && endNode.length > 0 && startNode.is(endNode);\r\n    this.node = active ? startNode : null;\r\n    this.setActive(active);\r\n    return this.active;\r\n  };\r\n\r\n  Button.prototype._status = function() {\r\n    this._disableStatus();\r\n    if (this.disabled) {\r\n      return;\r\n    }\r\n    return this._activeStatus();\r\n  };\r\n\r\n  Button.prototype.command = function(param) {};\r\n\r\n  Button.prototype._t = function() {\r\n    var args, ref, result;\r\n    args = 1 <= arguments.length ? Array.prototype.slice.call(arguments, 0) : [];\r\n    result = Module.prototype._t.apply(this, args);\r\n    if (!result) {\r\n      result = (ref = this.editor)._t.apply(ref, args);\r\n    }\r\n    return result;\r\n  };\r\n\r\n\r\n  Simditor.Button = Button;\r\n\r\n  return Button;\r\n});"]}