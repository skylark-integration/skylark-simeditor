{"version":3,"sources":["Simditor.js"],"names":["define","exports","module","__isValidToReturn","obj","Array","isArray","attr","__isEmptyObject","langx","$","hotkeys","uploader","Util","InputManager","Selection","UndoManager","Keystroke","Formatter","Toolbar","Indentation","Clipboard","i18n","Simditor","Evented","inherit","init","opts","editor","uploadOpts","this","extend","util","textarea","placeholder","length","Error","data","destroy","id","count","_render","el","body","upload","inputManager","selection","undoManager","keystroke","formatter","toolbar","toolbarFloat","toolbarHidden","toolbarFloatOffset","indentation","clipboard","self","on","_placeholder","setValue","val","trim","focus","browser","mozilla","reflow","document","execCommand","_error","prototype","triggerHandler","trigger","type","args","concat","apply","defaultImage","params","indentWidth","_tpl","key","ref","results","insertBefore","wrapper","find","placeholderEl","append","blur","os","mac","addClass","linux","mobile","push","name","value","insertAfter","children","isEmptyNode","parseInt","css","show","hide","hidePopover","get","innerHTML","format","decorate","lastCaretPosition","getValue","sync","cloneBody","emptyP","firstP","lastP","clone","undecorate","autolink","last","first","is","prev","remove","next","html","$blockEl","range","caretPosition","phBr","appendTo","createRange","setRangeAtEndOf","each","i","popover","active","closest","off","clear","focused","removeData","window"],"mappings":"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","file":"../Simditor.js","sourcesContent":["define([], function () {\n    'use strict';\n    var exports = {};\n    var module = { exports: {} };\n    define([\n        'skylark-langx/langx',\n        'skylark-jquery',\n        './hotkeys',\n        './uploader',\n        './Util',\n        './InputManager',\n        './Selection',\n        './UndoManager',\n        './Keystroke',\n        './Formatter',\n        './Toolbar',\n        './Indentation',\n        './Clipboard',\n        './i18n'\n    ], function (langx, $, hotkeys, uploader, Util, InputManager, Selection, UndoManager, Keystroke, Formatter, Toolbar, Indentation, Clipboard, i18n) {\n        var Simditor = langx.Evented.inherit({\n            init: function (opts) {\n                this.opts = langx.extend({}, this.opts, opts);\n                this.util = new Util(this);\n                var e, editor, uploadOpts;\n                this.textarea = $(this.opts.textarea);\n                this.opts.placeholder = this.opts.placeholder || this.textarea.attr('placeholder');\n                if (!this.textarea.length) {\n                    throw new Error('simditor: param textarea is required.');\n                    return;\n                }\n                editor = this.textarea.data('simditor');\n                if (editor != null) {\n                    editor.destroy();\n                }\n                this.id = ++Simditor.count;\n                this._render();\n                if (hotkeys) {\n                    this.hotkeys = hotkeys({ el: this.body });\n                } else {\n                    throw new Error('simditor: simple-hotkeys is required.');\n                    return;\n                }\n                if (this.opts.upload && uploader) {\n                    uploadOpts = typeof this.opts.upload === 'object' ? this.opts.upload : {};\n                    this.uploader = uploader(uploadOpts);\n                }\n                this.inputManager = new InputManager(this);\n                this.selection = new Selection(this);\n                this.undoManager = new UndoManager(this);\n                this.keystroke = new Keystroke(this);\n                this.formatter = new Formatter(this);\n                this.toolbar = new Toolbar(this, {\n                    toolbar: this.opts.toolbar,\n                    toolbarFloat: this.opts.toolbarFloat,\n                    toolbarHidden: this.opts.toolbarHidden,\n                    toolbarFloatOffset: this.opts.toolbarFloatOffset\n                });\n                this.indentation = new Indentation(this);\n                this.clipboard = new Clipboard(this);\n                var self = this;\n                if (this.opts.placeholder) {\n                    this.on('valuechanged', function () {\n                        return self._placeholder();\n                    });\n                }\n                this.setValue(this.textarea.val().trim() || '');\n                if (this.textarea.attr('autofocus')) {\n                    return self.focus();\n                }\n                if (this.util.browser.mozilla) {\n                    this.util.reflow();\n                    try {\n                        document.execCommand('enableObjectResizing', false, false);\n                        return document.execCommand('enableInlineTableEditing', false, false);\n                    } catch (_error) {\n                        e = _error;\n                    }\n                }\n            }\n        });\n        Simditor.prototype.triggerHandler = Simditor.prototype.trigger = function (type, data) {\n            var args, ref;\n            args = [type];\n            if (data) {\n                args = args.concat(data);\n            }\n            langx.Evented.prototype.trigger.apply(this, args);\n            return this;\n        };\n        Simditor.count = 0;\n        Simditor.prototype.opts = {\n            textarea: null,\n            placeholder: '',\n            defaultImage: 'images/image.png',\n            params: {},\n            upload: false,\n            indentWidth: 40\n        };\n        Simditor.prototype._tpl = '<div class=\"simditor\">\\n  <div class=\"simditor-wrapper\">\\n    <div class=\"simditor-placeholder\"></div>\\n    <div class=\"simditor-body\" contenteditable=\"true\">\\n    </div>\\n  </div>\\n</div>';\n        Simditor.prototype._render = function () {\n            var key, ref, results, val;\n            this.el = $(this._tpl).insertBefore(this.textarea);\n            this.wrapper = this.el.find('.simditor-wrapper');\n            this.body = this.wrapper.find('.simditor-body');\n            this.placeholderEl = this.wrapper.find('.simditor-placeholder').append(this.opts.placeholder);\n            this.el.data('simditor', this);\n            this.wrapper.append(this.textarea);\n            this.textarea.data('simditor', this).blur();\n            this.body.attr('tabindex', this.textarea.attr('tabindex'));\n            if (this.util.os.mac) {\n                this.el.addClass('simditor-mac');\n            } else if (this.util.os.linux) {\n                this.el.addClass('simditor-linux');\n            }\n            if (this.util.os.mobile) {\n                this.el.addClass('simditor-mobile');\n            }\n            if (this.opts.params) {\n                ref = this.opts.params;\n                results = [];\n                for (key in ref) {\n                    val = ref[key];\n                    results.push($('<input/>', {\n                        type: 'hidden',\n                        name: key,\n                        value: val\n                    }).insertAfter(this.textarea));\n                }\n                return results;\n            }\n        };\n        Simditor.prototype._placeholder = function () {\n            var children;\n            children = this.body.children();\n            if (children.length === 0 || children.length === 1 && this.util.isEmptyNode(children) && parseInt(children.css('margin-left') || 0) < this.opts.indentWidth) {\n                return this.placeholderEl.show();\n            } else {\n                return this.placeholderEl.hide();\n            }\n        };\n        Simditor.prototype.setValue = function (val) {\n            this.hidePopover();\n            this.textarea.val(val);\n            this.body.get(0).innerHTML = val;\n            this.formatter.format();\n            this.formatter.decorate();\n            this.util.reflow(this.body);\n            this.inputManager.lastCaretPosition = null;\n            return this.trigger('valuechanged');\n        };\n        Simditor.prototype.getValue = function () {\n            return this.sync();\n        };\n        Simditor.prototype.sync = function () {\n            var children, cloneBody, emptyP, firstP, lastP, val;\n            cloneBody = this.body.clone();\n            this.formatter.undecorate(cloneBody);\n            this.formatter.format(cloneBody);\n            this.formatter.autolink(cloneBody);\n            children = cloneBody.children();\n            lastP = children.last('p');\n            firstP = children.first('p');\n            while (lastP.is('p') && this.util.isEmptyNode(lastP)) {\n                emptyP = lastP;\n                lastP = lastP.prev('p');\n                emptyP.remove();\n            }\n            while (firstP.is('p') && this.util.isEmptyNode(firstP)) {\n                emptyP = firstP;\n                firstP = lastP.next('p');\n                emptyP.remove();\n            }\n            cloneBody.find('img.uploading').remove();\n            val = langx.trim(cloneBody.html());\n            this.textarea.val(val);\n            return val;\n        };\n        Simditor.prototype.focus = function () {\n            var $blockEl, range;\n            if (!(this.body.is(':visible') && this.body.is('[contenteditable]'))) {\n                this.el.find('textarea:visible').focus();\n                return;\n            }\n            if (this.inputManager.lastCaretPosition) {\n                this.undoManager.caretPosition(this.inputManager.lastCaretPosition);\n                return this.inputManager.lastCaretPosition = null;\n            } else {\n                $blockEl = this.body.children().last();\n                if (!$blockEl.is('p')) {\n                    $blockEl = $('<p/>').append(this.util.phBr).appendTo(this.body);\n                }\n                range = document.createRange();\n                return this.selection.setRangeAtEndOf($blockEl, range);\n            }\n        };\n        Simditor.prototype.blur = function () {\n            if (this.body.is(':visible') && this.body.is('[contenteditable]')) {\n                return this.body.blur();\n            } else {\n                return this.body.find('textarea:visible').blur();\n            }\n        };\n        Simditor.prototype.hidePopover = function () {\n            return this.el.find('.simditor-popover').each(function (i, popover) {\n                popover = $(popover).data('popover');\n                if (popover.active) {\n                    return popover.hide();\n                }\n            });\n        };\n        Simditor.prototype.destroy = function () {\n            this.triggerHandler('destroy');\n            this.textarea.closest('form').off('.simditor .simditor-' + this.id);\n            this.selection.clear();\n            this.inputManager.focused = false;\n            this.textarea.insertBefore(this.el).hide().val('').removeData('simditor');\n            this.el.remove();\n            $(document).off('.simditor-' + this.id);\n            $(window).off('.simditor-' + this.id);\n            return this.off();\n        };\n        Simditor.Toolbar = Toolbar;\n        Simditor.i18n = i18n;\n        return Simditor;\n    });\n    function __isEmptyObject(obj) {\n        var attr;\n        for (attr in obj)\n            return !1;\n        return !0;\n    }\n    function __isValidToReturn(obj) {\n        return typeof obj != 'object' || Array.isArray(obj) || !__isEmptyObject(obj);\n    }\n    if (__isValidToReturn(module.exports))\n        return module.exports;\n    else if (__isValidToReturn(exports))\n        return exports;\n});"]}