{"version":3,"sources":["Simditor.js"],"names":["define","exports","module","__isValidToReturn","obj","Array","isArray","attr","__isEmptyObject","$","extend","Module","hotkeys","uploader","Util","InputManager","Selection","UndoManager","Keystroke","Formatter","Toolbar","Indentation","Clipboard","Simditor","inherit","connect","count","prototype","opts","textarea","placeholder","defaultImage","params","upload","indentWidth","_init","editor","uploadOpts","_this","this","length","Error","data","destroy","id","_render","el","body","simpleUploader","on","_placeholder","setValue","val","trim","focus","util","browser","mozilla","reflow","document","execCommand","_error","_tpl","key","ref","results","insertBefore","wrapper","find","placeholderEl","append","blur","os","mac","addClass","linux","mobile","push","type","name","value","insertAfter","children","isEmptyNode","parseInt","css","show","hide","hidePopover","get","innerHTML","formatter","format","decorate","inputManager","lastCaretPosition","trigger","getValue","sync","cloneBody","emptyP","firstP","lastP","clone","undecorate","autolink","last","first","is","prev","remove","next","html","$blockEl","range","undoManager","caretPosition","phBr","appendTo","createRange","selection","setRangeAtEndOf","each","i","popover","active","triggerHandler","closest","off","clear","focused","removeData","window"],"mappings":"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","file":"../Simditor.js","sourcesContent":["define([], function () {\n    'use strict';\n    var exports = {};\n    var module = { exports: {} };\n    define([\n        'skylark-jquery',\n        './_extend',\n        './Module',\n        './hotkeys',\n        './uploader',\n        './Util',\n        './InputManager',\n        './Selection',\n        './UndoManager',\n        './Keystroke',\n        './Formatter',\n        './Toolbar',\n        './Indentation',\n        './Clipboard'\n    ], function ($, extend, Module, hotkeys, uploader, Util, InputManager, Selection, UndoManager, Keystroke, Formatter, Toolbar, Indentation, Clipboard) {\n        var Simditor = Module.inherit({});\n        Simditor.connect(Util);\n        Simditor.connect(InputManager);\n        Simditor.connect(Selection);\n        Simditor.connect(UndoManager);\n        Simditor.connect(Keystroke);\n        Simditor.connect(Formatter);\n        Simditor.connect(Toolbar);\n        Simditor.connect(Indentation);\n        Simditor.connect(Clipboard);\n        Simditor.count = 0;\n        Simditor.prototype.opts = {\n            textarea: null,\n            placeholder: '',\n            defaultImage: 'images/image.png',\n            params: {},\n            upload: false,\n            indentWidth: 40\n        };\n        Simditor.prototype._init = function () {\n            var e, editor, uploadOpts;\n            this.textarea = $(this.opts.textarea);\n            this.opts.placeholder = this.opts.placeholder || this.textarea.attr('placeholder');\n            if (!this.textarea.length) {\n                throw new Error('simditor: param textarea is required.');\n                return;\n            }\n            editor = this.textarea.data('simditor');\n            if (editor != null) {\n                editor.destroy();\n            }\n            this.id = ++Simditor.count;\n            this._render();\n            if (hotkeys) {\n                this.hotkeys = hotkeys({ el: this.body });\n            } else {\n                throw new Error('simditor: simple-hotkeys is required.');\n                return;\n            }\n            if (this.opts.upload && simpleUploader) {\n                uploadOpts = typeof this.opts.upload === 'object' ? this.opts.upload : {};\n                this.uploader = uploader(uploadOpts);\n            }\n            this.on('initialized', function (_this) {\n                return function () {\n                    if (_this.opts.placeholder) {\n                        _this.on('valuechanged', function () {\n                            return _this._placeholder();\n                        });\n                    }\n                    _this.setValue(_this.textarea.val().trim() || '');\n                    if (_this.textarea.attr('autofocus')) {\n                        return _this.focus();\n                    }\n                };\n            }(this));\n            if (this.util.browser.mozilla) {\n                this.util.reflow();\n                try {\n                    document.execCommand('enableObjectResizing', false, false);\n                    return document.execCommand('enableInlineTableEditing', false, false);\n                } catch (_error) {\n                    e = _error;\n                }\n            }\n        };\n        Simditor.prototype._tpl = '<div class=\"simditor\">\\n  <div class=\"simditor-wrapper\">\\n    <div class=\"simditor-placeholder\"></div>\\n    <div class=\"simditor-body\" contenteditable=\"true\">\\n    </div>\\n  </div>\\n</div>';\n        Simditor.prototype._render = function () {\n            var key, ref, results, val;\n            this.el = $(this._tpl).insertBefore(this.textarea);\n            this.wrapper = this.el.find('.simditor-wrapper');\n            this.body = this.wrapper.find('.simditor-body');\n            this.placeholderEl = this.wrapper.find('.simditor-placeholder').append(this.opts.placeholder);\n            this.el.data('simditor', this);\n            this.wrapper.append(this.textarea);\n            this.textarea.data('simditor', this).blur();\n            this.body.attr('tabindex', this.textarea.attr('tabindex'));\n            if (this.util.os.mac) {\n                this.el.addClass('simditor-mac');\n            } else if (this.util.os.linux) {\n                this.el.addClass('simditor-linux');\n            }\n            if (this.util.os.mobile) {\n                this.el.addClass('simditor-mobile');\n            }\n            if (this.opts.params) {\n                ref = this.opts.params;\n                results = [];\n                for (key in ref) {\n                    val = ref[key];\n                    results.push($('<input/>', {\n                        type: 'hidden',\n                        name: key,\n                        value: val\n                    }).insertAfter(this.textarea));\n                }\n                return results;\n            }\n        };\n        Simditor.prototype._placeholder = function () {\n            var children;\n            children = this.body.children();\n            if (children.length === 0 || children.length === 1 && this.util.isEmptyNode(children) && parseInt(children.css('margin-left') || 0) < this.opts.indentWidth) {\n                return this.placeholderEl.show();\n            } else {\n                return this.placeholderEl.hide();\n            }\n        };\n        Simditor.prototype.setValue = function (val) {\n            this.hidePopover();\n            this.textarea.val(val);\n            this.body.get(0).innerHTML = val;\n            this.formatter.format();\n            this.formatter.decorate();\n            this.util.reflow(this.body);\n            this.inputManager.lastCaretPosition = null;\n            return this.trigger('valuechanged');\n        };\n        Simditor.prototype.getValue = function () {\n            return this.sync();\n        };\n        Simditor.prototype.sync = function () {\n            var children, cloneBody, emptyP, firstP, lastP, val;\n            cloneBody = this.body.clone();\n            this.formatter.undecorate(cloneBody);\n            this.formatter.format(cloneBody);\n            this.formatter.autolink(cloneBody);\n            children = cloneBody.children();\n            lastP = children.last('p');\n            firstP = children.first('p');\n            while (lastP.is('p') && this.util.isEmptyNode(lastP)) {\n                emptyP = lastP;\n                lastP = lastP.prev('p');\n                emptyP.remove();\n            }\n            while (firstP.is('p') && this.util.isEmptyNode(firstP)) {\n                emptyP = firstP;\n                firstP = lastP.next('p');\n                emptyP.remove();\n            }\n            cloneBody.find('img.uploading').remove();\n            val = $.trim(cloneBody.html());\n            this.textarea.val(val);\n            return val;\n        };\n        Simditor.prototype.focus = function () {\n            var $blockEl, range;\n            if (!(this.body.is(':visible') && this.body.is('[contenteditable]'))) {\n                this.el.find('textarea:visible').focus();\n                return;\n            }\n            if (this.inputManager.lastCaretPosition) {\n                this.undoManager.caretPosition(this.inputManager.lastCaretPosition);\n                return this.inputManager.lastCaretPosition = null;\n            } else {\n                $blockEl = this.body.children().last();\n                if (!$blockEl.is('p')) {\n                    $blockEl = $('<p/>').append(this.util.phBr).appendTo(this.body);\n                }\n                range = document.createRange();\n                return this.selection.setRangeAtEndOf($blockEl, range);\n            }\n        };\n        Simditor.prototype.blur = function () {\n            if (this.body.is(':visible') && this.body.is('[contenteditable]')) {\n                return this.body.blur();\n            } else {\n                return this.body.find('textarea:visible').blur();\n            }\n        };\n        Simditor.prototype.hidePopover = function () {\n            return this.el.find('.simditor-popover').each(function (i, popover) {\n                popover = $(popover).data('popover');\n                if (popover.active) {\n                    return popover.hide();\n                }\n            });\n        };\n        Simditor.prototype.destroy = function () {\n            this.triggerHandler('destroy');\n            this.textarea.closest('form').off('.simditor .simditor-' + this.id);\n            this.selection.clear();\n            this.inputManager.focused = false;\n            this.textarea.insertBefore(this.el).hide().val('').removeData('simditor');\n            this.el.remove();\n            $(document).off('.simditor-' + this.id);\n            $(window).off('.simditor-' + this.id);\n            return this.off();\n        };\n        return Simditor;\n    });\n    function __isEmptyObject(obj) {\n        var attr;\n        for (attr in obj)\n            return !1;\n        return !0;\n    }\n    function __isValidToReturn(obj) {\n        return typeof obj != 'object' || Array.isArray(obj) || !__isEmptyObject(obj);\n    }\n    if (__isValidToReturn(module.exports))\n        return module.exports;\n    else if (__isValidToReturn(exports))\n        return exports;\n});"]}