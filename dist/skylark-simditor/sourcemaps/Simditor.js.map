{"version":3,"sources":["Simditor.js"],"names":["define","exports","module","__isValidToReturn","obj","Array","isArray","attr","__isEmptyObject","langx","$","hotkeys","Util","InputManager","Selection","UndoManager","Keystroke","Formatter","Indentation","Clipboard","Toolbar","uploader","i18n","Simditor","Evented","inherit","init","opts","this","extend","editor","uploadOpts","pluginOpts","classPrefix","util","textarea","placeholder","length","Error","data","destroy","id","count","_render","el","body","upload","inputManager","selection","undoManager","keystroke","formatter","toolbar","toolbarFloat","toolbarHidden","toolbarFloatOffset","indentation","clipboard","self","on","_placeholder","setValue","val","trim","focus","browser","mozilla","reflow","document","execCommand","_error","prototype","triggerHandler","trigger","type","args","concat","apply","defaultImage","params","indentWidth","_tpl","key","ref","results","insertBefore","wrapper","find","placeholderEl","append","blur","os","mac","addClass","linux","mobile","push","name","value","insertAfter","children","isEmptyNode","parseInt","css","show","hide","hidePopover","get","innerHTML","format","decorate","lastCaretPosition","getValue","sync","cloneBody","emptyP","firstP","lastP","clone","undecorate","autolink","last","first","is","prev","remove","next","html","$blockEl","range","caretPosition","phBr","appendTo","createRange","setRangeAtEndOf","each","i","popover","active","closest","off","clear","focused","removeData","window"],"mappings":"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","file":"../Simditor.js","sourcesContent":["define([], function () {\n    'use strict';\n    var exports = {};\n    var module = { exports: {} };\n    define([\n        'skylark-langx/langx',\n        'skylark-utils-dom/query',\n        'skylark-ui-contents/hotkeys',\n        'skylark-ui-contents/Util',\n        'skylark-ui-contents/InputManager',\n        'skylark-ui-contents/Selection',\n        'skylark-ui-contents/UndoManager',\n        'skylark-ui-contents/Keystroke',\n        'skylark-ui-contents/Formatter',\n        'skylark-ui-contents/Indentation',\n        'skylark-ui-contents/Clipboard',\n        './Toolbar',\n        './uploader',\n        './i18n'\n    ], function (langx, $, hotkeys, Util, InputManager, Selection, UndoManager, Keystroke, Formatter, Indentation, Clipboard, Toolbar, uploader, i18n) {\n        var Simditor = langx.Evented.inherit({\n            init: function (opts) {\n                this.opts = langx.extend({}, this.opts, opts);\n                var pluginOpts = { classPrefix: 'simditor-' };\n                this.util = new Util(this, pluginOpts);\n                var e, editor, uploadOpts;\n                this.textarea = $(this.opts.textarea);\n                this.opts.placeholder = this.opts.placeholder || this.textarea.attr('placeholder');\n                if (!this.textarea.length) {\n                    throw new Error('simditor: param textarea is required.');\n                    return;\n                }\n                editor = this.textarea.data('simditor');\n                if (editor != null) {\n                    editor.destroy();\n                }\n                this.id = ++Simditor.count;\n                this._render();\n                if (hotkeys) {\n                    this.hotkeys = hotkeys({ el: this.body });\n                } else {\n                    throw new Error('simditor: simple-hotkeys is required.');\n                    return;\n                }\n                if (this.opts.upload && uploader) {\n                    uploadOpts = typeof this.opts.upload === 'object' ? this.opts.upload : {};\n                    this.uploader = uploader(uploadOpts);\n                }\n                this.inputManager = new InputManager(this, pluginOpts);\n                this.selection = new Selection(this, pluginOpts);\n                this.undoManager = new UndoManager(this, pluginOpts);\n                this.keystroke = new Keystroke(this, pluginOpts);\n                this.formatter = new Formatter(this, pluginOpts);\n                this.toolbar = new Toolbar(this, {\n                    toolbar: this.opts.toolbar,\n                    toolbarFloat: this.opts.toolbarFloat,\n                    toolbarHidden: this.opts.toolbarHidden,\n                    toolbarFloatOffset: this.opts.toolbarFloatOffset\n                });\n                this.indentation = new Indentation(this, pluginOpts);\n                this.clipboard = new Clipboard(this, pluginOpts);\n                var self = this;\n                if (this.opts.placeholder) {\n                    this.on('valuechanged', function () {\n                        return self._placeholder();\n                    });\n                }\n                this.setValue(this.textarea.val().trim() || '');\n                if (this.textarea.attr('autofocus')) {\n                    return self.focus();\n                }\n                if (this.util.browser.mozilla) {\n                    this.util.reflow();\n                    try {\n                        document.execCommand('enableObjectResizing', false, false);\n                        return document.execCommand('enableInlineTableEditing', false, false);\n                    } catch (_error) {\n                        e = _error;\n                    }\n                }\n            }\n        });\n        Simditor.prototype.triggerHandler = Simditor.prototype.trigger = function (type, data) {\n            var args, ref;\n            args = [type];\n            if (data) {\n                args = args.concat(data);\n            }\n            langx.Evented.prototype.trigger.apply(this, args);\n            return this;\n        };\n        Simditor.count = 0;\n        Simditor.prototype.opts = {\n            textarea: null,\n            placeholder: '',\n            defaultImage: 'images/image.png',\n            params: {},\n            upload: false,\n            indentWidth: 40\n        };\n        Simditor.prototype._tpl = '<div class=\"simditor\">\\n  <div class=\"simditor-wrapper\">\\n    <div class=\"simditor-placeholder\"></div>\\n    <div class=\"simditor-body\" contenteditable=\"true\">\\n    </div>\\n  </div>\\n</div>';\n        Simditor.prototype._render = function () {\n            var key, ref, results, val;\n            this.el = $(this._tpl).insertBefore(this.textarea);\n            this.wrapper = this.el.find('.simditor-wrapper');\n            this.body = this.wrapper.find('.simditor-body');\n            this.placeholderEl = this.wrapper.find('.simditor-placeholder').append(this.opts.placeholder);\n            this.el.data('simditor', this);\n            this.wrapper.append(this.textarea);\n            this.textarea.data('simditor', this).blur();\n            this.body.attr('tabindex', this.textarea.attr('tabindex'));\n            if (this.util.os.mac) {\n                this.el.addClass('simditor-mac');\n            } else if (this.util.os.linux) {\n                this.el.addClass('simditor-linux');\n            }\n            if (this.util.os.mobile) {\n                this.el.addClass('simditor-mobile');\n            }\n            if (this.opts.params) {\n                ref = this.opts.params;\n                results = [];\n                for (key in ref) {\n                    val = ref[key];\n                    results.push($('<input/>', {\n                        type: 'hidden',\n                        name: key,\n                        value: val\n                    }).insertAfter(this.textarea));\n                }\n                return results;\n            }\n        };\n        Simditor.prototype._placeholder = function () {\n            var children;\n            children = this.body.children();\n            if (children.length === 0 || children.length === 1 && this.util.isEmptyNode(children) && parseInt(children.css('margin-left') || 0) < this.opts.indentWidth) {\n                return this.placeholderEl.show();\n            } else {\n                return this.placeholderEl.hide();\n            }\n        };\n        Simditor.prototype.setValue = function (val) {\n            this.hidePopover();\n            this.textarea.val(val);\n            this.body.get(0).innerHTML = val;\n            this.formatter.format();\n            this.formatter.decorate();\n            this.util.reflow(this.body);\n            this.inputManager.lastCaretPosition = null;\n            return this.trigger('valuechanged');\n        };\n        Simditor.prototype.getValue = function () {\n            return this.sync();\n        };\n        Simditor.prototype.sync = function () {\n            var children, cloneBody, emptyP, firstP, lastP, val;\n            cloneBody = this.body.clone();\n            this.formatter.undecorate(cloneBody);\n            this.formatter.format(cloneBody);\n            this.formatter.autolink(cloneBody);\n            children = cloneBody.children();\n            lastP = children.last('p');\n            firstP = children.first('p');\n            while (lastP.is('p') && this.util.isEmptyNode(lastP)) {\n                emptyP = lastP;\n                lastP = lastP.prev('p');\n                emptyP.remove();\n            }\n            while (firstP.is('p') && this.util.isEmptyNode(firstP)) {\n                emptyP = firstP;\n                firstP = lastP.next('p');\n                emptyP.remove();\n            }\n            cloneBody.find('img.uploading').remove();\n            val = langx.trim(cloneBody.html());\n            this.textarea.val(val);\n            return val;\n        };\n        Simditor.prototype.focus = function () {\n            var $blockEl, range;\n            if (!(this.body.is(':visible') && this.body.is('[contenteditable]'))) {\n                this.el.find('textarea:visible').focus();\n                return;\n            }\n            if (this.inputManager.lastCaretPosition) {\n                this.undoManager.caretPosition(this.inputManager.lastCaretPosition);\n                return this.inputManager.lastCaretPosition = null;\n            } else {\n                $blockEl = this.body.children().last();\n                if (!$blockEl.is('p')) {\n                    $blockEl = $('<p/>').append(this.util.phBr).appendTo(this.body);\n                }\n                range = document.createRange();\n                return this.selection.setRangeAtEndOf($blockEl, range);\n            }\n        };\n        Simditor.prototype.blur = function () {\n            if (this.body.is(':visible') && this.body.is('[contenteditable]')) {\n                return this.body.blur();\n            } else {\n                return this.body.find('textarea:visible').blur();\n            }\n        };\n        Simditor.prototype.hidePopover = function () {\n            return this.el.find('.simditor-popover').each(function (i, popover) {\n                popover = $(popover).data('popover');\n                if (popover.active) {\n                    return popover.hide();\n                }\n            });\n        };\n        Simditor.prototype.destroy = function () {\n            this.triggerHandler('destroy');\n            this.textarea.closest('form').off('.simditor .simditor-' + this.id);\n            this.selection.clear();\n            this.inputManager.focused = false;\n            this.textarea.insertBefore(this.el).hide().val('').removeData('simditor');\n            this.el.remove();\n            $(document).off('.simditor-' + this.id);\n            $(window).off('.simditor-' + this.id);\n            return this.off();\n        };\n        Simditor.Toolbar = Toolbar;\n        Simditor.i18n = i18n;\n        return Simditor;\n    });\n    function __isEmptyObject(obj) {\n        var attr;\n        for (attr in obj)\n            return !1;\n        return !0;\n    }\n    function __isValidToReturn(obj) {\n        return typeof obj != 'object' || Array.isArray(obj) || !__isEmptyObject(obj);\n    }\n    if (__isValidToReturn(module.exports))\n        return module.exports;\n    else if (__isValidToReturn(exports))\n        return exports;\n});"]}