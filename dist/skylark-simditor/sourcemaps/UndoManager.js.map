{"version":3,"sources":["UndoManager.js"],"names":["define","$","extend","Module","UndoManager","inherit","pluginName","prototype","_index","_capacity","_startPosition","_endPosition","_init","redoShortcut","undoShortcut","_this","this","editor","_module","_stack","util","os","mac","win","hotkeys","add","e","preventDefault","undo","redo","throttledPushState","throttle","_pushUndoState","on","src","resetCaretPosition","update","length","startPosition","selection","_range","_getPosition","endPosition","range","collapsed","triggerHandler","caretPosition","start","push","html","body","caret","shift","currentState","state","hidePopover","get","innerHTML","find","removeClass","sync","trigger","_getNodeOffset","node","index","$parent","merging","offset","isNumeric","parent","contents","each","i","child","nodeType","Node","TEXT_NODE","nodeValue","type","$nodes","nodes","position","prevNode","first","previousSibling","getNodeLength","unshift","_getNodeByPosition","childNodes","k","len","ref","slice","is","document","createTextNode","appendChild","endContainer","endOffset","startContainer","startOffset","end","createRange","setStart","setEnd","console","warn","inputManager","focused"],"mappings":"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","file":"../UndoManager.js","sourcesContent":["define([\r\n  \"skylark-jquery\",\r\n  \"./_extend\",\r\n  \"./Module\"\r\n],function($,extend,Module){ \r\n  var UndoManager = Module.inherit({\r\n\r\n  });\r\n\r\n  UndoManager.pluginName = 'UndoManager';\r\n\r\n  UndoManager.prototype._index = -1;\r\n\r\n  UndoManager.prototype._capacity = 20;\r\n\r\n  UndoManager.prototype._startPosition = null;\r\n\r\n  UndoManager.prototype._endPosition = null;\r\n\r\n  UndoManager.prototype._init = function() {\r\n    var redoShortcut, undoShortcut;\r\n    this.editor = this._module;\r\n    this._stack = [];\r\n    if (this.editor.util.os.mac) {\r\n      undoShortcut = 'cmd+z';\r\n      redoShortcut = 'shift+cmd+z';\r\n    } else if (this.editor.util.os.win) {\r\n      undoShortcut = 'ctrl+z';\r\n      redoShortcut = 'ctrl+y';\r\n    } else {\r\n      undoShortcut = 'ctrl+z';\r\n      redoShortcut = 'shift+ctrl+z';\r\n    }\r\n    this.editor.hotkeys.add(undoShortcut, (function(_this) {\r\n      return function(e) {\r\n        e.preventDefault();\r\n        _this.undo();\r\n        return false;\r\n      };\r\n    })(this));\r\n    this.editor.hotkeys.add(redoShortcut, (function(_this) {\r\n      return function(e) {\r\n        e.preventDefault();\r\n        _this.redo();\r\n        return false;\r\n      };\r\n    })(this));\r\n    this.throttledPushState = this.editor.util.throttle((function(_this) {\r\n      return function() {\r\n        return _this._pushUndoState();\r\n      };\r\n    })(this), 2000);\r\n    this.editor.on('valuechanged', (function(_this) {\r\n      return function(e, src) {\r\n        if (src === 'undo' || src === 'redo') {\r\n          return;\r\n        }\r\n        return _this.throttledPushState();\r\n      };\r\n    })(this));\r\n    this.editor.on('selectionchanged', (function(_this) {\r\n      return function(e) {\r\n        _this.resetCaretPosition();\r\n        return _this.update();\r\n      };\r\n    })(this));\r\n    this.editor.on('focus', (function(_this) {\r\n      return function(e) {\r\n        if (_this._stack.length === 0) {\r\n          return _this._pushUndoState();\r\n        }\r\n      };\r\n    })(this));\r\n    return this.editor.on('blur', (function(_this) {\r\n      return function(e) {\r\n        return _this.resetCaretPosition();\r\n      };\r\n    })(this));\r\n  };\r\n\r\n  UndoManager.prototype.resetCaretPosition = function() {\r\n    this._startPosition = null;\r\n    return this._endPosition = null;\r\n  };\r\n\r\n  UndoManager.prototype.startPosition = function() {\r\n    if (this.editor.selection._range) {\r\n      this._startPosition || (this._startPosition = this._getPosition('start'));\r\n    }\r\n    return this._startPosition;\r\n  };\r\n\r\n  UndoManager.prototype.endPosition = function() {\r\n    if (this.editor.selection._range) {\r\n      this._endPosition || (this._endPosition = (function(_this) {\r\n        return function() {\r\n          var range;\r\n          range = _this.editor.selection.range();\r\n          if (range.collapsed) {\r\n            return _this._startPosition;\r\n          }\r\n          return _this._getPosition('end');\r\n        };\r\n      })(this)());\r\n    }\r\n    return this._endPosition;\r\n  };\r\n\r\n  UndoManager.prototype._pushUndoState = function() {\r\n    var caret;\r\n    if (this.editor.triggerHandler('pushundostate') === false) {\r\n      return;\r\n    }\r\n    caret = this.caretPosition();\r\n    if (!caret.start) {\r\n      return;\r\n    }\r\n    this._index += 1;\r\n    this._stack.length = this._index;\r\n    this._stack.push({\r\n      html: this.editor.body.html(),\r\n      caret: this.caretPosition()\r\n    });\r\n    if (this._stack.length > this._capacity) {\r\n      this._stack.shift();\r\n      return this._index -= 1;\r\n    }\r\n  };\r\n\r\n  UndoManager.prototype.currentState = function() {\r\n    if (this._stack.length && this._index > -1) {\r\n      return this._stack[this._index];\r\n    } else {\r\n      return null;\r\n    }\r\n  };\r\n\r\n  UndoManager.prototype.undo = function() {\r\n    var state;\r\n    if (this._index < 1 || this._stack.length < 2) {\r\n      return;\r\n    }\r\n    this.editor.hidePopover();\r\n    this._index -= 1;\r\n    state = this._stack[this._index];\r\n    this.editor.body.get(0).innerHTML = state.html;\r\n    this.caretPosition(state.caret);\r\n    this.editor.body.find('.selected').removeClass('selected');\r\n    this.editor.sync();\r\n    return this.editor.trigger('valuechanged', ['undo']);\r\n  };\r\n\r\n  UndoManager.prototype.redo = function() {\r\n    var state;\r\n    if (this._index < 0 || this._stack.length < this._index + 2) {\r\n      return;\r\n    }\r\n    this.editor.hidePopover();\r\n    this._index += 1;\r\n    state = this._stack[this._index];\r\n    this.editor.body.get(0).innerHTML = state.html;\r\n    this.caretPosition(state.caret);\r\n    this.editor.body.find('.selected').removeClass('selected');\r\n    this.editor.sync();\r\n    return this.editor.trigger('valuechanged', ['redo']);\r\n  };\r\n\r\n  UndoManager.prototype.update = function() {\r\n    var currentState;\r\n    currentState = this.currentState();\r\n    if (!currentState) {\r\n      return;\r\n    }\r\n    currentState.html = this.editor.body.html();\r\n    return currentState.caret = this.caretPosition();\r\n  };\r\n\r\n  UndoManager.prototype._getNodeOffset = function(node, index) {\r\n    var $parent, merging, offset;\r\n    if ($.isNumeric(index)) {\r\n      $parent = $(node);\r\n    } else {\r\n      $parent = $(node).parent();\r\n    }\r\n    offset = 0;\r\n    merging = false;\r\n    $parent.contents().each(function(i, child) {\r\n      if (node === child || (index === i && i === 0)) {\r\n        return false;\r\n      }\r\n      if (child.nodeType === Node.TEXT_NODE) {\r\n        if (!merging && child.nodeValue.length > 0) {\r\n          offset += 1;\r\n          merging = true;\r\n        }\r\n      } else {\r\n        offset += 1;\r\n        merging = false;\r\n      }\r\n      if (index - 1 === i) {\r\n        return false;\r\n      }\r\n      return null;\r\n    });\r\n    return offset;\r\n  };\r\n\r\n  UndoManager.prototype._getPosition = function(type) {\r\n    var $nodes, node, nodes, offset, position, prevNode, range;\r\n    if (type == null) {\r\n      type = 'start';\r\n    }\r\n    range = this.editor.selection.range();\r\n    offset = range[type + \"Offset\"];\r\n    $nodes = this.editor.selection[type + \"Nodes\"]();\r\n    node = $nodes.first()[0];\r\n    if (node.nodeType === Node.TEXT_NODE) {\r\n      prevNode = node.previousSibling;\r\n      while (prevNode && prevNode.nodeType === Node.TEXT_NODE) {\r\n        node = prevNode;\r\n        offset += this.editor.util.getNodeLength(prevNode);\r\n        prevNode = prevNode.previousSibling;\r\n      }\r\n      nodes = $nodes.get();\r\n      nodes[0] = node;\r\n      $nodes = $(nodes);\r\n    } else {\r\n      offset = this._getNodeOffset(node, offset);\r\n    }\r\n    position = [offset];\r\n    $nodes.each((function(_this) {\r\n      return function(i, node) {\r\n        return position.unshift(_this._getNodeOffset(node));\r\n      };\r\n    })(this));\r\n    return position;\r\n  };\r\n\r\n  UndoManager.prototype._getNodeByPosition = function(position) {\r\n    var child, childNodes, i, k, len, node, offset, ref;\r\n    node = this.editor.body[0];\r\n    ref = position.slice(0, position.length - 1);\r\n    for (i = k = 0, len = ref.length; k < len; i = ++k) {\r\n      offset = ref[i];\r\n      childNodes = node.childNodes;\r\n      if (offset > childNodes.length - 1) {\r\n        if (i === position.length - 2 && $(node).is(':empty')) {\r\n          child = document.createTextNode('');\r\n          node.appendChild(child);\r\n          childNodes = node.childNodes;\r\n        } else {\r\n          node = null;\r\n          break;\r\n        }\r\n      }\r\n      node = childNodes[offset];\r\n    }\r\n    return node;\r\n  };\r\n\r\n  UndoManager.prototype.caretPosition = function(caret) {\r\n    var endContainer, endOffset, range, startContainer, startOffset;\r\n    if (!caret) {\r\n      range = this.editor.selection.range();\r\n      caret = this.editor.inputManager.focused && (range != null) ? {\r\n        start: this.startPosition(),\r\n        end: this.endPosition(),\r\n        collapsed: range.collapsed\r\n      } : {};\r\n      return caret;\r\n    } else {\r\n      if (!caret.start) {\r\n        return;\r\n      }\r\n      startContainer = this._getNodeByPosition(caret.start);\r\n      startOffset = caret.start[caret.start.length - 1];\r\n      if (caret.collapsed) {\r\n        endContainer = startContainer;\r\n        endOffset = startOffset;\r\n      } else {\r\n        endContainer = this._getNodeByPosition(caret.end);\r\n        endOffset = caret.start[caret.start.length - 1];\r\n      }\r\n      if (!startContainer || !endContainer) {\r\n        if (typeof console !== \"undefined\" && console !== null) {\r\n          if (typeof console.warn === \"function\") {\r\n            console.warn('simditor: invalid caret state');\r\n          }\r\n        }\r\n        return;\r\n      }\r\n      range = document.createRange();\r\n      range.setStart(startContainer, startOffset);\r\n      range.setEnd(endContainer, endOffset);\r\n      return this.editor.selection.range(range);\r\n    }\r\n  };\r\n\r\n  return UndoManager;\r\n\r\n});"]}