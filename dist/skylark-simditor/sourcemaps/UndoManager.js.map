{"version":3,"sources":["UndoManager.js"],"names":["define","langx","$","UndoManager","Evented","inherit","init","editor","redoShortcut","undoShortcut","_this","this","_stack","util","os","mac","win","hotkeys","add","e","preventDefault","undo","redo","throttledPushState","throttle","_pushUndoState","on","src","resetCaretPosition","update","length","pluginName","prototype","_index","_capacity","_startPosition","_endPosition","startPosition","selection","_range","_getPosition","endPosition","range","collapsed","triggerHandler","caretPosition","start","push","html","body","caret","shift","currentState","state","hidePopover","get","innerHTML","find","removeClass","sync","trigger","_getNodeOffset","node","index","$parent","merging","offset","isNumeric","parent","contents","each","i","child","nodeType","Node","TEXT_NODE","nodeValue","type","$nodes","nodes","position","prevNode","first","previousSibling","getNodeLength","unshift","_getNodeByPosition","childNodes","k","len","ref","slice","is","document","createTextNode","appendChild","endContainer","endOffset","startContainer","startOffset","end","createRange","setStart","setEnd","console","warn","inputManager","focused"],"mappings":";;;;;;;AAAAA,QACE,sBACA,kBACA,SAASC,EAAMC,GAEf,IAAIC,EAAcF,EAAMG,QAAQC,SAC9BC,KAAO,SAASC,GAEd,IAAIC,EAAcC,EAY8BC,EAbhDC,KAAKJ,OAASA,EAEdI,KAAKC,UACDD,KAAKJ,OAAOM,KAAKC,GAAGC,KACtBN,EAAe,QACfD,EAAe,eACNG,KAAKJ,OAAOM,KAAKC,GAAGE,KAC7BP,EAAe,SACfD,EAAe,WAEfC,EAAe,SACfD,EAAe,gBAEjBG,KAAKJ,OAAOU,QAAQC,IAAIT,GAAwBC,EAM7CC,KALM,SAASQ,GAGd,OAFAA,EAAEC,iBACFV,EAAMW,QACC,KAGXV,KAAKJ,OAAOU,QAAQC,IAAIV,EAAc,SAAUE,GAC9C,OAAO,SAASS,GAGd,OAFAA,EAAEC,iBACFV,EAAMY,QACC,GAJ2B,CAMnCX,OACHA,KAAKY,mBAAqBZ,KAAKJ,OAAOM,KAAKW,SAAS,SAAUd,GAC5D,OAAO,WACL,OAAOA,EAAMe,kBAFmC,CAIjDd,MAAO,KACVA,KAAKJ,OAAOmB,GAAG,eAAgB,SAAUhB,GACvC,OAAO,SAASS,EAAGQ,GACjB,GAAY,SAARA,GAA0B,SAARA,EAGtB,OAAOjB,EAAMa,sBALc,CAO5BZ,OACHA,KAAKJ,OAAOmB,GAAG,mBAAoB,SAAUhB,GAC3C,OAAO,SAASS,GAEd,OADAT,EAAMkB,qBACClB,EAAMmB,UAHkB,CAKhClB,OACHA,KAAKJ,OAAOmB,GAAG,QAAS,SAAUhB,GAChC,OAAO,SAASS,GACd,GAA4B,IAAxBT,EAAME,OAAOkB,OACf,OAAOpB,EAAMe,kBAHK,CAMrBd,OACHA,KAAKJ,OAAOmB,GAAG,OAAQ,SAAUhB,GAC/B,OAAO,SAASS,GACd,OAAOT,EAAMkB,sBAFM,CAIpBjB,UAyOP,OApOAR,EAAY4B,WAAa,cAEzB5B,EAAY6B,UAAUC,QAAU,EAEhC9B,EAAY6B,UAAUE,UAAY,GAElC/B,EAAY6B,UAAUG,eAAiB,KAEvChC,EAAY6B,UAAUI,aAAe,KAErCjC,EAAY6B,UAAUJ,mBAAqB,WAEzC,OADAjB,KAAKwB,eAAiB,KACfxB,KAAKyB,aAAe,MAG7BjC,EAAY6B,UAAUK,cAAgB,WAIpC,OAHI1B,KAAKJ,OAAO+B,UAAUC,SACxB5B,KAAKwB,iBAAmBxB,KAAKwB,eAAiBxB,KAAK6B,aAAa,WAE3D7B,KAAKwB,gBAGdhC,EAAY6B,UAAUS,YAAc,WAEU,IAAU/B,EAWtD,OAZIC,KAAKJ,OAAO+B,UAAUC,SACxB5B,KAAKyB,eAAiBzB,KAAKyB,cAAyB1B,EASjDC,KARM,WAGL,OADQD,EAAMH,OAAO+B,UAAUI,QACrBC,UACDjC,EAAMyB,eAERzB,EAAM8B,aAAa,aAIzB7B,KAAKyB,cAGdjC,EAAY6B,UAAUP,eAAiB,WAErC,IAAoD,IAAhDd,KAAKJ,OAAOqC,eAAe,kBAGvBjC,KAAKkC,gBACFC,MASX,OANAnC,KAAKsB,QAAU,EACftB,KAAKC,OAAOkB,OAASnB,KAAKsB,OAC1BtB,KAAKC,OAAOmC,MACVC,KAAMrC,KAAKJ,OAAO0C,KAAKD,OACvBE,MAAOvC,KAAKkC,kBAEVlC,KAAKC,OAAOkB,OAASnB,KAAKuB,WAC5BvB,KAAKC,OAAOuC,QACLxC,KAAKsB,QAAU,QAFxB,GAMF9B,EAAY6B,UAAUoB,aAAe,WACnC,OAAIzC,KAAKC,OAAOkB,QAAUnB,KAAKsB,QAAU,EAChCtB,KAAKC,OAAOD,KAAKsB,QAEjB,MAIX9B,EAAY6B,UAAUX,KAAO,WAC3B,IAAIgC,EACJ,KAAI1C,KAAKsB,OAAS,GAAKtB,KAAKC,OAAOkB,OAAS,GAU5C,OAPAnB,KAAKJ,OAAO+C,cACZ3C,KAAKsB,QAAU,EACfoB,EAAQ1C,KAAKC,OAAOD,KAAKsB,QACzBtB,KAAKJ,OAAO0C,KAAKM,IAAI,GAAGC,UAAYH,EAAML,KAC1CrC,KAAKkC,cAAcQ,EAAMH,OACzBvC,KAAKJ,OAAO0C,KAAKQ,KAAK,aAAaC,YAAY,YAC/C/C,KAAKJ,OAAOoD,OACLhD,KAAKJ,OAAOqD,QAAQ,gBAAiB,UAG9CzD,EAAY6B,UAAUV,KAAO,WAC3B,IAAI+B,EACJ,KAAI1C,KAAKsB,OAAS,GAAKtB,KAAKC,OAAOkB,OAASnB,KAAKsB,OAAS,GAU1D,OAPAtB,KAAKJ,OAAO+C,cACZ3C,KAAKsB,QAAU,EACfoB,EAAQ1C,KAAKC,OAAOD,KAAKsB,QACzBtB,KAAKJ,OAAO0C,KAAKM,IAAI,GAAGC,UAAYH,EAAML,KAC1CrC,KAAKkC,cAAcQ,EAAMH,OACzBvC,KAAKJ,OAAO0C,KAAKQ,KAAK,aAAaC,YAAY,YAC/C/C,KAAKJ,OAAOoD,OACLhD,KAAKJ,OAAOqD,QAAQ,gBAAiB,UAG9CzD,EAAY6B,UAAUH,OAAS,WAC7B,IAAIuB,EAEJ,GADAA,EAAezC,KAAKyC,eAKpB,OADAA,EAAaJ,KAAOrC,KAAKJ,OAAO0C,KAAKD,OAC9BI,EAAaF,MAAQvC,KAAKkC,iBAGnC1C,EAAY6B,UAAU6B,eAAiB,SAASC,EAAMC,GACpD,IAAIC,EAASC,EAASC,EA0BtB,OAxBEF,EADE9D,EAAEiE,UAAUJ,GACJ7D,EAAE4D,GAEF5D,EAAE4D,GAAMM,SAEpBF,EAAS,EACTD,GAAU,EACVD,EAAQK,WAAWC,KAAK,SAASC,EAAGC,GAClC,OAAIV,IAASU,IAAUT,IAAUQ,GAAW,IAANA,KAGlCC,EAAMC,WAAaC,KAAKC,WACrBV,GAAWO,EAAMI,UAAU9C,OAAS,IACvCoC,GAAU,EACVD,GAAU,IAGZC,GAAU,EACVD,GAAU,GAERF,EAAQ,IAAMQ,GAGX,QAEFL,GAGT/D,EAAY6B,UAAUQ,aAAe,SAASqC,GAC5C,IAAIC,EAAQhB,EAAMiB,EAAOb,EAAQc,EAAUC,EAsBrBvE,EAdtB,GAPY,MAARmE,IACFA,EAAO,SAGTX,EADQvD,KAAKJ,OAAO+B,UAAUI,QACfmC,EAAO,WAEtBf,GADAgB,EAASnE,KAAKJ,OAAO+B,UAAUuC,EAAO,YACxBK,QAAQ,IACbT,WAAaC,KAAKC,UAAW,CAEpC,IADAM,EAAWnB,EAAKqB,gBACTF,GAAYA,EAASR,WAAaC,KAAKC,WAC5Cb,EAAOmB,EACPf,GAAUvD,KAAKJ,OAAOM,KAAKuE,cAAcH,GACzCA,EAAWA,EAASE,iBAEtBJ,EAAQD,EAAOvB,OACT,GAAKO,EACXgB,EAAS5E,EAAE6E,QAEXb,EAASvD,KAAKkD,eAAeC,EAAMI,GAQrC,OANAc,GAAYd,GACZY,EAAOR,MAAe5D,EAInBC,KAHM,SAAS4D,EAAGT,GACjB,OAAOkB,EAASK,QAAQ3E,EAAMmD,eAAeC,OAG1CkB,GAGT7E,EAAY6B,UAAUsD,mBAAqB,SAASN,GAClD,IAAIR,EAAOe,EAAYhB,EAAGiB,EAAGC,EAAK3B,EAAMI,EAAQwB,EAGhD,IAFA5B,EAAOnD,KAAKJ,OAAO0C,KAAK,GAEnBsB,EAAIiB,EAAI,EAAGC,GADhBC,EAAMV,EAASW,MAAM,EAAGX,EAASlD,OAAS,IAChBA,OAAQ0D,EAAIC,EAAKlB,IAAMiB,EAAG,CAGlD,IAFAtB,EAASwB,EAAInB,KACbgB,EAAazB,EAAKyB,YACMzD,OAAS,EAAG,CAClC,GAAIyC,IAAMS,EAASlD,OAAS,IAAK5B,EAAE4D,GAAM8B,GAAG,UAIrC,CACL9B,EAAO,KACP,MALAU,EAAQqB,SAASC,eAAe,IAChChC,EAAKiC,YAAYvB,GACjBe,EAAazB,EAAKyB,WAMtBzB,EAAOyB,EAAWrB,GAEpB,OAAOJ,GAGT3D,EAAY6B,UAAUa,cAAgB,SAASK,GAC7C,IAAI8C,EAAcC,EAAWvD,EAAOwD,EAAgBC,EACpD,GAAKjD,EAQE,CACL,IAAKA,EAAMJ,MACT,OAWF,OATAoD,EAAiBvF,KAAK2E,mBAAmBpC,EAAMJ,OAC/CqD,EAAcjD,EAAMJ,MAAMI,EAAMJ,MAAMhB,OAAS,GAC3CoB,EAAMP,WACRqD,EAAeE,EACfD,EAAYE,IAEZH,EAAerF,KAAK2E,mBAAmBpC,EAAMkD,KAC7CH,EAAY/C,EAAMJ,MAAMI,EAAMJ,MAAMhB,OAAS,IAE1CoE,GAAmBF,IAQxBtD,EAAQmD,SAASQ,eACXC,SAASJ,EAAgBC,GAC/BzD,EAAM6D,OAAOP,EAAcC,GACpBtF,KAAKJ,OAAO+B,UAAUI,MAAMA,SAVV,oBAAZ8D,SAAuC,OAAZA,SACR,mBAAjBA,QAAQC,MACjBD,QAAQC,KAAK,kCAjBnB,OANA/D,EAAQ/B,KAAKJ,OAAO+B,UAAUI,QAC9BQ,EAAQvC,KAAKJ,OAAOmG,aAAaC,SAAqB,MAATjE,GAC3CI,MAAOnC,KAAK0B,gBACZ+D,IAAKzF,KAAK8B,cACVE,UAAWD,EAAMC,eA+BhBxC","file":"../UndoManager.js","sourcesContent":["define([\r\n  \"skylark-langx/langx\",\r\n  \"skylark-jquery\"\r\n],function(langx,$){ \r\n\r\n  var UndoManager = langx.Evented.inherit({\r\n    init : function(editor) {\r\n      this.editor = editor;\r\n      var redoShortcut, undoShortcut;\r\n      this._stack = [];\r\n      if (this.editor.util.os.mac) {\r\n        undoShortcut = 'cmd+z';\r\n        redoShortcut = 'shift+cmd+z';\r\n      } else if (this.editor.util.os.win) {\r\n        undoShortcut = 'ctrl+z';\r\n        redoShortcut = 'ctrl+y';\r\n      } else {\r\n        undoShortcut = 'ctrl+z';\r\n        redoShortcut = 'shift+ctrl+z';\r\n      }\r\n      this.editor.hotkeys.add(undoShortcut, (function(_this) {\r\n        return function(e) {\r\n          e.preventDefault();\r\n          _this.undo();\r\n          return false;\r\n        };\r\n      })(this));\r\n      this.editor.hotkeys.add(redoShortcut, (function(_this) {\r\n        return function(e) {\r\n          e.preventDefault();\r\n          _this.redo();\r\n          return false;\r\n        };\r\n      })(this));\r\n      this.throttledPushState = this.editor.util.throttle((function(_this) {\r\n        return function() {\r\n          return _this._pushUndoState();\r\n        };\r\n      })(this), 2000);\r\n      this.editor.on('valuechanged', (function(_this) {\r\n        return function(e, src) {\r\n          if (src === 'undo' || src === 'redo') {\r\n            return;\r\n          }\r\n          return _this.throttledPushState();\r\n        };\r\n      })(this));\r\n      this.editor.on('selectionchanged', (function(_this) {\r\n        return function(e) {\r\n          _this.resetCaretPosition();\r\n          return _this.update();\r\n        };\r\n      })(this));\r\n      this.editor.on('focus', (function(_this) {\r\n        return function(e) {\r\n          if (_this._stack.length === 0) {\r\n            return _this._pushUndoState();\r\n          }\r\n        };\r\n      })(this));\r\n      this.editor.on('blur', (function(_this) {\r\n        return function(e) {\r\n          return _this.resetCaretPosition();\r\n        };\r\n      })(this));\r\n    }\r\n\r\n  });\r\n\r\n  UndoManager.pluginName = 'UndoManager';\r\n\r\n  UndoManager.prototype._index = -1;\r\n\r\n  UndoManager.prototype._capacity = 20;\r\n\r\n  UndoManager.prototype._startPosition = null;\r\n\r\n  UndoManager.prototype._endPosition = null;\r\n\r\n  UndoManager.prototype.resetCaretPosition = function() {\r\n    this._startPosition = null;\r\n    return this._endPosition = null;\r\n  };\r\n\r\n  UndoManager.prototype.startPosition = function() {\r\n    if (this.editor.selection._range) {\r\n      this._startPosition || (this._startPosition = this._getPosition('start'));\r\n    }\r\n    return this._startPosition;\r\n  };\r\n\r\n  UndoManager.prototype.endPosition = function() {\r\n    if (this.editor.selection._range) {\r\n      this._endPosition || (this._endPosition = (function(_this) {\r\n        return function() {\r\n          var range;\r\n          range = _this.editor.selection.range();\r\n          if (range.collapsed) {\r\n            return _this._startPosition;\r\n          }\r\n          return _this._getPosition('end');\r\n        };\r\n      })(this)());\r\n    }\r\n    return this._endPosition;\r\n  };\r\n\r\n  UndoManager.prototype._pushUndoState = function() {\r\n    var caret;\r\n    if (this.editor.triggerHandler('pushundostate') === false) {\r\n      return;\r\n    }\r\n    caret = this.caretPosition();\r\n    if (!caret.start) {\r\n      return;\r\n    }\r\n    this._index += 1;\r\n    this._stack.length = this._index;\r\n    this._stack.push({\r\n      html: this.editor.body.html(),\r\n      caret: this.caretPosition()\r\n    });\r\n    if (this._stack.length > this._capacity) {\r\n      this._stack.shift();\r\n      return this._index -= 1;\r\n    }\r\n  };\r\n\r\n  UndoManager.prototype.currentState = function() {\r\n    if (this._stack.length && this._index > -1) {\r\n      return this._stack[this._index];\r\n    } else {\r\n      return null;\r\n    }\r\n  };\r\n\r\n  UndoManager.prototype.undo = function() {\r\n    var state;\r\n    if (this._index < 1 || this._stack.length < 2) {\r\n      return;\r\n    }\r\n    this.editor.hidePopover();\r\n    this._index -= 1;\r\n    state = this._stack[this._index];\r\n    this.editor.body.get(0).innerHTML = state.html;\r\n    this.caretPosition(state.caret);\r\n    this.editor.body.find('.selected').removeClass('selected');\r\n    this.editor.sync();\r\n    return this.editor.trigger('valuechanged', ['undo']);\r\n  };\r\n\r\n  UndoManager.prototype.redo = function() {\r\n    var state;\r\n    if (this._index < 0 || this._stack.length < this._index + 2) {\r\n      return;\r\n    }\r\n    this.editor.hidePopover();\r\n    this._index += 1;\r\n    state = this._stack[this._index];\r\n    this.editor.body.get(0).innerHTML = state.html;\r\n    this.caretPosition(state.caret);\r\n    this.editor.body.find('.selected').removeClass('selected');\r\n    this.editor.sync();\r\n    return this.editor.trigger('valuechanged', ['redo']);\r\n  };\r\n\r\n  UndoManager.prototype.update = function() {\r\n    var currentState;\r\n    currentState = this.currentState();\r\n    if (!currentState) {\r\n      return;\r\n    }\r\n    currentState.html = this.editor.body.html();\r\n    return currentState.caret = this.caretPosition();\r\n  };\r\n\r\n  UndoManager.prototype._getNodeOffset = function(node, index) {\r\n    var $parent, merging, offset;\r\n    if ($.isNumeric(index)) {\r\n      $parent = $(node);\r\n    } else {\r\n      $parent = $(node).parent();\r\n    }\r\n    offset = 0;\r\n    merging = false;\r\n    $parent.contents().each(function(i, child) {\r\n      if (node === child || (index === i && i === 0)) {\r\n        return false;\r\n      }\r\n      if (child.nodeType === Node.TEXT_NODE) {\r\n        if (!merging && child.nodeValue.length > 0) {\r\n          offset += 1;\r\n          merging = true;\r\n        }\r\n      } else {\r\n        offset += 1;\r\n        merging = false;\r\n      }\r\n      if (index - 1 === i) {\r\n        return false;\r\n      }\r\n      return null;\r\n    });\r\n    return offset;\r\n  };\r\n\r\n  UndoManager.prototype._getPosition = function(type) {\r\n    var $nodes, node, nodes, offset, position, prevNode, range;\r\n    if (type == null) {\r\n      type = 'start';\r\n    }\r\n    range = this.editor.selection.range();\r\n    offset = range[type + \"Offset\"];\r\n    $nodes = this.editor.selection[type + \"Nodes\"]();\r\n    node = $nodes.first()[0];\r\n    if (node.nodeType === Node.TEXT_NODE) {\r\n      prevNode = node.previousSibling;\r\n      while (prevNode && prevNode.nodeType === Node.TEXT_NODE) {\r\n        node = prevNode;\r\n        offset += this.editor.util.getNodeLength(prevNode);\r\n        prevNode = prevNode.previousSibling;\r\n      }\r\n      nodes = $nodes.get();\r\n      nodes[0] = node;\r\n      $nodes = $(nodes);\r\n    } else {\r\n      offset = this._getNodeOffset(node, offset);\r\n    }\r\n    position = [offset];\r\n    $nodes.each((function(_this) {\r\n      return function(i, node) {\r\n        return position.unshift(_this._getNodeOffset(node));\r\n      };\r\n    })(this));\r\n    return position;\r\n  };\r\n\r\n  UndoManager.prototype._getNodeByPosition = function(position) {\r\n    var child, childNodes, i, k, len, node, offset, ref;\r\n    node = this.editor.body[0];\r\n    ref = position.slice(0, position.length - 1);\r\n    for (i = k = 0, len = ref.length; k < len; i = ++k) {\r\n      offset = ref[i];\r\n      childNodes = node.childNodes;\r\n      if (offset > childNodes.length - 1) {\r\n        if (i === position.length - 2 && $(node).is(':empty')) {\r\n          child = document.createTextNode('');\r\n          node.appendChild(child);\r\n          childNodes = node.childNodes;\r\n        } else {\r\n          node = null;\r\n          break;\r\n        }\r\n      }\r\n      node = childNodes[offset];\r\n    }\r\n    return node;\r\n  };\r\n\r\n  UndoManager.prototype.caretPosition = function(caret) {\r\n    var endContainer, endOffset, range, startContainer, startOffset;\r\n    if (!caret) {\r\n      range = this.editor.selection.range();\r\n      caret = this.editor.inputManager.focused && (range != null) ? {\r\n        start: this.startPosition(),\r\n        end: this.endPosition(),\r\n        collapsed: range.collapsed\r\n      } : {};\r\n      return caret;\r\n    } else {\r\n      if (!caret.start) {\r\n        return;\r\n      }\r\n      startContainer = this._getNodeByPosition(caret.start);\r\n      startOffset = caret.start[caret.start.length - 1];\r\n      if (caret.collapsed) {\r\n        endContainer = startContainer;\r\n        endOffset = startOffset;\r\n      } else {\r\n        endContainer = this._getNodeByPosition(caret.end);\r\n        endOffset = caret.start[caret.start.length - 1];\r\n      }\r\n      if (!startContainer || !endContainer) {\r\n        if (typeof console !== \"undefined\" && console !== null) {\r\n          if (typeof console.warn === \"function\") {\r\n            console.warn('simditor: invalid caret state');\r\n          }\r\n        }\r\n        return;\r\n      }\r\n      range = document.createRange();\r\n      range.setStart(startContainer, startOffset);\r\n      range.setEnd(endContainer, endOffset);\r\n      return this.editor.selection.range(range);\r\n    }\r\n  };\r\n\r\n  return UndoManager;\r\n\r\n});"]}