{"version":3,"sources":["InputManager.js"],"names":["define","$","extend","Module","indexOf","InputManager","inherit","pluginName","prototype","_modifierKeys","_arrowKeys","_init","selectAllKey","submitKey","_this","this","editor","_module","throttledValueChanged","util","throttle","params","setTimeout","trigger","throttledSelectionChanged","document","on","id","e","triggerEvent","focused","clipboard","pasting","_selectionTimer","clearTimeout","selection","_selection","rangeCount","$rootBlocks","lastCaretPosition","body","children","filter","i","node","isBlockNode","length","save","formatter","format","restore","find","each","el","$el","formatted","parent","is","next","append","phBr","insertAfter","prev","insertBefore","support","onselectionchange","proxy","_onKeyDown","_onKeyPress","_onKeyUp","_onMouseUp","_onFocus","_onBlur","_onDrop","_onInput","browser","firefox","hotkeys","add","preventDefault","modify","os","mac","$children","firstBlock","lastBlock","range","first","get","last","createRange","setStart","setEnd","getNodeLength","closest","click","addClass","removeClass","$blockEl","getRangeAt","startContainer","undoManager","caretPosition","setRangeAtStartOf","triggerHandler","ref","sync","currentState","caret","ref1","respondTo","keystroke","which","call","metaKey","oninput","p","isEmptyNode","empty","appendTo"],"mappings":"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","file":"../InputManager.js","sourcesContent":["define([\r\n  \"skylark-jquery\",\r\n  \"./_extend\",\r\n  \"./Module\"\r\n],function($,extend,Module){ \r\n  var indexOf = [].indexOf ;\r\n\r\n  var InputManager = Module.inherit({\r\n\r\n  });\r\n\r\n  InputManager.pluginName = 'InputManager';\r\n\r\n  InputManager.prototype._modifierKeys = [16, 17, 18, 91, 93, 224];\r\n\r\n  InputManager.prototype._arrowKeys = [37, 38, 39, 40];\r\n\r\n  InputManager.prototype._init = function() {\r\n    var selectAllKey, submitKey;\r\n    this.editor = this._module;\r\n    this.throttledValueChanged = this.editor.util.throttle((function(_this) {\r\n      return function(params) {\r\n        return setTimeout(function() {\r\n          return _this.editor.trigger('valuechanged', params);\r\n        }, 10);\r\n      };\r\n    })(this), 300);\r\n    this.throttledSelectionChanged = this.editor.util.throttle((function(_this) {\r\n      return function() {\r\n        return _this.editor.trigger('selectionchanged');\r\n      };\r\n    })(this), 50);\r\n    $(document).on('selectionchange.simditor' + this.editor.id, (function(_this) {\r\n      return function(e) {\r\n        var triggerEvent;\r\n        if (!(_this.focused && !_this.editor.clipboard.pasting)) {\r\n          return;\r\n        }\r\n        triggerEvent = function() {\r\n          if (_this._selectionTimer) {\r\n            clearTimeout(_this._selectionTimer);\r\n            _this._selectionTimer = null;\r\n          }\r\n          if (_this.editor.selection._selection.rangeCount > 0) {\r\n            return _this.throttledSelectionChanged();\r\n          } else {\r\n            return _this._selectionTimer = setTimeout(function() {\r\n              _this._selectionTimer = null;\r\n              if (_this.focused) {\r\n                return triggerEvent();\r\n              }\r\n            }, 10);\r\n          }\r\n        };\r\n        return triggerEvent();\r\n      };\r\n    })(this));\r\n    this.editor.on('valuechanged', (function(_this) {\r\n      return function() {\r\n        var $rootBlocks;\r\n        _this.lastCaretPosition = null;\r\n        $rootBlocks = _this.editor.body.children().filter(function(i, node) {\r\n          return _this.editor.util.isBlockNode(node);\r\n        });\r\n        if (_this.focused && $rootBlocks.length === 0) {\r\n          _this.editor.selection.save();\r\n          _this.editor.formatter.format();\r\n          _this.editor.selection.restore();\r\n        }\r\n        _this.editor.body.find('hr, pre, .simditor-table').each(function(i, el) {\r\n          var $el, formatted;\r\n          $el = $(el);\r\n          if ($el.parent().is('blockquote') || $el.parent()[0] === _this.editor.body[0]) {\r\n            formatted = false;\r\n            if ($el.next().length === 0) {\r\n              $('<p/>').append(_this.editor.util.phBr).insertAfter($el);\r\n              formatted = true;\r\n            }\r\n            if ($el.prev().length === 0) {\r\n              $('<p/>').append(_this.editor.util.phBr).insertBefore($el);\r\n              formatted = true;\r\n            }\r\n            if (formatted) {\r\n              return _this.throttledValueChanged();\r\n            }\r\n          }\r\n        });\r\n        _this.editor.body.find('pre:empty').append(_this.editor.util.phBr);\r\n        if (!_this.editor.util.support.onselectionchange && _this.focused) {\r\n          return _this.throttledSelectionChanged();\r\n        }\r\n      };\r\n    })(this));\r\n    this.editor.body.on('keydown', $.proxy(this._onKeyDown, this)).on('keypress', $.proxy(this._onKeyPress, this)).on('keyup', $.proxy(this._onKeyUp, this)).on('mouseup', $.proxy(this._onMouseUp, this)).on('focus', $.proxy(this._onFocus, this)).on('blur', $.proxy(this._onBlur, this)).on('drop', $.proxy(this._onDrop, this)).on('input', $.proxy(this._onInput, this));\r\n    if (this.editor.util.browser.firefox) {\r\n      this.editor.hotkeys.add('cmd+left', (function(_this) {\r\n        return function(e) {\r\n          e.preventDefault();\r\n          _this.editor.selection._selection.modify('move', 'backward', 'lineboundary');\r\n          return false;\r\n        };\r\n      })(this));\r\n      this.editor.hotkeys.add('cmd+right', (function(_this) {\r\n        return function(e) {\r\n          e.preventDefault();\r\n          _this.editor.selection._selection.modify('move', 'forward', 'lineboundary');\r\n          return false;\r\n        };\r\n      })(this));\r\n      selectAllKey = this.editor.util.os.mac ? 'cmd+a' : 'ctrl+a';\r\n      this.editor.hotkeys.add(selectAllKey, (function(_this) {\r\n        return function(e) {\r\n          var $children, firstBlock, lastBlock, range;\r\n          $children = _this.editor.body.children();\r\n          if (!($children.length > 0)) {\r\n            return;\r\n          }\r\n          firstBlock = $children.first().get(0);\r\n          lastBlock = $children.last().get(0);\r\n          range = document.createRange();\r\n          range.setStart(firstBlock, 0);\r\n          range.setEnd(lastBlock, _this.editor.util.getNodeLength(lastBlock));\r\n          _this.editor.selection.range(range);\r\n          return false;\r\n        };\r\n      })(this));\r\n    }\r\n    submitKey = this.editor.util.os.mac ? 'cmd+enter' : 'ctrl+enter';\r\n    return this.editor.hotkeys.add(submitKey, (function(_this) {\r\n      return function(e) {\r\n        _this.editor.el.closest('form').find('button:submit').click();\r\n        return false;\r\n      };\r\n    })(this));\r\n  };\r\n\r\n  InputManager.prototype._onFocus = function(e) {\r\n    if (this.editor.clipboard.pasting) {\r\n      return;\r\n    }\r\n    this.editor.el.addClass('focus').removeClass('error');\r\n    this.focused = true;\r\n    return setTimeout((function(_this) {\r\n      return function() {\r\n        var $blockEl, range;\r\n        range = _this.editor.selection._selection.getRangeAt(0);\r\n        if (range.startContainer === _this.editor.body[0]) {\r\n          if (_this.lastCaretPosition) {\r\n            _this.editor.undoManager.caretPosition(_this.lastCaretPosition);\r\n          } else {\r\n            $blockEl = _this.editor.body.children().first();\r\n            range = document.createRange();\r\n            _this.editor.selection.setRangeAtStartOf($blockEl, range);\r\n          }\r\n        }\r\n        _this.lastCaretPosition = null;\r\n        _this.editor.triggerHandler('focus');\r\n        if (!_this.editor.util.support.onselectionchange) {\r\n          return _this.throttledSelectionChanged();\r\n        }\r\n      };\r\n    })(this), 0);\r\n  };\r\n\r\n  InputManager.prototype._onBlur = function(e) {\r\n    var ref;\r\n    if (this.editor.clipboard.pasting) {\r\n      return;\r\n    }\r\n    this.editor.el.removeClass('focus');\r\n    this.editor.sync();\r\n    this.focused = false;\r\n    this.lastCaretPosition = (ref = this.editor.undoManager.currentState()) != null ? ref.caret : void 0;\r\n    return this.editor.triggerHandler('blur');\r\n  };\r\n\r\n  InputManager.prototype._onMouseUp = function(e) {\r\n    if (!this.editor.util.support.onselectionchange) {\r\n      return this.throttledSelectionChanged();\r\n    }\r\n  };\r\n\r\n  InputManager.prototype._onKeyDown = function(e) {\r\n    var ref, ref1;\r\n    if (this.editor.triggerHandler(e) === false) {\r\n      return false;\r\n    }\r\n    if (this.editor.hotkeys.respondTo(e)) {\r\n      return;\r\n    }\r\n    if (this.editor.keystroke.respondTo(e)) {\r\n      this.throttledValueChanged();\r\n      return false;\r\n    }\r\n    if ((ref = e.which, indexOf.call(this._modifierKeys, ref) >= 0) || (ref1 = e.which, indexOf.call(this._arrowKeys, ref1) >= 0)) {\r\n      return;\r\n    }\r\n    if (this.editor.util.metaKey(e) && e.which === 86) {\r\n      return;\r\n    }\r\n    if (!this.editor.util.support.oninput) {\r\n      this.throttledValueChanged(['typing']);\r\n    }\r\n    return null;\r\n  };\r\n\r\n  InputManager.prototype._onKeyPress = function(e) {\r\n    if (this.editor.triggerHandler(e) === false) {\r\n      return false;\r\n    }\r\n  };\r\n\r\n  InputManager.prototype._onKeyUp = function(e) {\r\n    var p, ref;\r\n    if (this.editor.triggerHandler(e) === false) {\r\n      return false;\r\n    }\r\n    if (!this.editor.util.support.onselectionchange && (ref = e.which, indexOf.call(this._arrowKeys, ref) >= 0)) {\r\n      this.throttledValueChanged();\r\n      return;\r\n    }\r\n    if ((e.which === 8 || e.which === 46) && this.editor.util.isEmptyNode(this.editor.body)) {\r\n      this.editor.body.empty();\r\n      p = $('<p/>').append(this.editor.util.phBr).appendTo(this.editor.body);\r\n      this.editor.selection.setRangeAtStartOf(p);\r\n    }\r\n  };\r\n\r\n  InputManager.prototype._onDrop = function(e) {\r\n    if (this.editor.triggerHandler(e) === false) {\r\n      return false;\r\n    }\r\n    return this.throttledValueChanged();\r\n  };\r\n\r\n  InputManager.prototype._onInput = function(e) {\r\n    return this.throttledValueChanged(['oninput']);\r\n  };\r\n\r\n  return InputManager;\r\n\r\n});\r\n"]}