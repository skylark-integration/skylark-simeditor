{"version":3,"sources":["InputManager.js"],"names":["define","langx","$","indexOf","InputManager","Evented","inherit","init","editor","selectAllKey","submitKey","_this","this","throttledValueChanged","util","throttle","params","setTimeout","trigger","throttledSelectionChanged","document","on","id","e","triggerEvent","focused","clipboard","pasting","_selectionTimer","clearTimeout","selection","_selection","rangeCount","$rootBlocks","lastCaretPosition","body","children","filter","i","node","isBlockNode","length","save","formatter","format","restore","find","each","el","$el","formatted","parent","is","next","append","phBr","insertAfter","prev","insertBefore","support","onselectionchange","proxy","_onKeyDown","_onKeyPress","_onKeyUp","_onMouseUp","_onFocus","_onBlur","_onDrop","_onInput","browser","firefox","hotkeys","add","preventDefault","modify","os","mac","$children","firstBlock","lastBlock","range","first","get","last","createRange","setStart","setEnd","getNodeLength","closest","click","pluginName","prototype","_modifierKeys","_arrowKeys","addClass","removeClass","$blockEl","getRangeAt","startContainer","undoManager","caretPosition","setRangeAtStartOf","console","log","triggerHandler","ref","sync","currentState","caret","ref1","respondTo","keystroke","which","call","metaKey","oninput","p","isEmptyNode","empty","appendTo"],"mappings":";;;;;;;AAAAA,QACE,sBACA,kBACA,SAASC,EAAMC,GAEf,IAAIC,KAAaA,QAEbC,EAAeH,EAAMI,QAAQC,SAC/BC,KAAO,SAASC,GAEd,IAAIC,EAAcC,EAC+CC,EAFjEC,KAAKJ,OAASA,EAEdI,KAAKC,sBAAwBD,KAAKJ,OAAOM,KAAKC,UAAmBJ,EAM9DC,KALM,SAASI,GACd,OAAOC,WAAW,WAChB,OAAON,EAAMH,OAAOU,QAAQ,eAAgBF,IAC3C,MAEG,KACVJ,KAAKO,0BAA4BP,KAAKJ,OAAOM,KAAKC,SAAS,SAAUJ,GACnE,OAAO,WACL,OAAOA,EAAMH,OAAOU,QAAQ,qBAF2B,CAIxDN,MAAO,IACVV,EAAEkB,UAAUC,GAAG,2BAA6BT,KAAKJ,OAAOc,GAAI,SAAUX,GACpE,OAAO,SAASY,GACd,IAAIC,EACJ,GAAMb,EAAMc,UAAYd,EAAMH,OAAOkB,UAAUC,QAmB/C,OAhBAH,EAAe,WAKb,OAJIb,EAAMiB,kBACRC,aAAalB,EAAMiB,iBACnBjB,EAAMiB,gBAAkB,MAEtBjB,EAAMH,OAAOsB,UAAUC,WAAWC,WAAa,EAC1CrB,EAAMQ,4BAENR,EAAMiB,gBAAkBX,WAAW,WAExC,GADAN,EAAMiB,gBAAkB,KACpBjB,EAAMc,QACR,OAAOD,KAER,SAnBiD,CAwBzDZ,OACHA,KAAKJ,OAAOa,GAAG,eAAgB,SAAUV,GACvC,OAAO,WACL,IAAIsB,EA6BJ,GA5BAtB,EAAMuB,kBAAoB,KAC1BD,EAActB,EAAMH,OAAO2B,KAAKC,WAAWC,OAAO,SAASC,EAAGC,GAC5D,OAAO5B,EAAMH,OAAOM,KAAK0B,YAAYD,KAEnC5B,EAAMc,SAAkC,IAAvBQ,EAAYQ,SAC/B9B,EAAMH,OAAOsB,UAAUY,OACvB/B,EAAMH,OAAOmC,UAAUC,SACvBjC,EAAMH,OAAOsB,UAAUe,WAEzBlC,EAAMH,OAAO2B,KAAKW,KAAK,4BAA4BC,KAAK,SAAST,EAAGU,GAClE,IAAIC,EAAKC,EAET,KADAD,EAAM/C,EAAE8C,IACAG,SAASC,GAAG,eAAiBH,EAAIE,SAAS,KAAOxC,EAAMH,OAAO2B,KAAK,MACzEe,GAAY,EACc,IAAtBD,EAAII,OAAOZ,SACbvC,EAAE,QAAQoD,OAAO3C,EAAMH,OAAOM,KAAKyC,MAAMC,YAAYP,GACrDC,GAAY,GAEY,IAAtBD,EAAIQ,OAAOhB,SACbvC,EAAE,QAAQoD,OAAO3C,EAAMH,OAAOM,KAAKyC,MAAMG,aAAaT,GACtDC,GAAY,GAEVA,GACF,OAAOvC,EAAME,0BAInBF,EAAMH,OAAO2B,KAAKW,KAAK,aAAaQ,OAAO3C,EAAMH,OAAOM,KAAKyC,OACxD5C,EAAMH,OAAOM,KAAK6C,QAAQC,mBAAqBjD,EAAMc,QACxD,OAAOd,EAAMQ,6BAhCY,CAmC5BP,OACHA,KAAKJ,OAAO2B,KAAKd,GAAG,UAAWpB,EAAM4D,MAAMjD,KAAKkD,WAAYlD,OAAOS,GAAG,WAAYpB,EAAM4D,MAAMjD,KAAKmD,YAAanD,OAAOS,GAAG,QAASpB,EAAM4D,MAAMjD,KAAKoD,SAAUpD,OAAOS,GAAG,UAAWpB,EAAM4D,MAAMjD,KAAKqD,WAAYrD,OAAOS,GAAG,QAASpB,EAAM4D,MAAMjD,KAAKsD,SAAUtD,OAAOS,GAAG,OAAQpB,EAAM4D,MAAMjD,KAAKuD,QAASvD,OAAOS,GAAG,OAAQpB,EAAM4D,MAAMjD,KAAKwD,QAASxD,OAAOS,GAAG,QAASpB,EAAM4D,MAAMjD,KAAKyD,SAAUzD,OAChYA,KAAKJ,OAAOM,KAAKwD,QAAQC,UAC3B3D,KAAKJ,OAAOgE,QAAQC,IAAI,WAAY,SAAU9D,GAC5C,OAAO,SAASY,GAGd,OAFAA,EAAEmD,iBACF/D,EAAMH,OAAOsB,UAAUC,WAAW4C,OAAO,OAAQ,WAAY,iBACtD,GAJyB,CAMjC/D,OACHA,KAAKJ,OAAOgE,QAAQC,IAAI,YAAa,SAAU9D,GAC7C,OAAO,SAASY,GAGd,OAFAA,EAAEmD,iBACF/D,EAAMH,OAAOsB,UAAUC,WAAW4C,OAAO,OAAQ,UAAW,iBACrD,GAJ0B,CAMlC/D,OACHH,EAAeG,KAAKJ,OAAOM,KAAK8D,GAAGC,IAAM,QAAU,SACnDjE,KAAKJ,OAAOgE,QAAQC,IAAIhE,EAAc,SAAUE,GAC9C,OAAO,SAASY,GACd,IAAIuD,EAAWC,EAAYC,EAAWC,EAEtC,IADAH,EAAYnE,EAAMH,OAAO2B,KAAKC,YACdK,OAAS,EASzB,OANAsC,EAAaD,EAAUI,QAAQC,IAAI,GACnCH,EAAYF,EAAUM,OAAOD,IAAI,IACjCF,EAAQ7D,SAASiE,eACXC,SAASP,EAAY,GAC3BE,EAAMM,OAAOP,EAAWrE,EAAMH,OAAOM,KAAK0E,cAAcR,IACxDrE,EAAMH,OAAOsB,UAAUmD,MAAMA,IACtB,GAb2B,CAenCrE,QAELF,EAAYE,KAAKJ,OAAOM,KAAK8D,GAAGC,IAAM,YAAc,aACpDjE,KAAKJ,OAAOgE,QAAQC,IAAI/D,EAAW,SAAUC,GAC3C,OAAO,SAASY,GAEd,OADAZ,EAAMH,OAAOwC,GAAGyC,QAAQ,QAAQ3C,KAAK,iBAAiB4C,SAC/C,GAHwB,CAKhC9E,UAoHP,OA/GAR,EAAauF,WAAa,eAE1BvF,EAAawF,UAAUC,eAAiB,GAAI,GAAI,GAAI,GAAI,GAAI,KAE5DzF,EAAawF,UAAUE,YAAc,GAAI,GAAI,GAAI,IAGjD1F,EAAawF,UAAU1B,SAAW,SAAS3C,GAMvB,IAAUZ,EAL5B,IAAIC,KAAKJ,OAAOkB,UAAUC,QAK1B,OAFAf,KAAKJ,OAAOwC,GAAG+C,SAAS,SAASC,YAAY,SAC7CpF,KAAKa,SAAU,EACRR,YAAqBN,EAoBzBC,KAnBM,WACL,IAAIqF,EAAUhB,EAcd,IAbAA,EAAQtE,EAAMH,OAAOsB,UAAUC,WAAWmE,WAAW,IAC3CC,iBAAmBxF,EAAMH,OAAO2B,KAAK,KACzCxB,EAAMuB,kBACRvB,EAAMH,OAAO4F,YAAYC,cAAc1F,EAAMuB,oBAE7C+D,EAAWtF,EAAMH,OAAO2B,KAAKC,WAAW8C,QACxCD,EAAQ7D,SAASiE,cACjB1E,EAAMH,OAAOsB,UAAUwE,kBAAkBL,EAAUhB,GACnDsB,QAAQC,IAAI,YAGhB7F,EAAMuB,kBAAoB,KAC1BvB,EAAMH,OAAOiG,eAAe,UACvB9F,EAAMH,OAAOM,KAAK6C,QAAQC,kBAC7B,OAAOjD,EAAMQ,8BAGT,IAGZf,EAAawF,UAAUzB,QAAU,SAAS5C,GACxC,IAAImF,EACJ,IAAI9F,KAAKJ,OAAOkB,UAAUC,QAO1B,OAJAf,KAAKJ,OAAOwC,GAAGgD,YAAY,SAC3BpF,KAAKJ,OAAOmG,OACZ/F,KAAKa,SAAU,EACfb,KAAKsB,kBAAsE,OAAjDwE,EAAM9F,KAAKJ,OAAO4F,YAAYQ,gBAA0BF,EAAIG,WAAQ,EACvFjG,KAAKJ,OAAOiG,eAAe,SAGpCrG,EAAawF,UAAU3B,WAAa,SAAS1C,GAC3C,IAAKX,KAAKJ,OAAOM,KAAK6C,QAAQC,kBAC5B,OAAOhD,KAAKO,6BAIhBf,EAAawF,UAAU9B,WAAa,SAASvC,GAC3C,IAAImF,EAAKI,EACT,IAAsC,IAAlClG,KAAKJ,OAAOiG,eAAelF,GAC7B,OAAO,EAET,IAAIX,KAAKJ,OAAOgE,QAAQuC,UAAUxF,GAAlC,CAGA,GAAIX,KAAKJ,OAAOwG,UAAUD,UAAUxF,GAElC,OADAX,KAAKC,yBACE,EAET,KAAK6F,EAAMnF,EAAE0F,MAAO9G,EAAQ+G,KAAKtG,KAAKiF,cAAea,IAAQ,IAAOI,EAAOvF,EAAE0F,MAAO9G,EAAQ+G,KAAKtG,KAAKkF,WAAYgB,IAAS,IAGvHlG,KAAKJ,OAAOM,KAAKqG,QAAQ5F,IAAkB,KAAZA,EAAE0F,OAMrC,OAHKrG,KAAKJ,OAAOM,KAAK6C,QAAQyD,SAC5BxG,KAAKC,uBAAuB,WAEvB,OAGTT,EAAawF,UAAU7B,YAAc,SAASxC,GAC5C,IAAsC,IAAlCX,KAAKJ,OAAOiG,eAAelF,GAC7B,OAAO,GAIXnB,EAAawF,UAAU5B,SAAW,SAASzC,GACzC,IAAI8F,EAAGX,EACP,IAAsC,IAAlC9F,KAAKJ,OAAOiG,eAAelF,GAC7B,OAAO,GAEJX,KAAKJ,OAAOM,KAAK6C,QAAQC,oBAAsB8C,EAAMnF,EAAE0F,MAAO9G,EAAQ+G,KAAKtG,KAAKkF,WAAYY,IAAQ,GACvG9F,KAAKC,wBAGU,IAAZU,EAAE0F,OAA2B,KAAZ1F,EAAE0F,QAAiBrG,KAAKJ,OAAOM,KAAKwG,YAAY1G,KAAKJ,OAAO2B,QAChFvB,KAAKJ,OAAO2B,KAAKoF,QACjBF,EAAInH,EAAE,QAAQoD,OAAO1C,KAAKJ,OAAOM,KAAKyC,MAAMiE,SAAS5G,KAAKJ,OAAO2B,MACjEvB,KAAKJ,OAAOsB,UAAUwE,kBAAkBe,KAI5CjH,EAAawF,UAAUxB,QAAU,SAAS7C,GACxC,OAAsC,IAAlCX,KAAKJ,OAAOiG,eAAelF,IAGxBX,KAAKC,yBAGdT,EAAawF,UAAUvB,SAAW,SAAS9C,GACzC,OAAOX,KAAKC,uBAAuB,aAG9BT","file":"../InputManager.js","sourcesContent":["define([\r\n  \"skylark-langx/langx\",\r\n  \"skylark-jquery\"\r\n],function(langx,$){ \r\n\r\n  var indexOf = [].indexOf ;\r\n\r\n  var InputManager = langx.Evented.inherit({\r\n    init : function(editor) {\r\n      this.editor = editor;\r\n      var selectAllKey, submitKey;\r\n      this.throttledValueChanged = this.editor.util.throttle((function(_this) {\r\n        return function(params) {\r\n          return setTimeout(function() {\r\n            return _this.editor.trigger('valuechanged', params);\r\n          }, 10);\r\n        };\r\n      })(this), 300);\r\n      this.throttledSelectionChanged = this.editor.util.throttle((function(_this) {\r\n        return function() {\r\n          return _this.editor.trigger('selectionchanged');\r\n        };\r\n      })(this), 50);\r\n      $(document).on('selectionchange.simditor' + this.editor.id, (function(_this) {\r\n        return function(e) {\r\n          var triggerEvent;\r\n          if (!(_this.focused && !_this.editor.clipboard.pasting)) {\r\n            return;\r\n          }\r\n          triggerEvent = function() {\r\n            if (_this._selectionTimer) {\r\n              clearTimeout(_this._selectionTimer);\r\n              _this._selectionTimer = null;\r\n            }\r\n            if (_this.editor.selection._selection.rangeCount > 0) {\r\n              return _this.throttledSelectionChanged();\r\n            } else {\r\n              return _this._selectionTimer = setTimeout(function() {\r\n                _this._selectionTimer = null;\r\n                if (_this.focused) {\r\n                  return triggerEvent();\r\n                }\r\n              }, 10);\r\n            }\r\n          };\r\n          return triggerEvent();\r\n        };\r\n      })(this));\r\n      this.editor.on('valuechanged', (function(_this) {\r\n        return function() {\r\n          var $rootBlocks;\r\n          _this.lastCaretPosition = null;\r\n          $rootBlocks = _this.editor.body.children().filter(function(i, node) {\r\n            return _this.editor.util.isBlockNode(node);\r\n          });\r\n          if (_this.focused && $rootBlocks.length === 0) {\r\n            _this.editor.selection.save();\r\n            _this.editor.formatter.format();\r\n            _this.editor.selection.restore();\r\n          }\r\n          _this.editor.body.find('hr, pre, .simditor-table').each(function(i, el) {\r\n            var $el, formatted;\r\n            $el = $(el);\r\n            if ($el.parent().is('blockquote') || $el.parent()[0] === _this.editor.body[0]) {\r\n              formatted = false;\r\n              if ($el.next().length === 0) {\r\n                $('<p/>').append(_this.editor.util.phBr).insertAfter($el);\r\n                formatted = true;\r\n              }\r\n              if ($el.prev().length === 0) {\r\n                $('<p/>').append(_this.editor.util.phBr).insertBefore($el);\r\n                formatted = true;\r\n              }\r\n              if (formatted) {\r\n                return _this.throttledValueChanged();\r\n              }\r\n            }\r\n          });\r\n          _this.editor.body.find('pre:empty').append(_this.editor.util.phBr);\r\n          if (!_this.editor.util.support.onselectionchange && _this.focused) {\r\n            return _this.throttledSelectionChanged();\r\n          }\r\n        };\r\n      })(this));\r\n      this.editor.body.on('keydown', langx.proxy(this._onKeyDown, this)).on('keypress', langx.proxy(this._onKeyPress, this)).on('keyup', langx.proxy(this._onKeyUp, this)).on('mouseup', langx.proxy(this._onMouseUp, this)).on('focus', langx.proxy(this._onFocus, this)).on('blur', langx.proxy(this._onBlur, this)).on('drop', langx.proxy(this._onDrop, this)).on('input', langx.proxy(this._onInput, this));\r\n      if (this.editor.util.browser.firefox) {\r\n        this.editor.hotkeys.add('cmd+left', (function(_this) {\r\n          return function(e) {\r\n            e.preventDefault();\r\n            _this.editor.selection._selection.modify('move', 'backward', 'lineboundary');\r\n            return false;\r\n          };\r\n        })(this));\r\n        this.editor.hotkeys.add('cmd+right', (function(_this) {\r\n          return function(e) {\r\n            e.preventDefault();\r\n            _this.editor.selection._selection.modify('move', 'forward', 'lineboundary');\r\n            return false;\r\n          };\r\n        })(this));\r\n        selectAllKey = this.editor.util.os.mac ? 'cmd+a' : 'ctrl+a';\r\n        this.editor.hotkeys.add(selectAllKey, (function(_this) {\r\n          return function(e) {\r\n            var $children, firstBlock, lastBlock, range;\r\n            $children = _this.editor.body.children();\r\n            if (!($children.length > 0)) {\r\n              return;\r\n            }\r\n            firstBlock = $children.first().get(0);\r\n            lastBlock = $children.last().get(0);\r\n            range = document.createRange();\r\n            range.setStart(firstBlock, 0);\r\n            range.setEnd(lastBlock, _this.editor.util.getNodeLength(lastBlock));\r\n            _this.editor.selection.range(range);\r\n            return false;\r\n          };\r\n        })(this));\r\n      }\r\n      submitKey = this.editor.util.os.mac ? 'cmd+enter' : 'ctrl+enter';\r\n      this.editor.hotkeys.add(submitKey, (function(_this) {\r\n        return function(e) {\r\n          _this.editor.el.closest('form').find('button:submit').click();\r\n          return false;\r\n        };\r\n      })(this));\r\n    }\r\n\r\n  });\r\n\r\n  InputManager.pluginName = 'InputManager';\r\n\r\n  InputManager.prototype._modifierKeys = [16, 17, 18, 91, 93, 224];\r\n\r\n  InputManager.prototype._arrowKeys = [37, 38, 39, 40];\r\n\r\n\r\n  InputManager.prototype._onFocus = function(e) {\r\n    if (this.editor.clipboard.pasting) {\r\n      return;\r\n    }\r\n    this.editor.el.addClass('focus').removeClass('error');\r\n    this.focused = true;\r\n    return setTimeout((function(_this) {\r\n      return function() {\r\n        var $blockEl, range;\r\n        range = _this.editor.selection._selection.getRangeAt(0);\r\n        if (range.startContainer === _this.editor.body[0]) {\r\n          if (_this.lastCaretPosition) {\r\n            _this.editor.undoManager.caretPosition(_this.lastCaretPosition);\r\n          } else {\r\n            $blockEl = _this.editor.body.children().first();\r\n            range = document.createRange();\r\n            _this.editor.selection.setRangeAtStartOf($blockEl, range);\r\n            console.log(\"aaaaaa\");\r\n          }\r\n        }\r\n        _this.lastCaretPosition = null;\r\n        _this.editor.triggerHandler('focus');\r\n        if (!_this.editor.util.support.onselectionchange) {\r\n          return _this.throttledSelectionChanged();\r\n        }\r\n      };\r\n    })(this), 0);\r\n  };\r\n\r\n  InputManager.prototype._onBlur = function(e) {\r\n    var ref;\r\n    if (this.editor.clipboard.pasting) {\r\n      return;\r\n    }\r\n    this.editor.el.removeClass('focus');\r\n    this.editor.sync();\r\n    this.focused = false;\r\n    this.lastCaretPosition = (ref = this.editor.undoManager.currentState()) != null ? ref.caret : void 0;\r\n    return this.editor.triggerHandler('blur');\r\n  };\r\n\r\n  InputManager.prototype._onMouseUp = function(e) {\r\n    if (!this.editor.util.support.onselectionchange) {\r\n      return this.throttledSelectionChanged();\r\n    }\r\n  };\r\n\r\n  InputManager.prototype._onKeyDown = function(e) {\r\n    var ref, ref1;\r\n    if (this.editor.triggerHandler(e) === false) {\r\n      return false;\r\n    }\r\n    if (this.editor.hotkeys.respondTo(e)) {\r\n      return;\r\n    }\r\n    if (this.editor.keystroke.respondTo(e)) {\r\n      this.throttledValueChanged();\r\n      return false;\r\n    }\r\n    if ((ref = e.which, indexOf.call(this._modifierKeys, ref) >= 0) || (ref1 = e.which, indexOf.call(this._arrowKeys, ref1) >= 0)) {\r\n      return;\r\n    }\r\n    if (this.editor.util.metaKey(e) && e.which === 86) {\r\n      return;\r\n    }\r\n    if (!this.editor.util.support.oninput) {\r\n      this.throttledValueChanged(['typing']);\r\n    }\r\n    return null;\r\n  };\r\n\r\n  InputManager.prototype._onKeyPress = function(e) {\r\n    if (this.editor.triggerHandler(e) === false) {\r\n      return false;\r\n    }\r\n  };\r\n\r\n  InputManager.prototype._onKeyUp = function(e) {\r\n    var p, ref;\r\n    if (this.editor.triggerHandler(e) === false) {\r\n      return false;\r\n    }\r\n    if (!this.editor.util.support.onselectionchange && (ref = e.which, indexOf.call(this._arrowKeys, ref) >= 0)) {\r\n      this.throttledValueChanged();\r\n      return;\r\n    }\r\n    if ((e.which === 8 || e.which === 46) && this.editor.util.isEmptyNode(this.editor.body)) {\r\n      this.editor.body.empty();\r\n      p = $('<p/>').append(this.editor.util.phBr).appendTo(this.editor.body);\r\n      this.editor.selection.setRangeAtStartOf(p);\r\n    }\r\n  };\r\n\r\n  InputManager.prototype._onDrop = function(e) {\r\n    if (this.editor.triggerHandler(e) === false) {\r\n      return false;\r\n    }\r\n    return this.throttledValueChanged();\r\n  };\r\n\r\n  InputManager.prototype._onInput = function(e) {\r\n    return this.throttledValueChanged(['oninput']);\r\n  };\r\n\r\n  return InputManager;\r\n\r\n});\r\n"]}