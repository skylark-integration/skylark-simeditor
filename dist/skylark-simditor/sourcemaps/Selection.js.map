{"version":3,"sources":["Selection.js"],"names":["define","$","extend","Module","Selection","inherit","pluginName","prototype","_range","_startNodes","_endNodes","_containerNode","_nodes","_blockNodes","_rootNodes","_init","_this","this","editor","_module","_selection","document","getSelection","on","e","reset","getRangeAt","clear","removeAllRanges","_error","range","ffOrIE","addRange","util","browser","firefox","msie","inputManager","focused","body","focus","rangeCount","startNodes","startContainer","parentsUntil","get","unshift","endNodes","collapsed","endContainer","containerNode","commonAncestorContainer","nodes","first","is","each","i","node","$endNode","$node","$nodes","endIndex","index","sharedIndex","startIndex","push","parent","eq","last","contents","merge","slice","unique","blockNodes","filter","isBlockNode","rootNodes","$parent","rangeAtEndOf","afterLastNode","beforeLastNode","endNode","endNodeLength","lastNodeIsBr","result","getNodeLength","endOffset","contains","addBack","n","$lastChild","beforeLastbr","isLastNode","nodeType","nodeValue","prev","rangeAtStartOf","startNode","startOffset","insertNode","setRangeAfter","setEndAfter","collapse","setRangeBefore","setEndBefore","setRangeAtStartOf","setEnd","setRangeAtEndOf","$lastNode","lastChild","lastChildLength","lastText","nodeLength","length","text","charAt","isEmptyNode","append","phBr","deleteRangeContents","atEndOfBody","atStartOfBody","endRange","startRange","cloneRange","empty","setStart","deleteContents","breakBlockEl","el","$el","setStartBefore","before","extractContents","save","endCaret","startCaret","_selectionSaved","addClass","restore","find","createRange","remove"],"mappings":"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","file":"../Selection.js","sourcesContent":["define([\r\n  \"skylark-jquery\",\r\n  \"./_extend\",\r\n  \"./Module\"\r\n],function($,extend,Module){ \r\n\r\n  var Selection = Module.inherit({\r\n\r\n  });\r\n\r\n  Selection.pluginName = 'Selection';\r\n\r\n  Selection.prototype._range = null;\r\n\r\n  Selection.prototype._startNodes = null;\r\n\r\n  Selection.prototype._endNodes = null;\r\n\r\n  Selection.prototype._containerNode = null;\r\n\r\n  Selection.prototype._nodes = null;\r\n\r\n  Selection.prototype._blockNodes = null;\r\n\r\n  Selection.prototype._rootNodes = null;\r\n\r\n  Selection.prototype._init = function() {\r\n    this.editor = this._module;\r\n    this._selection = document.getSelection();\r\n    this.editor.on('selectionchanged', (function(_this) {\r\n      return function(e) {\r\n        _this.reset();\r\n        return _this._range = _this._selection.getRangeAt(0);\r\n      };\r\n    })(this));\r\n    this.editor.on('blur', (function(_this) {\r\n      return function(e) {\r\n        return _this.reset();\r\n      };\r\n    })(this));\r\n    return this.editor.on('focus', (function(_this) {\r\n      return function(e) {\r\n        _this.reset();\r\n        return _this._range = _this._selection.getRangeAt(0);\r\n      };\r\n    })(this));\r\n  };\r\n\r\n  Selection.prototype.reset = function() {\r\n    this._range = null;\r\n    this._startNodes = null;\r\n    this._endNodes = null;\r\n    this._containerNode = null;\r\n    this._nodes = null;\r\n    this._blockNodes = null;\r\n    return this._rootNodes = null;\r\n  };\r\n\r\n  Selection.prototype.clear = function() {\r\n    var e;\r\n    try {\r\n      this._selection.removeAllRanges();\r\n    } catch (_error) {\r\n      e = _error;\r\n    }\r\n    return this.reset();\r\n  };\r\n\r\n  Selection.prototype.range = function(range) {\r\n    var ffOrIE;\r\n    if (range) {\r\n      this.clear();\r\n      this._selection.addRange(range);\r\n      this._range = range;\r\n      ffOrIE = this.editor.util.browser.firefox || this.editor.util.browser.msie;\r\n      if (!this.editor.inputManager.focused && ffOrIE) {\r\n        this.editor.body.focus();\r\n      }\r\n    } else if (!this._range && this.editor.inputManager.focused && this._selection.rangeCount) {\r\n      this._range = this._selection.getRangeAt(0);\r\n    }\r\n    return this._range;\r\n  };\r\n\r\n  Selection.prototype.startNodes = function() {\r\n    if (this._range) {\r\n      this._startNodes || (this._startNodes = (function(_this) {\r\n        return function() {\r\n          var startNodes;\r\n          startNodes = $(_this._range.startContainer).parentsUntil(_this.editor.body).get();\r\n          startNodes.unshift(_this._range.startContainer);\r\n          return $(startNodes);\r\n        };\r\n      })(this)());\r\n    }\r\n    return this._startNodes;\r\n  };\r\n\r\n  Selection.prototype.endNodes = function() {\r\n    var endNodes;\r\n    if (this._range) {\r\n      this._endNodes || (this._endNodes = this._range.collapsed ? this.startNodes() : (endNodes = $(this._range.endContainer).parentsUntil(this.editor.body).get(), endNodes.unshift(this._range.endContainer), $(endNodes)));\r\n    }\r\n    return this._endNodes;\r\n  };\r\n\r\n  Selection.prototype.containerNode = function() {\r\n    if (this._range) {\r\n      this._containerNode || (this._containerNode = $(this._range.commonAncestorContainer));\r\n    }\r\n    return this._containerNode;\r\n  };\r\n\r\n  Selection.prototype.nodes = function() {\r\n    if (this._range) {\r\n      this._nodes || (this._nodes = (function(_this) {\r\n        return function() {\r\n          var nodes;\r\n          nodes = [];\r\n          if (_this.startNodes().first().is(_this.endNodes().first())) {\r\n            nodes = _this.startNodes().get();\r\n          } else {\r\n            _this.startNodes().each(function(i, node) {\r\n              var $endNode, $node, $nodes, endIndex, index, sharedIndex, startIndex;\r\n              $node = $(node);\r\n              if (_this.endNodes().index($node) > -1) {\r\n                return nodes.push(node);\r\n              } else if ($node.parent().is(_this.editor.body) || (sharedIndex = _this.endNodes().index($node.parent())) > -1) {\r\n                if (sharedIndex && sharedIndex > -1) {\r\n                  $endNode = _this.endNodes().eq(sharedIndex - 1);\r\n                } else {\r\n                  $endNode = _this.endNodes().last();\r\n                }\r\n                $nodes = $node.parent().contents();\r\n                startIndex = $nodes.index($node);\r\n                endIndex = $nodes.index($endNode);\r\n                return $.merge(nodes, $nodes.slice(startIndex, endIndex).get());\r\n              } else {\r\n                $nodes = $node.parent().contents();\r\n                index = $nodes.index($node);\r\n                return $.merge(nodes, $nodes.slice(index).get());\r\n              }\r\n            });\r\n            _this.endNodes().each(function(i, node) {\r\n              var $node, $nodes, index;\r\n              $node = $(node);\r\n              if ($node.parent().is(_this.editor.body) || _this.startNodes().index($node.parent()) > -1) {\r\n                nodes.push(node);\r\n                return false;\r\n              } else {\r\n                $nodes = $node.parent().contents();\r\n                index = $nodes.index($node);\r\n                return $.merge(nodes, $nodes.slice(0, index + 1));\r\n              }\r\n            });\r\n          }\r\n          return $($.unique(nodes));\r\n        };\r\n      })(this)());\r\n    }\r\n    return this._nodes;\r\n  };\r\n\r\n  Selection.prototype.blockNodes = function() {\r\n    if (!this._range) {\r\n      return;\r\n    }\r\n    this._blockNodes || (this._blockNodes = (function(_this) {\r\n      return function() {\r\n        return _this.nodes().filter(function(i, node) {\r\n          return _this.editor.util.isBlockNode(node);\r\n        });\r\n      };\r\n    })(this)());\r\n    return this._blockNodes;\r\n  };\r\n\r\n  Selection.prototype.rootNodes = function() {\r\n    if (!this._range) {\r\n      return;\r\n    }\r\n    this._rootNodes || (this._rootNodes = (function(_this) {\r\n      return function() {\r\n        return _this.nodes().filter(function(i, node) {\r\n          var $parent;\r\n          $parent = $(node).parent();\r\n          return $parent.is(_this.editor.body) || $parent.is('blockquote');\r\n        });\r\n      };\r\n    })(this)());\r\n    return this._rootNodes;\r\n  };\r\n\r\n  Selection.prototype.rangeAtEndOf = function(node, range) {\r\n    var afterLastNode, beforeLastNode, endNode, endNodeLength, lastNodeIsBr, result;\r\n    if (range == null) {\r\n      range = this.range();\r\n    }\r\n    if (!(range && range.collapsed)) {\r\n      return;\r\n    }\r\n    node = $(node)[0];\r\n    endNode = range.endContainer;\r\n    endNodeLength = this.editor.util.getNodeLength(endNode);\r\n    beforeLastNode = range.endOffset === endNodeLength - 1;\r\n    lastNodeIsBr = $(endNode).contents().last().is('br');\r\n    afterLastNode = range.endOffset === endNodeLength;\r\n    if (!((beforeLastNode && lastNodeIsBr) || afterLastNode)) {\r\n      return false;\r\n    }\r\n    if (node === endNode) {\r\n      return true;\r\n    } else if (!$.contains(node, endNode)) {\r\n      return false;\r\n    }\r\n    result = true;\r\n    $(endNode).parentsUntil(node).addBack().each(function(i, n) {\r\n      var $lastChild, beforeLastbr, isLastNode, nodes;\r\n      nodes = $(n).parent().contents().filter(function() {\r\n        return !(this !== n && this.nodeType === 3 && !this.nodeValue);\r\n      });\r\n      $lastChild = nodes.last();\r\n      isLastNode = $lastChild.get(0) === n;\r\n      beforeLastbr = $lastChild.is('br') && $lastChild.prev().get(0) === n;\r\n      if (!(isLastNode || beforeLastbr)) {\r\n        result = false;\r\n        return false;\r\n      }\r\n    });\r\n    return result;\r\n  };\r\n\r\n  Selection.prototype.rangeAtStartOf = function(node, range) {\r\n    var result, startNode;\r\n    if (range == null) {\r\n      range = this.range();\r\n    }\r\n    if (!(range && range.collapsed)) {\r\n      return;\r\n    }\r\n    node = $(node)[0];\r\n    startNode = range.startContainer;\r\n    if (range.startOffset !== 0) {\r\n      return false;\r\n    }\r\n    if (node === startNode) {\r\n      return true;\r\n    } else if (!$.contains(node, startNode)) {\r\n      return false;\r\n    }\r\n    result = true;\r\n    $(startNode).parentsUntil(node).addBack().each(function(i, n) {\r\n      var nodes;\r\n      nodes = $(n).parent().contents().filter(function() {\r\n        return !(this !== n && this.nodeType === 3 && !this.nodeValue);\r\n      });\r\n      if (nodes.first().get(0) !== n) {\r\n        return result = false;\r\n      }\r\n    });\r\n    return result;\r\n  };\r\n\r\n  Selection.prototype.insertNode = function(node, range) {\r\n    if (range == null) {\r\n      range = this.range();\r\n    }\r\n    if (!range) {\r\n      return;\r\n    }\r\n    node = $(node)[0];\r\n    range.insertNode(node);\r\n    return this.setRangeAfter(node, range);\r\n  };\r\n\r\n  Selection.prototype.setRangeAfter = function(node, range) {\r\n    if (range == null) {\r\n      range = this.range();\r\n    }\r\n    if (range == null) {\r\n      return;\r\n    }\r\n    node = $(node)[0];\r\n    range.setEndAfter(node);\r\n    range.collapse(false);\r\n    return this.range(range);\r\n  };\r\n\r\n  Selection.prototype.setRangeBefore = function(node, range) {\r\n    if (range == null) {\r\n      range = this.range();\r\n    }\r\n    if (range == null) {\r\n      return;\r\n    }\r\n    node = $(node)[0];\r\n    range.setEndBefore(node);\r\n    range.collapse(false);\r\n    return this.range(range);\r\n  };\r\n\r\n  Selection.prototype.setRangeAtStartOf = function(node, range) {\r\n    if (range == null) {\r\n      range = this.range();\r\n    }\r\n    node = $(node).get(0);\r\n    range.setEnd(node, 0);\r\n    range.collapse(false);\r\n    return this.range(range);\r\n  };\r\n\r\n  Selection.prototype.setRangeAtEndOf = function(node, range) {\r\n    var $lastNode, $node, contents, lastChild, lastChildLength, lastText, nodeLength;\r\n    if (range == null) {\r\n      range = this.range();\r\n    }\r\n    $node = $(node);\r\n    node = $node[0];\r\n    if (!node) {\r\n      return;\r\n    }\r\n    if ($node.is('pre')) {\r\n      contents = $node.contents();\r\n      if (contents.length > 0) {\r\n        lastChild = contents.last();\r\n        lastText = lastChild.text();\r\n        lastChildLength = this.editor.util.getNodeLength(lastChild[0]);\r\n        if (lastText.charAt(lastText.length - 1) === '\\n') {\r\n          range.setEnd(lastChild[0], lastChildLength - 1);\r\n        } else {\r\n          range.setEnd(lastChild[0], lastChildLength);\r\n        }\r\n      } else {\r\n        range.setEnd(node, 0);\r\n      }\r\n    } else {\r\n      nodeLength = this.editor.util.getNodeLength(node);\r\n      if (node.nodeType !== 3 && nodeLength > 0) {\r\n        $lastNode = $(node).contents().last();\r\n        if ($lastNode.is('br')) {\r\n          nodeLength -= 1;\r\n        } else if ($lastNode[0].nodeType !== 3 && this.editor.util.isEmptyNode($lastNode)) {\r\n          $lastNode.append(this.editor.util.phBr);\r\n          node = $lastNode[0];\r\n          nodeLength = 0;\r\n        }\r\n      }\r\n      range.setEnd(node, nodeLength);\r\n    }\r\n    range.collapse(false);\r\n    return this.range(range);\r\n  };\r\n\r\n  Selection.prototype.deleteRangeContents = function(range) {\r\n    var atEndOfBody, atStartOfBody, endRange, startRange;\r\n    if (range == null) {\r\n      range = this.range();\r\n    }\r\n    startRange = range.cloneRange();\r\n    endRange = range.cloneRange();\r\n    startRange.collapse(true);\r\n    endRange.collapse(false);\r\n    atStartOfBody = this.rangeAtStartOf(this.editor.body, startRange);\r\n    atEndOfBody = this.rangeAtEndOf(this.editor.body, endRange);\r\n    if (!range.collapsed && atStartOfBody && atEndOfBody) {\r\n      this.editor.body.empty();\r\n      range.setStart(this.editor.body[0], 0);\r\n      range.collapse(true);\r\n      this.range(range);\r\n    } else {\r\n      range.deleteContents();\r\n    }\r\n    return range;\r\n  };\r\n\r\n  Selection.prototype.breakBlockEl = function(el, range) {\r\n    var $el;\r\n    if (range == null) {\r\n      range = this.range();\r\n    }\r\n    $el = $(el);\r\n    if (!range.collapsed) {\r\n      return $el;\r\n    }\r\n    range.setStartBefore($el.get(0));\r\n    if (range.collapsed) {\r\n      return $el;\r\n    }\r\n    return $el.before(range.extractContents());\r\n  };\r\n\r\n  Selection.prototype.save = function(range) {\r\n    var endCaret, endRange, startCaret;\r\n    if (range == null) {\r\n      range = this.range();\r\n    }\r\n    if (this._selectionSaved) {\r\n      return;\r\n    }\r\n    endRange = range.cloneRange();\r\n    endRange.collapse(false);\r\n    startCaret = $('<span/>').addClass('simditor-caret-start');\r\n    endCaret = $('<span/>').addClass('simditor-caret-end');\r\n    endRange.insertNode(endCaret[0]);\r\n    range.insertNode(startCaret[0]);\r\n    this.clear();\r\n    return this._selectionSaved = true;\r\n  };\r\n\r\n  Selection.prototype.restore = function() {\r\n    var endCaret, endContainer, endOffset, range, startCaret, startContainer, startOffset;\r\n    if (!this._selectionSaved) {\r\n      return false;\r\n    }\r\n    startCaret = this.editor.body.find('.simditor-caret-start');\r\n    endCaret = this.editor.body.find('.simditor-caret-end');\r\n    if (startCaret.length && endCaret.length) {\r\n      startContainer = startCaret.parent();\r\n      startOffset = startContainer.contents().index(startCaret);\r\n      endContainer = endCaret.parent();\r\n      endOffset = endContainer.contents().index(endCaret);\r\n      if (startContainer[0] === endContainer[0]) {\r\n        endOffset -= 1;\r\n      }\r\n      range = document.createRange();\r\n      range.setStart(startContainer.get(0), startOffset);\r\n      range.setEnd(endContainer.get(0), endOffset);\r\n      startCaret.remove();\r\n      endCaret.remove();\r\n      this.range(range);\r\n    } else {\r\n      startCaret.remove();\r\n      endCaret.remove();\r\n    }\r\n    this._selectionSaved = false;\r\n    return range;\r\n  };\r\n\r\n  return Selection;\r\n\r\n});"]}