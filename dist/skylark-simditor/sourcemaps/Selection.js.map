{"version":3,"sources":["Selection.js"],"names":["define","langx","noder","$","Selection","Evented","inherit","_range","_startNodes","_endNodes","_containerNode","_nodes","_blockNodes","_rootNodes","init","editor","options","self","this","_selection","document","getSelection","on","e","console","log","reset","getRangeAt","clear","removeAllRanges","_error","range","ffOrIE","addRange","hoster","browser","mozilla","msie","inputManager","focused","body","focus","rangeCount","startNodes","startContainer","parentsUntil","get","unshift","endNodes","collapsed","endContainer","containerNode","commonAncestorContainer","nodes","first","is","each","i","node","$endNode","$node","$nodes","endIndex","index","sharedIndex","startIndex","push","parent","eq","last","contents","merge","slice","unique","blockNodes","filter","util","isBlockNode","rootNodes","$parent","rangeAtEndOf","afterLastNode","beforeLastNode","endNode","endNodeLength","lastNodeIsBr","result","getNodeLength","endOffset","contains","addBack","n","$lastChild","beforeLastbr","isLastNode","nodeType","nodeValue","prev","rangeAtStartOf","startNode","startOffset","insertNode","setRangeAfter","setEndAfter","collapse","setRangeBefore","setEndBefore","setRangeAtStartOf","setEnd","setRangeAtEndOf","$lastNode","lastChild","lastChildLength","lastText","nodeLength","length","text","charAt","isEmptyNode","append","phBr","deleteRangeContents","atEndOfBody","atStartOfBody","endRange","startRange","cloneRange","empty","setStart","deleteContents","breakBlockEl","el","$el","setStartBefore","before","extractContents","save","endCaret","startCaret","_selectionSaved","addClass","restore","find","createRange","remove","pluginName"],"mappings":"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","file":"../Selection.js","sourcesContent":["define([\r\n  \"skylark-langx/langx\",\r\n  \"skylark-utils-dom/noder\",\r\n  \"skylark-jquery\"\r\n],function(langx,noder,$){ \r\n\r\n  var Selection = langx.Evented.inherit({\r\n    _range : null,\r\n\r\n    _startNodes : null,\r\n\r\n    _endNodes : null,\r\n\r\n    _containerNode : null,\r\n\r\n    _nodes : null,\r\n\r\n    _blockNodes : null,\r\n\r\n    _rootNodes : null,\r\n\r\n    init : function(editor,options) {\r\n      var self = this;\r\n      this.editor = editor; //this._module;\r\n      this.options = options;\r\n      this._selection = document.getSelection();\r\n\r\n      this.editor.on('selectionchanged', function(e) {\r\n        console.log(\"selectionchanged\");\r\n        self.reset();\r\n        return self._range = self._selection.getRangeAt(0);\r\n      });\r\n\r\n      this.editor.on('blur', function(e) {\r\n        return self.reset();\r\n      });\r\n\r\n      this.editor.on('focus', function(e) {\r\n        self.reset();\r\n        return self._range = self._selection.getRangeAt(0);\r\n      });\r\n    },\r\n\r\n    reset : function() {\r\n      this._range = null;\r\n      this._startNodes = null;\r\n      this._endNodes = null;\r\n      this._containerNode = null;\r\n      this._nodes = null;\r\n      this._blockNodes = null;\r\n\r\n      return this._rootNodes = null;\r\n    },\r\n\r\n    clear : function() {\r\n      var e;\r\n      try {\r\n        this._selection.removeAllRanges();\r\n        console.log(\"clear\");\r\n        debugger;\r\n      } catch (_error) {\r\n        e = _error;\r\n      }\r\n      return this.reset();\r\n    },\r\n\r\n    range : function(range) {\r\n      var ffOrIE;\r\n      if (range) {\r\n        this.clear();\r\n        this._selection.addRange(range);\r\n        this._range = range;\r\n //       ffOrIE = this.editor.util.browser.firefox || this.editor.util.browser.msie;\r\n        ffOrIE = langx.hoster.browser.mozilla || langx.hoster.browser.msie;\r\n        if (!this.editor.inputManager.focused && ffOrIE) {\r\n          this.editor.body.focus();\r\n        }\r\n      } else if (!this._range && this.editor.inputManager.focused && this._selection.rangeCount) {\r\n        this._range = this._selection.getRangeAt(0);\r\n      }\r\n      return this._range;\r\n    },\r\n\r\n    startNodes : function() {\r\n      if (this._range) {\r\n        if (!this._startNodes) {\r\n          this._startNodes = (function(self) {\r\n            return function() {\r\n              var startNodes;\r\n              startNodes = $(self._range.startContainer).parentsUntil(self.editor.body).get();\r\n              startNodes.unshift(self._range.startContainer);\r\n              return $(startNodes);\r\n            };\r\n          })(this)();\r\n        } \r\n\r\n      }\r\n      return this._startNodes;\r\n    },\r\n\r\n    endNodes : function() {\r\n      var endNodes;\r\n      if (this._range) {\r\n        this._endNodes || (this._endNodes = this._range.collapsed ? this.startNodes() : (endNodes = $(this._range.endContainer).parentsUntil(this.editor.body).get(), endNodes.unshift(this._range.endContainer), $(endNodes)));\r\n      }\r\n      return this._endNodes;\r\n    },\r\n\r\n    containerNode : function() {\r\n      if (this._range) {\r\n        this._containerNode || (this._containerNode = $(this._range.commonAncestorContainer));\r\n      }\r\n      return this._containerNode;\r\n    },\r\n\r\n    nodes : function() {\r\n      if (this._range) {\r\n        this._nodes || (this._nodes = (function(self) {\r\n          return function() {\r\n            var nodes;\r\n            nodes = [];\r\n            if (self.startNodes().first().is(self.endNodes().first())) {\r\n              nodes = self.startNodes().get();\r\n            } else {\r\n              self.startNodes().each(function(i, node) {\r\n                var $endNode, $node, $nodes, endIndex, index, sharedIndex, startIndex;\r\n                $node = $(node);\r\n                if (self.endNodes().index($node) > -1) {\r\n                  return nodes.push(node);\r\n                } else if ($node.parent().is(self.editor.body) || (sharedIndex = self.endNodes().index($node.parent())) > -1) {\r\n                  if (sharedIndex && sharedIndex > -1) {\r\n                    $endNode = self.endNodes().eq(sharedIndex - 1);\r\n                  } else {\r\n                    $endNode = self.endNodes().last();\r\n                  }\r\n                  $nodes = $node.parent().contents();\r\n                  startIndex = $nodes.index($node);\r\n                  endIndex = $nodes.index($endNode);\r\n                  return $.merge(nodes, $nodes.slice(startIndex, endIndex).get());\r\n                } else {\r\n                  $nodes = $node.parent().contents();\r\n                  index = $nodes.index($node);\r\n                  return $.merge(nodes, $nodes.slice(index).get());\r\n                }\r\n              });\r\n              self.endNodes().each(function(i, node) {\r\n                var $node, $nodes, index;\r\n                $node = $(node);\r\n                if ($node.parent().is(self.editor.body) || self.startNodes().index($node.parent()) > -1) {\r\n                  nodes.push(node);\r\n                  return false;\r\n                } else {\r\n                  $nodes = $node.parent().contents();\r\n                  index = $nodes.index($node);\r\n                  return $.merge(nodes, $nodes.slice(0, index + 1));\r\n                }\r\n              });\r\n            }\r\n            return $($.unique(nodes));\r\n          };\r\n        })(this)());\r\n      }\r\n      return this._nodes;\r\n    },\r\n\r\n    blockNodes : function() {\r\n      if (!this._range) {\r\n        return;\r\n      }\r\n\r\n      this._blockNodes || (this._blockNodes = (function(self) {\r\n        return function() {\r\n          return self.nodes().filter(function(i, node) {\r\n            return self.editor.util.isBlockNode(node);\r\n          });\r\n        };\r\n      })(this)());\r\n\r\n      return this._blockNodes;\r\n    },\r\n\r\n    rootNodes : function() {\r\n      if (!this._range) {\r\n        return;\r\n      }\r\n      this._rootNodes || (this._rootNodes = (function(self) {\r\n        return function() {\r\n          return self.nodes().filter(function(i, node) {\r\n            var $parent;\r\n            $parent = $(node).parent();\r\n            return $parent.is(self.editor.body) || $parent.is('blockquote');\r\n          });\r\n        };\r\n      })(this)());\r\n\r\n      return this._rootNodes;\r\n    },\r\n\r\n    rangeAtEndOf : function(node, range) {\r\n      var afterLastNode, beforeLastNode, endNode, endNodeLength, lastNodeIsBr, result;\r\n      if (range == null) {\r\n        range = this.range();\r\n      }\r\n      if (!(range && range.collapsed)) {\r\n        return;\r\n      }\r\n      node = $(node)[0];\r\n      endNode = range.endContainer;\r\n      endNodeLength = this.editor.util.getNodeLength(endNode);\r\n      beforeLastNode = range.endOffset === endNodeLength - 1;\r\n      lastNodeIsBr = $(endNode).contents().last().is('br');\r\n      afterLastNode = range.endOffset === endNodeLength;\r\n      if (!((beforeLastNode && lastNodeIsBr) || afterLastNode)) {\r\n        return false;\r\n      }\r\n      if (node === endNode) {\r\n        return true;\r\n      } else if (!noder.contains(node, endNode)) {\r\n        return false;\r\n      }\r\n      result = true;\r\n      $(endNode).parentsUntil(node).addBack().each(function(i, n) {\r\n        var $lastChild, beforeLastbr, isLastNode, nodes;\r\n        nodes = $(n).parent().contents().filter(function() {\r\n          return !(this !== n && this.nodeType === 3 && !this.nodeValue);\r\n        });\r\n        $lastChild = nodes.last();\r\n        isLastNode = $lastChild.get(0) === n;\r\n        beforeLastbr = $lastChild.is('br') && $lastChild.prev().get(0) === n;\r\n        if (!(isLastNode || beforeLastbr)) {\r\n          result = false;\r\n          return false;\r\n        }\r\n      });\r\n      return result;\r\n    },\r\n\r\n    rangeAtStartOf : function(node, range) {\r\n      var result, startNode;\r\n      if (range == null) {\r\n        range = this.range();\r\n      }\r\n      if (!(range && range.collapsed)) {\r\n        return;\r\n      }\r\n      node = $(node)[0];\r\n      startNode = range.startContainer;\r\n      if (range.startOffset !== 0) {\r\n        return false;\r\n      }\r\n      if (node === startNode) {\r\n        return true;\r\n      } else if (!noder.contains(node, startNode)) {\r\n        return false;\r\n      }\r\n      result = true;\r\n      $(startNode).parentsUntil(node).addBack().each(function(i, n) {\r\n        var nodes;\r\n        nodes = $(n).parent().contents().filter(function() {\r\n          return !(this !== n && this.nodeType === 3 && !this.nodeValue);\r\n        });\r\n        if (nodes.first().get(0) !== n) {\r\n          return result = false;\r\n        }\r\n      });\r\n      return result;\r\n    },\r\n\r\n    insertNode : function(node, range) {\r\n      if (range == null) {\r\n        range = this.range();\r\n      }\r\n      if (!range) {\r\n        return;\r\n      }\r\n      node = $(node)[0];\r\n      range.insertNode(node);\r\n      return this.setRangeAfter(node, range);\r\n    },\r\n\r\n    setRangeAfter : function(node, range) {\r\n      if (range == null) {\r\n        range = this.range();\r\n      }\r\n      if (range == null) {\r\n        return;\r\n      }\r\n      node = $(node)[0];\r\n      range.setEndAfter(node);\r\n      range.collapse(false);\r\n      return this.range(range);\r\n    },\r\n\r\n    setRangeBefore : function(node, range) {\r\n      if (range == null) {\r\n        range = this.range();\r\n      }\r\n      if (range == null) {\r\n        return;\r\n      }\r\n      node = $(node)[0];\r\n      range.setEndBefore(node);\r\n      range.collapse(false);\r\n      return this.range(range);\r\n    },\r\n\r\n    setRangeAtStartOf : function(node, range) {\r\n      if (range == null) {\r\n        range = this.range();\r\n      }\r\n      node = $(node).get(0);\r\n      range.setEnd(node, 0);\r\n      range.collapse(false);\r\n      return this.range(range);\r\n    },\r\n\r\n    setRangeAtEndOf : function(node, range) {\r\n      var $lastNode, $node, contents, lastChild, lastChildLength, lastText, nodeLength;\r\n      if (range == null) {\r\n        range = this.range();\r\n      }\r\n      $node = $(node);\r\n      node = $node[0];\r\n      if (!node) {\r\n        return;\r\n      }\r\n      if ($node.is('pre')) {\r\n        contents = $node.contents();\r\n        if (contents.length > 0) {\r\n          lastChild = contents.last();\r\n          lastText = lastChild.text();\r\n          lastChildLength = this.editor.util.getNodeLength(lastChild[0]);\r\n          if (lastText.charAt(lastText.length - 1) === '\\n') {\r\n            range.setEnd(lastChild[0], lastChildLength - 1);\r\n          } else {\r\n            range.setEnd(lastChild[0], lastChildLength);\r\n          }\r\n        } else {\r\n          range.setEnd(node, 0);\r\n        }\r\n      } else {\r\n        nodeLength = this.editor.util.getNodeLength(node);\r\n        if (node.nodeType !== 3 && nodeLength > 0) {\r\n          $lastNode = $(node).contents().last();\r\n          if ($lastNode.is('br')) {\r\n            nodeLength -= 1;\r\n          } else if ($lastNode[0].nodeType !== 3 && this.editor.util.isEmptyNode($lastNode)) {\r\n            $lastNode.append(this.editor.util.phBr);\r\n            node = $lastNode[0];\r\n            nodeLength = 0;\r\n          }\r\n        }\r\n        range.setEnd(node, nodeLength);\r\n      }\r\n      range.collapse(false);\r\n      return this.range(range);\r\n    },\r\n\r\n    deleteRangeContents : function(range) {\r\n      var atEndOfBody, atStartOfBody, endRange, startRange;\r\n      if (range == null) {\r\n        range = this.range();\r\n      }\r\n      startRange = range.cloneRange();\r\n      endRange = range.cloneRange();\r\n      startRange.collapse(true);\r\n      endRange.collapse(false);\r\n      atStartOfBody = this.rangeAtStartOf(this.editor.body, startRange);\r\n      atEndOfBody = this.rangeAtEndOf(this.editor.body, endRange);\r\n      if (!range.collapsed && atStartOfBody && atEndOfBody) {\r\n        this.editor.body.empty();\r\n        range.setStart(this.editor.body[0], 0);\r\n        range.collapse(true);\r\n        this.range(range);\r\n      } else {\r\n        range.deleteContents();\r\n      }\r\n      return range;\r\n    },\r\n\r\n    breakBlockEl : function(el, range) {\r\n      var $el;\r\n      if (range == null) {\r\n        range = this.range();\r\n      }\r\n      $el = $(el);\r\n      if (!range.collapsed) {\r\n        return $el;\r\n      }\r\n      range.setStartBefore($el.get(0));\r\n      if (range.collapsed) {\r\n        return $el;\r\n      }\r\n      return $el.before(range.extractContents());\r\n    },\r\n\r\n    save : function(range) {\r\n      var endCaret, endRange, startCaret;\r\n      if (range == null) {\r\n        range = this.range();\r\n      }\r\n      if (this._selectionSaved) {\r\n        return;\r\n      }\r\n      endRange = range.cloneRange();\r\n      endRange.collapse(false);\r\n      startCaret = $('<span/>').addClass('simditor-caret-start');\r\n      endCaret = $('<span/>').addClass('simditor-caret-end');\r\n      endRange.insertNode(endCaret[0]);\r\n      range.insertNode(startCaret[0]);\r\n      this.clear();\r\n      return this._selectionSaved = true;\r\n    },\r\n\r\n    restore : function() {\r\n      var endCaret, endContainer, endOffset, range, startCaret, startContainer, startOffset;\r\n      if (!this._selectionSaved) {\r\n        return false;\r\n      }\r\n      startCaret = this.editor.body.find('.simditor-caret-start');\r\n      endCaret = this.editor.body.find('.simditor-caret-end');\r\n      if (startCaret.length && endCaret.length) {\r\n        startContainer = startCaret.parent();\r\n        startOffset = startContainer.contents().index(startCaret);\r\n        endContainer = endCaret.parent();\r\n        endOffset = endContainer.contents().index(endCaret);\r\n        if (startContainer[0] === endContainer[0]) {\r\n          endOffset -= 1;\r\n        }\r\n        range = document.createRange();\r\n        range.setStart(startContainer.get(0), startOffset);\r\n        range.setEnd(endContainer.get(0), endOffset);\r\n        startCaret.remove();\r\n        endCaret.remove();\r\n        this.range(range);\r\n      } else {\r\n        startCaret.remove();\r\n        endCaret.remove();\r\n      }\r\n      this._selectionSaved = false;\r\n      return range;\r\n    },\r\n  });\r\n\r\n  Selection.pluginName = 'Selection';\r\n\r\n\r\n  return Selection;\r\n\r\n});"]}