{"version":3,"sources":["buttons/TableButton.js"],"names":["define","langx","tables","$","Toolbar","Simditor","Button","TableButton","inherit","prototype","name","icon","htmlTag","disableTag","menu","_init","_this","call","this","merge","editor","formatter","_allowedTags","extend","_allowedAttributes","td","col","_allowedStyles","th","_initShortcuts","_initResize","on","e","$el","find","each","i","table","decorate","undecorate","$container","range","body","removeClass","selection","containerNode","collapsed","is","setRangeAtEndOf","closest","addClass","keystroke","add","$node","_tdNav","$td","direction","$anotherTr","$tr","action","index","ref","parent","length","eq","resizable","document","cssClasses","resizeHandle","wrapper","hotkeys","editMenu","click","renderMenu","$table","_t","appendTo","menuWrapper","createMenu","createTable","$trs","num","currentTarget","prevAll","addBack","$closestBlock","colNum","rowNum","inputManager","focused","blockNodes","last","util","isEmptyNode","replaceWith","after","setRangeAtStartOf","trigger","tableDecorate","row","phBr","refreshTableWidth","setActive","active","hide","show","deleteRow","ret","self","newTr","insertRow","deleteCol","newTd","insertCol","deleteTable","$block","command","param","addButton"],"mappings":";;;;;;;AAAAA,QACE,sBACA,2BACA,iBACA,aACA,cACA,aACA,SAASC,EAAMC,EAAOC,EAAEC,EAAQC,EAASC,GACzC,IAAIC,EAAcD,EAAOE,YA4TzB,OAvTAD,EAAYE,UAAUC,KAAO,QAE7BH,EAAYE,UAAUE,KAAO,QAE7BJ,EAAYE,UAAUG,QAAU,QAEhCL,EAAYE,UAAUI,WAAa,sBAEnCN,EAAYE,UAAUK,MAAO,EAE7BP,EAAYE,UAAUM,MAAQ,WAaD,IAAUC,EAoDrC,OAhEAV,EAAOG,UAAUM,MAAME,KAAKC,MAC5BjB,EAAMkB,MAAMD,KAAKE,OAAOC,UAAUC,cAAe,QAAS,KAAM,QAAS,KAAM,KAAM,WAAY,QACjGrB,EAAMsB,OAAOL,KAAKE,OAAOC,UAAUG,oBACjCC,IAAK,UAAW,WAChBC,KAAM,WAERzB,EAAMsB,OAAOL,KAAKE,OAAOC,UAAUM,gBACjCF,IAAK,cACLG,IAAK,gBAEPV,KAAKW,iBACLX,KAAKY,cACLZ,KAAKE,OAAOW,GAAG,YAAsBf,EAMlCE,KALM,SAASc,EAAGC,GACjB,OAAOA,EAAIC,KAAK,SAASC,KAAK,SAASC,EAAGC,GACxC,OAAOrB,EAAMsB,SAASnC,EAAEkC,SAI9BnB,KAAKE,OAAOW,GAAG,aAAc,SAAUf,GACrC,OAAO,SAASgB,EAAGC,GACjB,OAAOA,EAAIC,KAAK,SAASC,KAAK,SAASC,EAAGC,GACxC,OAAOrB,EAAMuB,WAAWpC,EAAEkC,OAHH,CAM1BnB,OACHA,KAAKE,OAAOW,GAAG,yBAA0B,SAAUf,GACjD,OAAO,SAASgB,GACd,IAAIQ,EAAYC,EAGhB,GAFAzB,EAAMI,OAAOsB,KAAKR,KAAK,0CAA0CS,YAAY,UAC7EF,EAAQzB,EAAMI,OAAOwB,UAAUH,QAQ/B,OAJAD,EAAaxB,EAAMI,OAAOwB,UAAUC,gBAChCJ,EAAMK,WAAaN,EAAWO,GAAG,oBACnC/B,EAAMI,OAAOwB,UAAUI,gBAAgBR,GAElCA,EAAWS,QAAQ,SAAUjC,EAAMI,OAAOsB,MAAMQ,SAAS,WAZ3B,CActChC,OACHA,KAAKE,OAAOW,GAAG,aAAc,SAAUf,GACrC,OAAO,SAASgB,GACd,OAAOhB,EAAMI,OAAOsB,KAAKR,KAAK,0CAA0CS,YAAY,WAF3D,CAI1BzB,OACHA,KAAKE,OAAO+B,UAAUC,IAAI,KAAM,KAAM,SAAUpC,GAC9C,OAAO,SAASgB,EAAGqB,GAEjB,OADArC,EAAMsC,OAAOD,EAAO,OACb,GAH2B,CAKnCnC,OACHA,KAAKE,OAAO+B,UAAUC,IAAI,KAAM,KAAM,SAAUpC,GAC9C,OAAO,SAASgB,EAAGqB,GAEjB,OADArC,EAAMsC,OAAOD,EAAO,OACb,GAH2B,CAKnCnC,OACHA,KAAKE,OAAO+B,UAAUC,IAAI,OAAQ,KAAM,SAAUpC,GAChD,OAAO,SAASgB,EAAGqB,GAEjB,OADArC,EAAMsC,OAAOD,EAAO,SACb,GAH6B,CAKrCnC,OACIA,KAAKE,OAAO+B,UAAUC,IAAI,OAAQ,KAAM,SAAUpC,GACvD,OAAO,SAASgB,EAAGqB,GAEjB,OADArC,EAAMsC,OAAOD,EAAO,SACb,GAHoC,CAK5CnC,QAGLX,EAAYE,UAAU6C,OAAS,SAASC,EAAKC,GAC3C,IAAIC,EAAYC,EAAKC,EAAoBC,EAAkBC,EAQ3D,OAPiB,MAAbL,IACFA,EAAY,MAEdG,EAAuB,OAAdH,EAAqB,OAAS,QACvCK,EAAoB,OAAdL,GAAsB,QAAS,UAAY,QAAS,UAA0B,GAAiBK,EAAI,GACzGH,EAAMH,EAAIO,OAAO,SACjBL,EAAavC,KAAK,IAAMyC,EAAS,OAAOD,IACvBK,OAAS,KAG1BH,EAAQF,EAAIxB,KAAK,UAAU0B,MAAML,GAC1BrC,KAAKE,OAAOwB,UAAUI,gBAAgBS,EAAWvB,KAAK,UAAU8B,GAAGJ,MAG5ErD,EAAYE,UAAUqB,YAAc,WAElC5B,EAAO+D,UAAUC,UACfC,YACEC,aAAe,yBACfC,QAAU,qBAMhB9D,EAAYE,UAAUoB,eAAiB,WACE,IAAUb,EAkBjD,OAlBAE,KAAKE,OAAOkD,QAAQlB,IAAI,eAAyBpC,EAK9CE,KAJM,SAASc,GAEd,OADAhB,EAAMuD,SAASrC,KAAK,yCAAyCsC,SACtD,KAGXtD,KAAKE,OAAOkD,QAAQlB,IAAI,gBAAiB,SAAUpC,GACjD,OAAO,SAASgB,GAEd,OADAhB,EAAMuD,SAASrC,KAAK,yCAAyCsC,SACtD,GAH8B,CAKtCtD,OACHA,KAAKE,OAAOkD,QAAQlB,IAAI,gBAAiB,SAAUpC,GACjD,OAAO,SAASgB,GAEd,OADAhB,EAAMuD,SAASrC,KAAK,wCAAwCsC,SACrD,GAH8B,CAKtCtD,OACIA,KAAKE,OAAOkD,QAAQlB,IAAI,iBAAkB,SAAUpC,GACzD,OAAO,SAASgB,GAEd,OADAhB,EAAMuD,SAASrC,KAAK,yCAAyCsC,SACtD,GAHsC,CAK9CtD,QAGLX,EAAYE,UAAUgE,WAAa,WACjC,IAAIC,EAKiD1D,EAiBrD,OArBAb,EAAE,4NAA6Oe,KAAKyD,GAAG,aAAgB,iLAA8LzD,KAAKyD,GAAG,kBAAqB,oMAAiNzD,KAAKyD,GAAG,kBAAqB,6OAA4PzD,KAAKyD,GAAG,gBAAmB,gLAA6LzD,KAAKyD,GAAG,oBAAuB,oMAAiNzD,KAAKyD,GAAG,qBAAwB,+OAA8PzD,KAAKyD,GAAG,eAAkB,mDAAmDC,SAAS1D,KAAK2D,aAC7wD3D,KAAK4D,WAAa5D,KAAK2D,YAAY3C,KAAK,sBACxChB,KAAKqD,SAAWrD,KAAK2D,YAAY3C,KAAK,oBACtCwC,EAASxD,KAAK6D,YAAY,EAAG,GAAGH,SAAS1D,KAAK4D,YAC9C5D,KAAK4D,WAAW/C,GAAG,aAAc,UAAoBf,EAalDE,KAZM,SAASc,GACd,IAAIuB,EAAKG,EAAKsB,EAAMC,EASpB,OARAjE,EAAM8D,WAAW5C,KAAK,UAAUS,YAAY,YAG5CsC,GADAvB,GADAH,EAAMpD,EAAE6B,EAAEkD,gBACApB,UACA5B,KAAK,UAAU0B,MAAML,GAAO,EACtCyB,EAAOtB,EAAIyB,QAAQ,MAAMC,UACrB1B,EAAII,SAASf,GAAG,WAClBiC,EAAOA,EAAK5B,IAAIsB,EAAOxC,KAAK,cAEvB8C,EAAK9C,KAAK,SAAW+C,EAAM,YAAcA,EAAM,KAAK/B,SAAS,eAGxEhC,KAAK4D,WAAW/C,GAAG,aAAc,SAASC,GACxC,OAAO7B,EAAE6B,EAAEkD,eAAehD,KAAK,UAAUS,YAAY,cAEhDzB,KAAK4D,WAAW/C,GAAG,YAAa,SAAU,SAAUf,GACzD,OAAO,SAASgB,GACd,IAAIqD,EAAe9B,EAAKG,EAAK4B,EAAQC,EAErC,GADAvE,EAAMqD,QAAQ1B,YAAY,WACrB3B,EAAMI,OAAOoE,aAAaC,QAoB/B,OAfAH,GADA5B,GADAH,EAAMpD,EAAE6B,EAAEkD,gBACApB,UACG5B,KAAK,MAAM0B,MAAML,GAAO,EACrCgC,EAAS7B,EAAIyB,QAAQ,MAAMpB,OAAS,EAChCL,EAAII,SAASf,GAAG,WAClBwC,GAAU,GAEZb,EAAS1D,EAAM+D,YAAYQ,EAAQD,GAAQ,GAC3CD,EAAgBrE,EAAMI,OAAOwB,UAAU8C,aAAaC,OAChD3E,EAAMI,OAAOwE,KAAKC,YAAYR,GAChCA,EAAcS,YAAYpB,GAE1BW,EAAcU,MAAMrB,GAEtB1D,EAAMsB,SAASoC,GACf1D,EAAMI,OAAOwB,UAAUoD,kBAAkBtB,EAAOxC,KAAK,aACrDlB,EAAMI,OAAO6E,QAAQ,iBACd,GAxBsC,CA0B9C/E,QAGLX,EAAYE,UAAU6B,SAAW,SAASoC,GACxC,OAAOvE,EAAED,EAAOoC,SAASoC,EAAO,IAC9BwB,cAAgB,iBAChB9B,aAAe,6BAKnB7D,EAAYE,UAAU8B,WAAa,SAASmC,GAC1C,OAAOvE,EAAED,EAAOqC,WAAWmC,EAAO,IAChCwB,cAAgB,iBAChB9B,aAAe,6BAMnB7D,EAAYE,UAAUsE,YAAc,SAASoB,EAAKzE,EAAK0E,GACrD,OAAOjG,EAAED,EAAO6E,YAAYoB,EAAIzE,EAAI0E,EAAOlF,KAAKE,OAAOwE,KAAKQ,KAAO,QAGrE7F,EAAYE,UAAU4F,kBAAoB,SAAS3B,GACjD,OAAOrC,MAAMgE,kBAAkB3B,EAAO,KAGxCnE,EAAYE,UAAU6F,UAAY,SAASC,GAEzC,OADAjG,EAAOG,UAAU6F,UAAUrF,KAAKC,KAAMqF,GAClCA,GACFrF,KAAK4D,WAAW0B,OACTtF,KAAKqD,SAASkC,SAErBvF,KAAK4D,WAAW2B,OACTvF,KAAKqD,SAASiC,SAIzBjG,EAAYE,UAAUiG,UAAY,SAASnD,GACzC,IACIoD,EADAC,EAAO1F,KASX,OANAhB,EAAOwG,UAAUnD,EAAI,GAAG,SAASsD,EAAMjD,GACjCiD,IACFF,EAAMC,EAAKxF,OAAOwB,UAAUI,gBAAgB7C,EAAE0G,GAAO3E,KAAK,UAAU8B,GAAGJ,OAIpE+C,GAGTpG,EAAYE,UAAUqG,UAAY,SAASvD,EAAKC,GAC9C,IACImD,EADAC,EAAO1F,KAOX,OAJAhB,EAAO4G,UAAUvD,EAAI,GAAGC,EAAUoD,EAAKxF,OAAOwE,KAAKQ,KAAK,SAASS,EAAMjD,GACrE+C,EAAOC,EAAKxF,OAAOwB,UAAUoD,kBAAkB7F,EAAE0G,GAAO3E,KAAK,UAAU8B,GAAGJ,MAGrE+C,GAITpG,EAAYE,UAAUsG,UAAY,SAASxD,GACzC,IACIoD,EADAC,EAAO1F,KASX,OANAhB,EAAO6G,UAAUxD,EAAI,GAAG,SAASyD,GAC3BA,IACFL,EAAMC,EAAKxF,OAAOwB,UAAUI,gBAAgB7C,EAAE6G,OAI3CL,GAGTpG,EAAYE,UAAUwG,UAAY,SAAS1D,EAAKC,GAC9C,IACImD,EADAC,EAAO1F,KAOX,OAJAhB,EAAO+G,UAAU1D,EAAI,GAAGC,EAAUoD,EAAKxF,OAAOwE,KAAKQ,KAAK,SAASY,GAC/DL,EAAMC,EAAKxF,OAAOwB,UAAUoD,kBAAkB7F,EAAE6G,MAG3CL,GAGTpG,EAAYE,UAAUyG,YAAc,SAAS3D,GAC3C,IAAIqD,EAAO1F,KACXhB,EAAOgH,YAAY3D,EAAI,GAAG,SAAS4D,GACjC,GAAIA,EAAOpD,OAAS,EAClB,OAAO6C,EAAKxF,OAAOwB,UAAUoD,kBAAkBmB,MAKrD5G,EAAYE,UAAU2G,QAAU,SAASC,GACvC,IAAI9D,EAEJ,IADAA,EAAMrC,KAAKE,OAAOwB,UAAUC,gBAAgBI,QAAQ,WAC1Cc,OAAS,EAAnB,CAGA,GAAc,cAAVsD,EACFnG,KAAKwF,UAAUnD,QACV,GAAc,mBAAV8D,EACTnG,KAAK4F,UAAUvD,EAAK,eACf,GAAc,mBAAV8D,EACTnG,KAAK4F,UAAUvD,QACV,GAAc,cAAV8D,EACTnG,KAAK6F,UAAUxD,QACV,GAAc,kBAAV8D,EACTnG,KAAK+F,UAAU1D,EAAK,eACf,GAAc,mBAAV8D,EACTnG,KAAK+F,UAAU1D,OACV,CAAA,GAAc,gBAAV8D,EAGT,OAFAnG,KAAKgG,YAAY3D,GAInB,OAAOrC,KAAKE,OAAO6E,QAAQ,kBAG7B5F,EAASD,QAAQkH,UAAU/G,GAEpBA","file":"../../buttons/TableButton.js","sourcesContent":["define([\r\n  \"skylark-langx/langx\",\r\n  \"skylark-utils-dom/tables\",\r\n  \"skylark-jquery\",\r\n  \"../Toolbar\",\r\n  \"../Simditor\",\r\n  \"../Button\"\r\n],function(langx,tables,$,Toolbar,Simditor,Button){ \r\n  var TableButton = Button.inherit({\r\n\r\n   });\r\n\r\n\r\n  TableButton.prototype.name = 'table';\r\n\r\n  TableButton.prototype.icon = 'table';\r\n\r\n  TableButton.prototype.htmlTag = 'table';\r\n\r\n  TableButton.prototype.disableTag = 'pre, li, blockquote';\r\n\r\n  TableButton.prototype.menu = true;\r\n\r\n  TableButton.prototype._init = function() {\r\n    Button.prototype._init.call(this);\r\n    langx.merge(this.editor.formatter._allowedTags, ['thead', 'th', 'tbody', 'tr', 'td', 'colgroup', 'col']);\r\n    langx.extend(this.editor.formatter._allowedAttributes, {\r\n      td: ['rowspan', 'colspan'],\r\n      col: ['width']\r\n    });\r\n    langx.extend(this.editor.formatter._allowedStyles, {\r\n      td: ['text-align'],\r\n      th: ['text-align']\r\n    });\r\n    this._initShortcuts();\r\n    this._initResize();\r\n    this.editor.on('decorate', (function(_this) {\r\n      return function(e, $el) {\r\n        return $el.find('table').each(function(i, table) {\r\n          return _this.decorate($(table));\r\n        });\r\n      };\r\n    })(this));\r\n    this.editor.on('undecorate', (function(_this) {\r\n      return function(e, $el) {\r\n        return $el.find('table').each(function(i, table) {\r\n          return _this.undecorate($(table));\r\n        });\r\n      };\r\n    })(this));\r\n    this.editor.on('selectionchanged.table', (function(_this) {\r\n      return function(e) {\r\n        var $container, range;\r\n        _this.editor.body.find('.simditor-table td, .simditor-table th').removeClass('active');\r\n        range = _this.editor.selection.range();\r\n        if (!range) {\r\n          return;\r\n        }\r\n        $container = _this.editor.selection.containerNode();\r\n        if (range.collapsed && $container.is('.simditor-table')) {\r\n          _this.editor.selection.setRangeAtEndOf($container);\r\n        }\r\n        return $container.closest('td, th', _this.editor.body).addClass('active');\r\n      };\r\n    })(this));\r\n    this.editor.on('blur.table', (function(_this) {\r\n      return function(e) {\r\n        return _this.editor.body.find('.simditor-table td, .simditor-table th').removeClass('active');\r\n      };\r\n    })(this));\r\n    this.editor.keystroke.add('up', 'td', (function(_this) {\r\n      return function(e, $node) {\r\n        _this._tdNav($node, 'up');\r\n        return true;\r\n      };\r\n    })(this));\r\n    this.editor.keystroke.add('up', 'th', (function(_this) {\r\n      return function(e, $node) {\r\n        _this._tdNav($node, 'up');\r\n        return true;\r\n      };\r\n    })(this));\r\n    this.editor.keystroke.add('down', 'td', (function(_this) {\r\n      return function(e, $node) {\r\n        _this._tdNav($node, 'down');\r\n        return true;\r\n      };\r\n    })(this));\r\n    return this.editor.keystroke.add('down', 'th', (function(_this) {\r\n      return function(e, $node) {\r\n        _this._tdNav($node, 'down');\r\n        return true;\r\n      };\r\n    })(this));\r\n  };\r\n\r\n  TableButton.prototype._tdNav = function($td, direction) {\r\n    var $anotherTr, $tr, action, anotherTag, index, parentTag, ref;\r\n    if (direction == null) {\r\n      direction = 'up';\r\n    }\r\n    action = direction === 'up' ? 'prev' : 'next';\r\n    ref = direction === 'up' ? ['tbody', 'thead'] : ['thead', 'tbody'], parentTag = ref[0], anotherTag = ref[1];\r\n    $tr = $td.parent('tr');\r\n    $anotherTr = this[\"_\" + action + \"Row\"]($tr);\r\n    if (!($anotherTr.length > 0)) {\r\n      return true;\r\n    }\r\n    index = $tr.find('td, th').index($td);\r\n    return this.editor.selection.setRangeAtEndOf($anotherTr.find('td, th').eq(index));\r\n  };\r\n\r\n  TableButton.prototype._initResize = function() {\r\n\r\n    tables.resizable(document,{\r\n      cssClasses : {\r\n        resizeHandle : \"simditor-resize-handle\",\r\n        wrapper : \"simditor-table\"\r\n      }\r\n    });\r\n\r\n  };\r\n\r\n  TableButton.prototype._initShortcuts = function() {\r\n    this.editor.hotkeys.add('ctrl+alt+up', (function(_this) {\r\n      return function(e) {\r\n        _this.editMenu.find('.menu-item[data-param=insertRowAbove]').click();\r\n        return false;\r\n      };\r\n    })(this));\r\n    this.editor.hotkeys.add('ctrl+alt+down', (function(_this) {\r\n      return function(e) {\r\n        _this.editMenu.find('.menu-item[data-param=insertRowBelow]').click();\r\n        return false;\r\n      };\r\n    })(this));\r\n    this.editor.hotkeys.add('ctrl+alt+left', (function(_this) {\r\n      return function(e) {\r\n        _this.editMenu.find('.menu-item[data-param=insertColLeft]').click();\r\n        return false;\r\n      };\r\n    })(this));\r\n    return this.editor.hotkeys.add('ctrl+alt+right', (function(_this) {\r\n      return function(e) {\r\n        _this.editMenu.find('.menu-item[data-param=insertColRight]').click();\r\n        return false;\r\n      };\r\n    })(this));\r\n  };\r\n\r\n  TableButton.prototype.renderMenu = function() {\r\n    var $table;\r\n    $(\"<div class=\\\"menu-create-table\\\">\\n</div>\\n<div class=\\\"menu-edit-table\\\">\\n  <ul>\\n    <li>\\n      <a tabindex=\\\"-1\\\" unselectable=\\\"on\\\" class=\\\"menu-item\\\"\\n        href=\\\"javascript:;\\\" data-param=\\\"deleteRow\\\">\\n        <span>\" + (this._t('deleteRow')) + \"</span>\\n      </a>\\n    </li>\\n    <li>\\n      <a tabindex=\\\"-1\\\" unselectable=\\\"on\\\" class=\\\"menu-item\\\"\\n        href=\\\"javascript:;\\\" data-param=\\\"insertRowAbove\\\">\\n        <span>\" + (this._t('insertRowAbove')) + \" ( Ctrl + Alt + ↑ )</span>\\n      </a>\\n    </li>\\n    <li>\\n      <a tabindex=\\\"-1\\\" unselectable=\\\"on\\\" class=\\\"menu-item\\\"\\n        href=\\\"javascript:;\\\" data-param=\\\"insertRowBelow\\\">\\n        <span>\" + (this._t('insertRowBelow')) + \" ( Ctrl + Alt + ↓ )</span>\\n      </a>\\n    </li>\\n    <li><span class=\\\"separator\\\"></span></li>\\n    <li>\\n      <a tabindex=\\\"-1\\\" unselectable=\\\"on\\\" class=\\\"menu-item\\\"\\n        href=\\\"javascript:;\\\" data-param=\\\"deleteCol\\\">\\n        <span>\" + (this._t('deleteColumn')) + \"</span>\\n      </a>\\n    </li>\\n    <li>\\n      <a tabindex=\\\"-1\\\" unselectable=\\\"on\\\" class=\\\"menu-item\\\"\\n        href=\\\"javascript:;\\\" data-param=\\\"insertColLeft\\\">\\n        <span>\" + (this._t('insertColumnLeft')) + \" ( Ctrl + Alt + ← )</span>\\n      </a>\\n    </li>\\n    <li>\\n      <a tabindex=\\\"-1\\\" unselectable=\\\"on\\\" class=\\\"menu-item\\\"\\n        href=\\\"javascript:;\\\" data-param=\\\"insertColRight\\\">\\n        <span>\" + (this._t('insertColumnRight')) + \" ( Ctrl + Alt + → )</span>\\n      </a>\\n    </li>\\n    <li><span class=\\\"separator\\\"></span></li>\\n    <li>\\n      <a tabindex=\\\"-1\\\" unselectable=\\\"on\\\" class=\\\"menu-item\\\"\\n        href=\\\"javascript:;\\\" data-param=\\\"deleteTable\\\">\\n        <span>\" + (this._t('deleteTable')) + \"</span>\\n      </a>\\n    </li>\\n  </ul>\\n</div>\").appendTo(this.menuWrapper);\r\n    this.createMenu = this.menuWrapper.find('.menu-create-table');\r\n    this.editMenu = this.menuWrapper.find('.menu-edit-table');\r\n    $table = this.createTable(6, 6).appendTo(this.createMenu);\r\n    this.createMenu.on('mouseenter', 'td, th', (function(_this) {\r\n      return function(e) {\r\n        var $td, $tr, $trs, num;\r\n        _this.createMenu.find('td, th').removeClass('selected');\r\n        $td = $(e.currentTarget);\r\n        $tr = $td.parent();\r\n        num = $tr.find('td, th').index($td) + 1;\r\n        $trs = $tr.prevAll('tr').addBack();\r\n        if ($tr.parent().is('tbody')) {\r\n          $trs = $trs.add($table.find('thead tr'));\r\n        }\r\n        return $trs.find(\"td:lt(\" + num + \"), th:lt(\" + num + \")\").addClass('selected');\r\n      };\r\n    })(this));\r\n    this.createMenu.on('mouseleave', function(e) {\r\n      return $(e.currentTarget).find('td, th').removeClass('selected');\r\n    });\r\n    return this.createMenu.on('mousedown', 'td, th', (function(_this) {\r\n      return function(e) {\r\n        var $closestBlock, $td, $tr, colNum, rowNum;\r\n        _this.wrapper.removeClass('menu-on');\r\n        if (!_this.editor.inputManager.focused) {\r\n          return;\r\n        }\r\n        $td = $(e.currentTarget);\r\n        $tr = $td.parent();\r\n        colNum = $tr.find('td').index($td) + 1;\r\n        rowNum = $tr.prevAll('tr').length + 1;\r\n        if ($tr.parent().is('tbody')) {\r\n          rowNum += 1;\r\n        }\r\n        $table = _this.createTable(rowNum, colNum, true);\r\n        $closestBlock = _this.editor.selection.blockNodes().last();\r\n        if (_this.editor.util.isEmptyNode($closestBlock)) {\r\n          $closestBlock.replaceWith($table);\r\n        } else {\r\n          $closestBlock.after($table);\r\n        }\r\n        _this.decorate($table);\r\n        _this.editor.selection.setRangeAtStartOf($table.find('th:first'));\r\n        _this.editor.trigger('valuechanged');\r\n        return false;\r\n      };\r\n    })(this));\r\n  };\r\n\r\n  TableButton.prototype.decorate = function($table) {\r\n    return $(tables.decorate($table[0],{\r\n      tableDecorate : 'simditor-table',\r\n      resizeHandle : 'simditor-resize-handle'\r\n    }));\r\n\r\n  };\r\n\r\n  TableButton.prototype.undecorate = function($table) {\r\n    return $(tables.undecorate($table[0],{\r\n      tableDecorate : 'simditor-table',\r\n      resizeHandle : 'simditor-resize-handle'\r\n    }));\r\n\r\n  };\r\n\r\n\r\n  TableButton.prototype.createTable = function(row, col, phBr) {\r\n    return $(tables.createTable(row,col,phBr ? this.editor.util.phBr : null));\r\n  };\r\n\r\n  TableButton.prototype.refreshTableWidth = function($table) {\r\n    return table.refreshTableWidth($table[0]);\r\n  };\r\n\r\n  TableButton.prototype.setActive = function(active) {\r\n    Button.prototype.setActive.call(this, active);\r\n    if (active) {\r\n      this.createMenu.hide();\r\n      return this.editMenu.show();\r\n    } else {\r\n      this.createMenu.show();\r\n      return this.editMenu.hide();\r\n    }\r\n  };\r\n\r\n  TableButton.prototype.deleteRow = function($td) {\r\n    var self = this,\r\n        ret; \r\n\r\n    tables.deleteRow($td[0],function(newTr,index){\r\n      if (newTr) {\r\n        ret = self.editor.selection.setRangeAtEndOf($(newTr).find('td, th').eq(index));\r\n      }\r\n    })\r\n\r\n    return ret;\r\n  };\r\n\r\n  TableButton.prototype.insertRow = function($td, direction) {\r\n    var self = this,\r\n        ret; \r\n\r\n    tables.insertRow($td[0],direction,self.editor.util.phBr,function(newTr,index){\r\n      ret =  self.editor.selection.setRangeAtStartOf($(newTr).find('td, th').eq(index));\r\n    })\r\n\r\n    return ret;\r\n\r\n  };\r\n\r\n  TableButton.prototype.deleteCol = function($td) {\r\n    var self = this,\r\n        ret; \r\n\r\n    tables.deleteCol($td[0],function(newTd){\r\n      if (newTd) {\r\n        ret = self.editor.selection.setRangeAtEndOf($(newTd));\r\n      }\r\n    })\r\n\r\n    return ret;\r\n  };\r\n\r\n  TableButton.prototype.insertCol = function($td, direction) {\r\n    var self = this,\r\n        ret; \r\n\r\n    tables.insertCol($td[0],direction,self.editor.util.phBr,function(newTd){\r\n      ret = self.editor.selection.setRangeAtStartOf($(newTd));\r\n    })\r\n\r\n    return ret;\r\n  };\r\n\r\n  TableButton.prototype.deleteTable = function($td) {\r\n    var self = this;\r\n    tables.deleteTable($td[0],function($block){\r\n      if ($block.length > 0) {\r\n        return self.editor.selection.setRangeAtStartOf($block);\r\n      }\r\n    });\r\n  };\r\n\r\n  TableButton.prototype.command = function(param) {\r\n    var $td;\r\n    $td = this.editor.selection.containerNode().closest('td, th');\r\n    if (!($td.length > 0)) {\r\n      return;\r\n    }\r\n    if (param === 'deleteRow') {\r\n      this.deleteRow($td);\r\n    } else if (param === 'insertRowAbove') {\r\n      this.insertRow($td, 'before');\r\n    } else if (param === 'insertRowBelow') {\r\n      this.insertRow($td);\r\n    } else if (param === 'deleteCol') {\r\n      this.deleteCol($td);\r\n    } else if (param === 'insertColLeft') {\r\n      this.insertCol($td, 'before');\r\n    } else if (param === 'insertColRight') {\r\n      this.insertCol($td);\r\n    } else if (param === 'deleteTable') {\r\n      this.deleteTable($td);\r\n    } else {\r\n      return;\r\n    }\r\n    return this.editor.trigger('valuechanged');\r\n  };\r\n\r\n  Simditor.Toolbar.addButton(TableButton);\r\n\r\n  return TableButton;\r\n\r\n\r\n});"]}