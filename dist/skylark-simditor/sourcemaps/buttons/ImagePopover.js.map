{"version":3,"sources":["buttons/ImagePopover.js"],"names":["define","langx","$","Toolbar","Simditor","Popover","ImagePopover","inherit","prototype","offset","top","left","render","tpl","_this","this","_t","el","addClass","append","srcEl","find","widthEl","heightEl","altEl","on","e","range","which","target","hasClass","preventDefault","document","createRange","button","editor","selection","setRangeAfter","hide","_loadImage","val","_resizeImg","currentTarget","data","refresh","inputEl","$img","_restoreImg","alt","attr","active","_initUploader","$uploadBtn","createInput","uploader","input","remove","type","title","multiple","accept","appendTo","stopPropagation","upload","inline","img","onlySetVal","height","value","width","isNumber","is","trigger","ref","size","split","src","callback","test","loadImage","blob","util","dataURLtoBlob","name","show","args","arguments","length","Array","slice","call","apply","prop"],"mappings":"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","file":"../../buttons/ImagePopover.js","sourcesContent":["define([\r\n  \"skylark-langx/langx\",\r\n  \"skylark-utils-dom/query\",\r\n  \"../Toolbar\",\r\n  \"../Simditor\",\r\n  \"../Popover\"\r\n],function(langx, $,Toolbar,Simditor,Popover){ \r\n   var ImagePopover = Popover.inherit({\r\n\r\n   });\r\n\r\n  ImagePopover.prototype.offset = {\r\n    top: 6,\r\n    left: -4\r\n  };\r\n\r\n  ImagePopover.prototype.render = function() {\r\n    var tpl;\r\n    tpl = \"<div class=\\\"link-settings\\\">\\n  <div class=\\\"settings-field\\\">\\n    <label>\" + (this._t('imageUrl')) + \"</label>\\n    <input class=\\\"image-src\\\" type=\\\"text\\\" tabindex=\\\"1\\\" />\\n    <a class=\\\"btn-upload\\\" href=\\\"javascript:;\\\"\\n      title=\\\"\" + (this._t('uploadImage')) + \"\\\" tabindex=\\\"-1\\\">\\n      <span class=\\\"simditor-icon simditor-icon-upload\\\"></span>\\n    </a>\\n  </div>\\n  <div class='settings-field'>\\n    <label>\" + (this._t('imageAlt')) + \"</label>\\n    <input class=\\\"image-alt\\\" id=\\\"image-alt\\\" type=\\\"text\\\" tabindex=\\\"1\\\" />\\n  </div>\\n  <div class=\\\"settings-field\\\">\\n    <label>\" + (this._t('imageSize')) + \"</label>\\n    <input class=\\\"image-size\\\" id=\\\"image-width\\\" type=\\\"text\\\" tabindex=\\\"2\\\" />\\n    <span class=\\\"times\\\">Ã—</span>\\n    <input class=\\\"image-size\\\" id=\\\"image-height\\\" type=\\\"text\\\" tabindex=\\\"3\\\" />\\n    <a class=\\\"btn-restore\\\" href=\\\"javascript:;\\\"\\n      title=\\\"\" + (this._t('restoreImageSize')) + \"\\\" tabindex=\\\"-1\\\">\\n      <span class=\\\"simditor-icon simditor-icon-undo\\\"></span>\\n    </a>\\n  </div>\\n</div>\";\r\n    this.el.addClass('image-popover').append(tpl);\r\n    this.srcEl = this.el.find('.image-src');\r\n    this.widthEl = this.el.find('#image-width');\r\n    this.heightEl = this.el.find('#image-height');\r\n    this.altEl = this.el.find('#image-alt');\r\n    this.srcEl.on('keydown', (function(_this) {\r\n      return function(e) {\r\n        var range;\r\n        if (!(e.which === 13 && !_this.target.hasClass('uploading'))) {\r\n          return;\r\n        }\r\n        e.preventDefault();\r\n        range = document.createRange();\r\n        _this.button.editor.selection.setRangeAfter(_this.target, range);\r\n        return _this.hide();\r\n      };\r\n    })(this));\r\n    this.srcEl.on('blur', (function(_this) {\r\n      return function(e) {\r\n        return _this._loadImage(_this.srcEl.val());\r\n      };\r\n    })(this));\r\n    this.el.find('.image-size').on('blur', (function(_this) {\r\n      return function(e) {\r\n        _this._resizeImg($(e.currentTarget));\r\n        return _this.el.data('popover').refresh();\r\n      };\r\n    })(this));\r\n    this.el.find('.image-size').on('keyup', (function(_this) {\r\n      return function(e) {\r\n        var inputEl;\r\n        inputEl = $(e.currentTarget);\r\n        if (!(e.which === 13 || e.which === 27 || e.which === 9)) {\r\n          return _this._resizeImg(inputEl, true);\r\n        }\r\n      };\r\n    })(this));\r\n    this.el.find('.image-size').on('keydown', (function(_this) {\r\n      return function(e) {\r\n        var $img, inputEl, range;\r\n        inputEl = $(e.currentTarget);\r\n        if (e.which === 13 || e.which === 27) {\r\n          e.preventDefault();\r\n          if (e.which === 13) {\r\n            _this._resizeImg(inputEl);\r\n          } else {\r\n            _this._restoreImg();\r\n          }\r\n          $img = _this.target;\r\n          _this.hide();\r\n          range = document.createRange();\r\n          return _this.button.editor.selection.setRangeAfter($img, range);\r\n        } else if (e.which === 9) {\r\n          return _this.el.data('popover').refresh();\r\n        }\r\n      };\r\n    })(this));\r\n    this.altEl.on('keydown', (function(_this) {\r\n      return function(e) {\r\n        var range;\r\n        if (e.which === 13) {\r\n          e.preventDefault();\r\n          range = document.createRange();\r\n          _this.button.editor.selection.setRangeAfter(_this.target, range);\r\n          return _this.hide();\r\n        }\r\n      };\r\n    })(this));\r\n    this.altEl.on('keyup', (function(_this) {\r\n      return function(e) {\r\n        if (e.which === 13 || e.which === 27 || e.which === 9) {\r\n          return;\r\n        }\r\n        _this.alt = _this.altEl.val();\r\n        return _this.target.attr('alt', _this.alt);\r\n      };\r\n    })(this));\r\n    this.el.find('.btn-restore').on('click', (function(_this) {\r\n      return function(e) {\r\n        _this._restoreImg();\r\n        return _this.el.data('popover').refresh();\r\n      };\r\n    })(this));\r\n    this.editor.on('valuechanged', (function(_this) {\r\n      return function(e) {\r\n        if (_this.active) {\r\n          return _this.refresh();\r\n        }\r\n      };\r\n    })(this));\r\n    return this._initUploader();\r\n  };\r\n\r\n  ImagePopover.prototype._initUploader = function() {\r\n    var $uploadBtn, createInput;\r\n    $uploadBtn = this.el.find('.btn-upload');\r\n    if (this.editor.uploader == null) {\r\n      $uploadBtn.remove();\r\n      return;\r\n    }\r\n    createInput = (function(_this) {\r\n      return function() {\r\n        if (_this.input) {\r\n          _this.input.remove();\r\n        }\r\n        return _this.input = $('<input/>', {\r\n          type: 'file',\r\n          title: _this._t('uploadImage'),\r\n          multiple: true,\r\n          accept: 'image/gif,image/jpeg,image/jpg,image/png,image/svg'\r\n        }).appendTo($uploadBtn);\r\n      };\r\n    })(this);\r\n    createInput();\r\n    this.el.on('click mousedown', 'input[type=file]', function(e) {\r\n      return e.stopPropagation();\r\n    });\r\n    return this.el.on('change', 'input[type=file]', (function(_this) {\r\n      return function(e) {\r\n        _this.editor.uploader.upload(_this.input, {\r\n          inline: true,\r\n          img: _this.target\r\n        });\r\n        return createInput();\r\n      };\r\n    })(this));\r\n  };\r\n\r\n  ImagePopover.prototype._resizeImg = function(inputEl, onlySetVal) {\r\n    var height, value, width;\r\n    if (onlySetVal == null) {\r\n      onlySetVal = false;\r\n    }\r\n    value = inputEl.val() * 1;\r\n    if (!(this.target && (langx.isNumber(value) || value < 0))) {\r\n      return;\r\n    }\r\n    if (inputEl.is(this.widthEl)) {\r\n      width = value;\r\n      height = this.height * value / this.width;\r\n      this.heightEl.val(height);\r\n    } else {\r\n      height = value;\r\n      width = this.width * value / this.height;\r\n      this.widthEl.val(width);\r\n    }\r\n    if (!onlySetVal) {\r\n      this.target.attr({\r\n        width: width,\r\n        height: height\r\n      });\r\n      return this.editor.trigger('valuechanged');\r\n    }\r\n  };\r\n\r\n  ImagePopover.prototype._restoreImg = function() {\r\n    var ref, size;\r\n    size = ((ref = this.target.data('image-size')) != null ? ref.split(\",\") : void 0) || [this.width, this.height];\r\n    this.target.attr({\r\n      width: size[0] * 1,\r\n      height: size[1] * 1\r\n    });\r\n    this.widthEl.val(size[0]);\r\n    this.heightEl.val(size[1]);\r\n    return this.editor.trigger('valuechanged');\r\n  };\r\n\r\n  ImagePopover.prototype._loadImage = function(src, callback) {\r\n    if (/^data:image/.test(src) && !this.editor.uploader) {\r\n      if (callback) {\r\n        callback(false);\r\n      }\r\n      return;\r\n    }\r\n    if (this.target.attr('src') === src) {\r\n      return;\r\n    }\r\n    return this.button.loadImage(this.target, src, (function(_this) {\r\n      return function(img) {\r\n        var blob;\r\n        if (!img) {\r\n          return;\r\n        }\r\n        if (_this.active) {\r\n          _this.width = img.width;\r\n          _this.height = img.height;\r\n          _this.widthEl.val(_this.width);\r\n          _this.heightEl.val(_this.height);\r\n        }\r\n        if (/^data:image/.test(src)) {\r\n          blob = _this.editor.util.dataURLtoBlob(src);\r\n          blob.name = \"Base64 Image.png\";\r\n          _this.editor.uploader.upload(blob, {\r\n            inline: true,\r\n            img: _this.target\r\n          });\r\n        } else {\r\n          _this.editor.trigger('valuechanged');\r\n        }\r\n        if (callback) {\r\n          return callback(img);\r\n        }\r\n      };\r\n    })(this));\r\n  };\r\n\r\n  ImagePopover.prototype.show = function() {\r\n    var $img, args;\r\n    args = 1 <= arguments.length ? Array.prototype.slice.call(arguments, 0) : [];\r\n    Popover.prototype.show.apply(this, args);\r\n    $img = this.target;\r\n    this.width = $img.width();\r\n    this.height = $img.height();\r\n    this.alt = $img.attr('alt');\r\n    if ($img.hasClass('uploading')) {\r\n      return this.srcEl.val(this._t('uploading')).prop('disabled', true);\r\n    } else {\r\n      this.srcEl.val($img.attr('src')).prop('disabled', false);\r\n      this.widthEl.val(this.width);\r\n      this.heightEl.val(this.height);\r\n      return this.altEl.val(this.alt);\r\n    }\r\n  };\r\n\r\n  return ImagePopover;\r\n\r\n});"]}