{"version":3,"sources":["Keystroke.js"],"names":["define","$","extend","Module","Keystroke","inherit","pluginName","prototype","_init","this","editor","_module","_keystrokeHandlers","_initKeystrokeHandlers","add","key","node","handler","toLowerCase","hotkeys","constructor","aliases","respondTo","e","base","ref","result","_this","keyNameMap","which","selection","startNodes","each","i","ref1","nodeType","Node","ELEMENT_NODE","tagName","titleEnterHandler","util","browser","safari","$blockEl","$br","shiftKey","blockNodes","last","is","rangeAtEndOf","insertNode","setRangeBefore","webkit","msie","$node","$p","append","phBr","insertAfter","setRangeAtStartOf","$prevBlockEl","$rootBlock","rootNodes","first","prev","rangeAtStartOf","save","remove","restore","preventDefault","setRangeAtEndOf","isEmptyNode","formatter","cleanNode","$cloneNode","listEl","newBlockEl","newListEl","clone","find","parent","next","length","nextAll","after","contents","children","breakNode","range","deleteContents","document","createTextNode","setEnd","collapse","$closestBlock","createRange","$childList","$newLi","$prevChildList","$prevNode","$textNode","isFF","text","n","test","nodeName","nodeValue","firefox","appendTo","$newNode","codeStr","html","replace","$firstChild","unwrap"],"mappings":"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","file":"../Keystroke.js","sourcesContent":["define([\r\n  \"skylark-jquery\",\r\n  \"./_extend\",\r\n  \"./Module\"\r\n],function($,extend,Module){ \r\n\r\n  var Keystroke = Module.inherit({\r\n\r\n  });\r\n\r\n\r\n  Keystroke.pluginName = 'Keystroke';\r\n\r\n  Keystroke.prototype._init = function() {\r\n    this.editor = this._module;\r\n    this._keystrokeHandlers = {};\r\n    return this._initKeystrokeHandlers();\r\n  };\r\n\r\n  Keystroke.prototype.add = function(key, node, handler) {\r\n    key = key.toLowerCase();\r\n    key = this.editor.hotkeys.constructor.aliases[key] || key;\r\n    if (!this._keystrokeHandlers[key]) {\r\n      this._keystrokeHandlers[key] = {};\r\n    }\r\n    return this._keystrokeHandlers[key][node] = handler;\r\n  };\r\n\r\n  Keystroke.prototype.respondTo = function(e) {\r\n    var base, key, ref, result;\r\n    key = (ref = this.editor.hotkeys.constructor.keyNameMap[e.which]) != null ? ref.toLowerCase() : void 0;\r\n    if (!key) {\r\n      return;\r\n    }\r\n    if (key in this._keystrokeHandlers) {\r\n      result = typeof (base = this._keystrokeHandlers[key])['*'] === \"function\" ? base['*'](e) : void 0;\r\n      if (!result) {\r\n        this.editor.selection.startNodes().each((function(_this) {\r\n          return function(i, node) {\r\n            var handler, ref1;\r\n            if (node.nodeType !== Node.ELEMENT_NODE) {\r\n              return;\r\n            }\r\n            handler = (ref1 = _this._keystrokeHandlers[key]) != null ? ref1[node.tagName.toLowerCase()] : void 0;\r\n            result = typeof handler === \"function\" ? handler(e, $(node)) : void 0;\r\n            if (result === true || result === false) {\r\n              return false;\r\n            }\r\n          };\r\n        })(this));\r\n      }\r\n      if (result) {\r\n        return true;\r\n      }\r\n    }\r\n  };\r\n\r\n  Keystroke.prototype._initKeystrokeHandlers = function() {\r\n    var titleEnterHandler;\r\n    if (this.editor.util.browser.safari) {\r\n      this.add('enter', '*', (function(_this) {\r\n        return function(e) {\r\n          var $blockEl, $br;\r\n          if (!e.shiftKey) {\r\n            return;\r\n          }\r\n          $blockEl = _this.editor.selection.blockNodes().last();\r\n          if ($blockEl.is('pre')) {\r\n            return;\r\n          }\r\n          $br = $('<br/>');\r\n          if (_this.editor.selection.rangeAtEndOf($blockEl)) {\r\n            _this.editor.selection.insertNode($br);\r\n            _this.editor.selection.insertNode($('<br/>'));\r\n            _this.editor.selection.setRangeBefore($br);\r\n          } else {\r\n            _this.editor.selection.insertNode($br);\r\n          }\r\n          return true;\r\n        };\r\n      })(this));\r\n    }\r\n    if (this.editor.util.browser.webkit || this.editor.util.browser.msie) {\r\n      titleEnterHandler = (function(_this) {\r\n        return function(e, $node) {\r\n          var $p;\r\n          if (!_this.editor.selection.rangeAtEndOf($node)) {\r\n            return;\r\n          }\r\n          $p = $('<p/>').append(_this.editor.util.phBr).insertAfter($node);\r\n          _this.editor.selection.setRangeAtStartOf($p);\r\n          return true;\r\n        };\r\n      })(this);\r\n      this.add('enter', 'h1', titleEnterHandler);\r\n      this.add('enter', 'h2', titleEnterHandler);\r\n      this.add('enter', 'h3', titleEnterHandler);\r\n      this.add('enter', 'h4', titleEnterHandler);\r\n      this.add('enter', 'h5', titleEnterHandler);\r\n      this.add('enter', 'h6', titleEnterHandler);\r\n    }\r\n    this.add('backspace', '*', (function(_this) {\r\n      return function(e) {\r\n        var $blockEl, $prevBlockEl, $rootBlock, isWebkit;\r\n        $rootBlock = _this.editor.selection.rootNodes().first();\r\n        $prevBlockEl = $rootBlock.prev();\r\n        if ($prevBlockEl.is('hr') && _this.editor.selection.rangeAtStartOf($rootBlock)) {\r\n          _this.editor.selection.save();\r\n          $prevBlockEl.remove();\r\n          _this.editor.selection.restore();\r\n          return true;\r\n        }\r\n        $blockEl = _this.editor.selection.blockNodes().last();\r\n        if ($blockEl.is('.simditor-resize-handle') && $rootBlock.is('.simditor-table')) {\r\n          e.preventDefault();\r\n          $rootBlock.remove();\r\n          _this.editor.selection.setRangeAtEndOf($prevBlockEl);\r\n        }\r\n        if ($prevBlockEl.is('.simditor-table') && !$blockEl.is('table') && _this.editor.util.isEmptyNode($blockEl)) {\r\n          e.preventDefault();\r\n          $blockEl.remove();\r\n          _this.editor.selection.setRangeAtEndOf($prevBlockEl);\r\n        }\r\n        isWebkit = _this.editor.util.browser.webkit;\r\n        if (isWebkit && _this.editor.selection.rangeAtStartOf($blockEl)) {\r\n          _this.editor.selection.save();\r\n          _this.editor.formatter.cleanNode($blockEl, true);\r\n          _this.editor.selection.restore();\r\n          return null;\r\n        }\r\n      };\r\n    })(this));\r\n    this.add('enter', 'div', (function(_this) {\r\n      return function(e, $node) {\r\n        var $blockEl, $p;\r\n        if ($node.is('.simditor-table')) {\r\n          $blockEl = _this.editor.selection.blockNodes().last();\r\n          if ($blockEl.is('.simditor-resize-handle')) {\r\n            e.preventDefault();\r\n            $p = $('<p/>').append(_this.editor.util.phBr).insertAfter($node);\r\n            return _this.editor.selection.setRangeAtStartOf($p);\r\n          }\r\n        }\r\n      };\r\n    })(this));\r\n    this.add('enter', 'li', (function(_this) {\r\n      return function(e, $node) {\r\n        var $cloneNode, listEl, newBlockEl, newListEl;\r\n        $cloneNode = $node.clone();\r\n        $cloneNode.find('ul, ol').remove();\r\n        if (!(_this.editor.util.isEmptyNode($cloneNode) && $node.is(_this.editor.selection.blockNodes().last()))) {\r\n          return;\r\n        }\r\n        listEl = $node.parent();  \r\n        if ($node.next('li').length > 0) {\r\n          if (!_this.editor.util.isEmptyNode($node)) {\r\n            return;\r\n          }\r\n          if (listEl.parent('li').length > 0) {\r\n            newBlockEl = $('<li/>').append(_this.editor.util.phBr).insertAfter(listEl.parent('li'));\r\n            newListEl = $('<' + listEl[0].tagName + '/>').append($node.nextAll('li'));\r\n            newBlockEl.append(newListEl);\r\n          } else {\r\n            newBlockEl = $('<p/>').append(_this.editor.util.phBr).insertAfter(listEl);\r\n            newListEl = $('<' + listEl[0].tagName + '/>').append($node.nextAll('li'));\r\n            newBlockEl.after(newListEl);\r\n          }\r\n        } else {\r\n          if (listEl.parent('li').length > 0) {\r\n            newBlockEl = $('<li/>').insertAfter(listEl.parent('li'));\r\n            if ($node.contents().length > 0) {\r\n              newBlockEl.append($node.contents());\r\n            } else {\r\n              newBlockEl.append(_this.editor.util.phBr);\r\n            }\r\n          } else {\r\n            newBlockEl = $('<p/>').append(_this.editor.util.phBr).insertAfter(listEl);\r\n            if ($node.children('ul, ol').length > 0) {\r\n              newBlockEl.after($node.children('ul, ol'));\r\n            }\r\n          }\r\n        }\r\n        if ($node.prev('li').length) {\r\n          $node.remove();\r\n        } else {\r\n          if ($node.prev('ul').length || $node.prev('ol').length) {\r\n            $node.remove();\r\n          } else {\r\n            listEl.remove();\r\n          }\r\n        }\r\n        _this.editor.selection.setRangeAtStartOf(newBlockEl);\r\n        return true;\r\n      };\r\n    })(this));\r\n    this.add('enter', 'pre', (function(_this) {\r\n      return function(e, $node) {\r\n        var $p, breakNode, range;\r\n        e.preventDefault();\r\n        if (e.shiftKey) {\r\n          $p = $('<p/>').append(_this.editor.util.phBr).insertAfter($node);\r\n          _this.editor.selection.setRangeAtStartOf($p);\r\n          return true;\r\n        }\r\n        range = _this.editor.selection.range();\r\n        breakNode = null;\r\n        range.deleteContents();\r\n        if (!_this.editor.util.browser.msie && _this.editor.selection.rangeAtEndOf($node)) {\r\n          breakNode = document.createTextNode('\\n\\n');\r\n        } else {\r\n          breakNode = document.createTextNode('\\n');\r\n        }\r\n        range.insertNode(breakNode);\r\n        range.setEnd(breakNode, 1);\r\n        range.collapse(false);\r\n        _this.editor.selection.range(range);\r\n        return true;\r\n      };\r\n    })(this));\r\n    this.add('enter', 'blockquote', (function(_this) {\r\n      return function(e, $node) {\r\n        var $closestBlock, range;\r\n        $closestBlock = _this.editor.selection.blockNodes().last();\r\n        if (!($closestBlock.is('p') && !$closestBlock.next().length && _this.editor.util.isEmptyNode($closestBlock))) {\r\n          return;\r\n        }\r\n        $node.after($closestBlock);\r\n        range = document.createRange();\r\n        _this.editor.selection.setRangeAtStartOf($closestBlock, range);\r\n        return true;\r\n      };\r\n    })(this));\r\n    this.add('backspace', 'li', (function(_this) {\r\n      return function(e, $node) {\r\n        var $br, $childList, $newLi, $prevChildList, $prevNode, $textNode, isFF, range, text;\r\n        $childList = $node.children('ul, ol');\r\n        $prevNode = $node.prev('li');\r\n        if (!($childList.length > 0 && $prevNode.length > 0)) {\r\n          return false;\r\n        }\r\n        text = '';\r\n        $textNode = null;\r\n        $node.contents().each(function(i, n) {\r\n          if (n.nodeType === 1 && /UL|OL/.test(n.nodeName)) {\r\n            return false;\r\n          }\r\n          if (n.nodeType === 1 && /BR/.test(n.nodeName)) {\r\n            return;\r\n          }\r\n          if (n.nodeType === 3 && n.nodeValue) {\r\n            text += n.nodeValue;\r\n          } else if (n.nodeType === 1) {\r\n            text += $(n).text();\r\n          }\r\n          return $textNode = $(n);\r\n        });\r\n        isFF = _this.editor.util.browser.firefox && !$textNode.next('br').length;\r\n        if ($textNode && text.length === 1 && isFF) {\r\n          $br = $(_this.editor.util.phBr).insertAfter($textNode);\r\n          $textNode.remove();\r\n          _this.editor.selection.setRangeBefore($br);\r\n          return true;\r\n        } else if (text.length > 0) {\r\n          return false;\r\n        }\r\n        range = document.createRange();\r\n        $prevChildList = $prevNode.children('ul, ol');\r\n        if ($prevChildList.length > 0) {\r\n          $newLi = $('<li/>').append(_this.editor.util.phBr).appendTo($prevChildList);\r\n          $prevChildList.append($childList.children('li'));\r\n          $node.remove();\r\n          _this.editor.selection.setRangeAtEndOf($newLi, range);\r\n        } else {\r\n          _this.editor.selection.setRangeAtEndOf($prevNode, range);\r\n          $prevNode.append($childList);\r\n          $node.remove();\r\n          _this.editor.selection.range(range);\r\n        }\r\n        return true;\r\n      };\r\n    })(this));\r\n    this.add('backspace', 'pre', (function(_this) {\r\n      return function(e, $node) {\r\n        var $newNode, codeStr, range;\r\n        if (!_this.editor.selection.rangeAtStartOf($node)) {\r\n          return;\r\n        }\r\n        codeStr = $node.html().replace('\\n', '<br/>') || _this.editor.util.phBr;\r\n        $newNode = $('<p/>').append(codeStr).insertAfter($node);\r\n        $node.remove();\r\n        range = document.createRange();\r\n        _this.editor.selection.setRangeAtStartOf($newNode, range);\r\n        return true;\r\n      };\r\n    })(this));\r\n    return this.add('backspace', 'blockquote', (function(_this) {\r\n      return function(e, $node) {\r\n        var $firstChild, range;\r\n        if (!_this.editor.selection.rangeAtStartOf($node)) {\r\n          return;\r\n        }\r\n        $firstChild = $node.children().first().unwrap();\r\n        range = document.createRange();\r\n        _this.editor.selection.setRangeAtStartOf($firstChild, range);\r\n        return true;\r\n      };\r\n    })(this));\r\n  };\r\n\r\n  return Keystroke;\r\n\r\n});\r\n"]}