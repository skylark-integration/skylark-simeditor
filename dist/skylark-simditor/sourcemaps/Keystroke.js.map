{"version":3,"sources":["Keystroke.js"],"names":["define","langx","$","Keystroke","Evented","inherit","init","editor","this","_keystrokeHandlers","_initKeystrokeHandlers","pluginName","prototype","add","key","node","handler","toLowerCase","hotkeys","constructor","aliases","respondTo","e","base","ref","result","_this","keyNameMap","which","selection","startNodes","each","i","ref1","nodeType","Node","ELEMENT_NODE","tagName","titleEnterHandler","util","browser","safari","$blockEl","$br","shiftKey","blockNodes","last","is","rangeAtEndOf","insertNode","setRangeBefore","webkit","msie","$node","$p","append","phBr","insertAfter","setRangeAtStartOf","$prevBlockEl","$rootBlock","rootNodes","first","prev","rangeAtStartOf","save","remove","restore","preventDefault","setRangeAtEndOf","isEmptyNode","formatter","cleanNode","$cloneNode","listEl","newBlockEl","newListEl","clone","find","parent","next","length","nextAll","after","contents","children","breakNode","range","deleteContents","document","createTextNode","setEnd","collapse","$closestBlock","createRange","$childList","$newLi","$prevChildList","$prevNode","$textNode","isFF","text","n","test","nodeName","nodeValue","firefox","appendTo","$newNode","codeStr","html","replace","$firstChild","unwrap"],"mappings":"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","file":"../Keystroke.js","sourcesContent":["define([\r\n  \"skylark-langx/langx\",\r\n  \"skylark-jquery\"\r\n],function(langx,$){ \r\n\r\n\r\n  var Keystroke = langx.Evented.inherit({\r\n    init : function(editor) {\r\n      this.editor = editor; //this._module;\r\n      this._keystrokeHandlers = {};\r\n      this._initKeystrokeHandlers();\r\n    }\r\n  });\r\n\r\n\r\n  Keystroke.pluginName = 'Keystroke';\r\n\r\n\r\n\r\n  Keystroke.prototype.add = function(key, node, handler) {\r\n    key = key.toLowerCase();\r\n    key = this.editor.hotkeys.constructor.aliases[key] || key;\r\n    if (!this._keystrokeHandlers[key]) {\r\n      this._keystrokeHandlers[key] = {};\r\n    }\r\n    return this._keystrokeHandlers[key][node] = handler;\r\n  };\r\n\r\n  Keystroke.prototype.respondTo = function(e) {\r\n    var base, key, ref, result;\r\n    key = (ref = this.editor.hotkeys.constructor.keyNameMap[e.which]) != null ? ref.toLowerCase() : void 0;\r\n    if (!key) {\r\n      return;\r\n    }\r\n    if (key in this._keystrokeHandlers) {\r\n      result = typeof (base = this._keystrokeHandlers[key])['*'] === \"function\" ? base['*'](e) : void 0;\r\n      if (!result) {\r\n        this.editor.selection.startNodes().each((function(_this) {\r\n          return function(i, node) {\r\n            var handler, ref1;\r\n            if (node.nodeType !== Node.ELEMENT_NODE) {\r\n              return;\r\n            }\r\n            handler = (ref1 = _this._keystrokeHandlers[key]) != null ? ref1[node.tagName.toLowerCase()] : void 0;\r\n            result = typeof handler === \"function\" ? handler(e, $(node)) : void 0;\r\n            if (result === true || result === false) {\r\n              return false;\r\n            }\r\n          };\r\n        })(this));\r\n      }\r\n      if (result) {\r\n        return true;\r\n      }\r\n    }\r\n  };\r\n\r\n  Keystroke.prototype._initKeystrokeHandlers = function() {\r\n    var titleEnterHandler;\r\n    if (this.editor.util.browser.safari) {\r\n      this.add('enter', '*', (function(_this) {\r\n        return function(e) {\r\n          var $blockEl, $br;\r\n          if (!e.shiftKey) {\r\n            return;\r\n          }\r\n          $blockEl = _this.editor.selection.blockNodes().last();\r\n          if ($blockEl.is('pre')) {\r\n            return;\r\n          }\r\n          $br = $('<br/>');\r\n          if (_this.editor.selection.rangeAtEndOf($blockEl)) {\r\n            _this.editor.selection.insertNode($br);\r\n            _this.editor.selection.insertNode($('<br/>'));\r\n            _this.editor.selection.setRangeBefore($br);\r\n          } else {\r\n            _this.editor.selection.insertNode($br);\r\n          }\r\n          return true;\r\n        };\r\n      })(this));\r\n    }\r\n    if (this.editor.util.browser.webkit || this.editor.util.browser.msie) {\r\n      titleEnterHandler = (function(_this) {\r\n        return function(e, $node) {\r\n          var $p;\r\n          if (!_this.editor.selection.rangeAtEndOf($node)) {\r\n            return;\r\n          }\r\n          $p = $('<p/>').append(_this.editor.util.phBr).insertAfter($node);\r\n          _this.editor.selection.setRangeAtStartOf($p);\r\n          return true;\r\n        };\r\n      })(this);\r\n      this.add('enter', 'h1', titleEnterHandler);\r\n      this.add('enter', 'h2', titleEnterHandler);\r\n      this.add('enter', 'h3', titleEnterHandler);\r\n      this.add('enter', 'h4', titleEnterHandler);\r\n      this.add('enter', 'h5', titleEnterHandler);\r\n      this.add('enter', 'h6', titleEnterHandler);\r\n    }\r\n    this.add('backspace', '*', (function(_this) {\r\n      return function(e) {\r\n        var $blockEl, $prevBlockEl, $rootBlock, isWebkit;\r\n        $rootBlock = _this.editor.selection.rootNodes().first();\r\n        $prevBlockEl = $rootBlock.prev();\r\n        if ($prevBlockEl.is('hr') && _this.editor.selection.rangeAtStartOf($rootBlock)) {\r\n          _this.editor.selection.save();\r\n          $prevBlockEl.remove();\r\n          _this.editor.selection.restore();\r\n          return true;\r\n        }\r\n        $blockEl = _this.editor.selection.blockNodes().last();\r\n        if ($blockEl.is('.simditor-resize-handle') && $rootBlock.is('.simditor-table')) {\r\n          e.preventDefault();\r\n          $rootBlock.remove();\r\n          _this.editor.selection.setRangeAtEndOf($prevBlockEl);\r\n        }\r\n        if ($prevBlockEl.is('.simditor-table') && !$blockEl.is('table') && _this.editor.util.isEmptyNode($blockEl)) {\r\n          e.preventDefault();\r\n          $blockEl.remove();\r\n          _this.editor.selection.setRangeAtEndOf($prevBlockEl);\r\n        }\r\n        isWebkit = _this.editor.util.browser.webkit;\r\n        if (isWebkit && _this.editor.selection.rangeAtStartOf($blockEl)) {\r\n          _this.editor.selection.save();\r\n          _this.editor.formatter.cleanNode($blockEl, true);\r\n          _this.editor.selection.restore();\r\n          return null;\r\n        }\r\n      };\r\n    })(this));\r\n    this.add('enter', 'div', (function(_this) {\r\n      return function(e, $node) {\r\n        var $blockEl, $p;\r\n        if ($node.is('.simditor-table')) {\r\n          $blockEl = _this.editor.selection.blockNodes().last();\r\n          if ($blockEl.is('.simditor-resize-handle')) {\r\n            e.preventDefault();\r\n            $p = $('<p/>').append(_this.editor.util.phBr).insertAfter($node);\r\n            return _this.editor.selection.setRangeAtStartOf($p);\r\n          }\r\n        }\r\n      };\r\n    })(this));\r\n    this.add('enter', 'li', (function(_this) {\r\n      return function(e, $node) {\r\n        var $cloneNode, listEl, newBlockEl, newListEl;\r\n        $cloneNode = $node.clone();\r\n        $cloneNode.find('ul, ol').remove();\r\n        if (!(_this.editor.util.isEmptyNode($cloneNode) && $node.is(_this.editor.selection.blockNodes().last()))) {\r\n          return;\r\n        }\r\n        listEl = $node.parent();  \r\n        if ($node.next('li').length > 0) {\r\n          if (!_this.editor.util.isEmptyNode($node)) {\r\n            return;\r\n          }\r\n          if (listEl.parent('li').length > 0) {\r\n            newBlockEl = $('<li/>').append(_this.editor.util.phBr).insertAfter(listEl.parent('li'));\r\n            newListEl = $('<' + listEl[0].tagName + '/>').append($node.nextAll('li'));\r\n            newBlockEl.append(newListEl);\r\n          } else {\r\n            newBlockEl = $('<p/>').append(_this.editor.util.phBr).insertAfter(listEl);\r\n            newListEl = $('<' + listEl[0].tagName + '/>').append($node.nextAll('li'));\r\n            newBlockEl.after(newListEl);\r\n          }\r\n        } else {\r\n          if (listEl.parent('li').length > 0) {\r\n            newBlockEl = $('<li/>').insertAfter(listEl.parent('li'));\r\n            if ($node.contents().length > 0) {\r\n              newBlockEl.append($node.contents());\r\n            } else {\r\n              newBlockEl.append(_this.editor.util.phBr);\r\n            }\r\n          } else {\r\n            newBlockEl = $('<p/>').append(_this.editor.util.phBr).insertAfter(listEl);\r\n            if ($node.children('ul, ol').length > 0) {\r\n              newBlockEl.after($node.children('ul, ol'));\r\n            }\r\n          }\r\n        }\r\n        if ($node.prev('li').length) {\r\n          $node.remove();\r\n        } else {\r\n          if ($node.prev('ul').length || $node.prev('ol').length) {\r\n            $node.remove();\r\n          } else {\r\n            listEl.remove();\r\n          }\r\n        }\r\n        _this.editor.selection.setRangeAtStartOf(newBlockEl);\r\n        return true;\r\n      };\r\n    })(this));\r\n    this.add('enter', 'pre', (function(_this) {\r\n      return function(e, $node) {\r\n        var $p, breakNode, range;\r\n        e.preventDefault();\r\n        if (e.shiftKey) {\r\n          $p = $('<p/>').append(_this.editor.util.phBr).insertAfter($node);\r\n          _this.editor.selection.setRangeAtStartOf($p);\r\n          return true;\r\n        }\r\n        range = _this.editor.selection.range();\r\n        breakNode = null;\r\n        range.deleteContents();\r\n        if (!_this.editor.util.browser.msie && _this.editor.selection.rangeAtEndOf($node)) {\r\n          breakNode = document.createTextNode('\\n\\n');\r\n        } else {\r\n          breakNode = document.createTextNode('\\n');\r\n        }\r\n        range.insertNode(breakNode);\r\n        range.setEnd(breakNode, 1);\r\n        range.collapse(false);\r\n        _this.editor.selection.range(range);\r\n        return true;\r\n      };\r\n    })(this));\r\n    this.add('enter', 'blockquote', (function(_this) {\r\n      return function(e, $node) {\r\n        var $closestBlock, range;\r\n        $closestBlock = _this.editor.selection.blockNodes().last();\r\n        if (!($closestBlock.is('p') && !$closestBlock.next().length && _this.editor.util.isEmptyNode($closestBlock))) {\r\n          return;\r\n        }\r\n        $node.after($closestBlock);\r\n        range = document.createRange();\r\n        _this.editor.selection.setRangeAtStartOf($closestBlock, range);\r\n        return true;\r\n      };\r\n    })(this));\r\n    this.add('backspace', 'li', (function(_this) {\r\n      return function(e, $node) {\r\n        var $br, $childList, $newLi, $prevChildList, $prevNode, $textNode, isFF, range, text;\r\n        $childList = $node.children('ul, ol');\r\n        $prevNode = $node.prev('li');\r\n        if (!($childList.length > 0 && $prevNode.length > 0)) {\r\n          return false;\r\n        }\r\n        text = '';\r\n        $textNode = null;\r\n        $node.contents().each(function(i, n) {\r\n          if (n.nodeType === 1 && /UL|OL/.test(n.nodeName)) {\r\n            return false;\r\n          }\r\n          if (n.nodeType === 1 && /BR/.test(n.nodeName)) {\r\n            return;\r\n          }\r\n          if (n.nodeType === 3 && n.nodeValue) {\r\n            text += n.nodeValue;\r\n          } else if (n.nodeType === 1) {\r\n            text += $(n).text();\r\n          }\r\n          return $textNode = $(n);\r\n        });\r\n        isFF = _this.editor.util.browser.firefox && !$textNode.next('br').length;\r\n        if ($textNode && text.length === 1 && isFF) {\r\n          $br = $(_this.editor.util.phBr).insertAfter($textNode);\r\n          $textNode.remove();\r\n          _this.editor.selection.setRangeBefore($br);\r\n          return true;\r\n        } else if (text.length > 0) {\r\n          return false;\r\n        }\r\n        range = document.createRange();\r\n        $prevChildList = $prevNode.children('ul, ol');\r\n        if ($prevChildList.length > 0) {\r\n          $newLi = $('<li/>').append(_this.editor.util.phBr).appendTo($prevChildList);\r\n          $prevChildList.append($childList.children('li'));\r\n          $node.remove();\r\n          _this.editor.selection.setRangeAtEndOf($newLi, range);\r\n        } else {\r\n          _this.editor.selection.setRangeAtEndOf($prevNode, range);\r\n          $prevNode.append($childList);\r\n          $node.remove();\r\n          _this.editor.selection.range(range);\r\n        }\r\n        return true;\r\n      };\r\n    })(this));\r\n    this.add('backspace', 'pre', (function(_this) {\r\n      return function(e, $node) {\r\n        var $newNode, codeStr, range;\r\n        if (!_this.editor.selection.rangeAtStartOf($node)) {\r\n          return;\r\n        }\r\n        codeStr = $node.html().replace('\\n', '<br/>') || _this.editor.util.phBr;\r\n        $newNode = $('<p/>').append(codeStr).insertAfter($node);\r\n        $node.remove();\r\n        range = document.createRange();\r\n        _this.editor.selection.setRangeAtStartOf($newNode, range);\r\n        return true;\r\n      };\r\n    })(this));\r\n    return this.add('backspace', 'blockquote', (function(_this) {\r\n      return function(e, $node) {\r\n        var $firstChild, range;\r\n        if (!_this.editor.selection.rangeAtStartOf($node)) {\r\n          return;\r\n        }\r\n        $firstChild = $node.children().first().unwrap();\r\n        range = document.createRange();\r\n        _this.editor.selection.setRangeAtStartOf($firstChild, range);\r\n        return true;\r\n      };\r\n    })(this));\r\n  };\r\n\r\n  return Keystroke;\r\n\r\n});\r\n"]}