/**
 * skylark-simditor - A version of simditor.js that ported to running on skylarkjs
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylark-integration/skylark-simditor/
 * @license MIT
 */
define(["skylark-langx/langx","skylark-utils-dom/query"],function(t,e){var i=t.Evented.inherit({});return i.pluginName="Clipboard",i.prototype.opts={pasteImage:!1,cleanPaste:!1},i.prototype.init=function(t){var e;this.editor=t,this.opts.pasteImage&&"string"!=typeof this.opts.pasteImage&&(this.opts.pasteImage="inline"),this.editor.body.on("paste",(e=this,function(t){var i;if(!e.pasting&&!e._pasteBin)return!1!==e.editor.triggerHandler(t)&&(i=e.editor.selection.deleteRangeContents(),e.editor.body.html()?i.collapsed||i.collapse(!0):(e.editor.formatter.format(),e.editor.selection.setRangeAtStartOf(e.editor.body.find("p:first"))),!e._processPasteByClipboardApi(t)&&(e.editor.inputManager.throttledValueChanged.clear(),e.editor.inputManager.throttledSelectionChanged.clear(),e.editor.undoManager.throttledPushState.clear(),e.editor.selection.reset(),e.editor.undoManager.resetCaretPosition(),e.pasting=!0,e._getPasteContent(function(t){return e._processPasteContent(t),e._pasteInBlockEl=null,e._pastePlainText=null,e.pasting=!1})))}))},i.prototype._processPasteByClipboardApi=function(t){var e,i,o,r;if(!this.editor.util.browser.edge&&t.originalEvent.clipboardData&&t.originalEvent.clipboardData.items&&t.originalEvent.clipboardData.items.length>0&&(i=t.originalEvent.clipboardData.items[0],/^image\//.test(i.type))){if(null==(e=i.getAsFile())||!this.opts.pasteImage)return;if(e.name||(e.name="Clipboard Image.png"),!1===this.editor.triggerHandler("pasting",[e]))return;return(r={})[this.opts.pasteImage]=!0,null!=(o=this.editor.uploader)&&o.upload(e,r),!0}},i.prototype._getPasteContent=function(t){var i,o;return this._pasteBin=e('<div contenteditable="true" />').addClass("simditor-paste-bin").attr("tabIndex","-1").appendTo(this.editor.el),i={html:this.editor.body.html(),caret:this.editor.undoManager.caretPosition()},this._pasteBin.focus(),setTimeout((o=this,function(){var r;return o.editor.hidePopover(),o.editor.body.get(0).innerHTML=i.html,o.editor.undoManager.caretPosition(i.caret),o.editor.body.focus(),o.editor.selection.reset(),o.editor.selection.range(),o._pasteInBlockEl=o.editor.selection.blockNodes().last(),o._pastePlainText=o.opts.cleanPaste||o._pasteInBlockEl.is("pre, table"),o._pastePlainText?r=o.editor.formatter.clearHtml(o._pasteBin.html(),!0):((r=e("<div/>").append(o._pasteBin.contents())).find("style").remove(),r.find("table colgroup").remove(),o._cleanPasteFontSize(r),o.editor.formatter.format(r),o.editor.formatter.decorate(r),o.editor.formatter.beautify(r.children()),r=r.contents()),o._pasteBin.remove(),o._pasteBin=null,t(r)}),0)},i.prototype._processPasteContent=function(t){var i,o,r,n,s,a,l,d,p,c,g,h,f,u,m,b,v,y,_,I,E,P,C,B,x,k;if(!1!==this.editor.triggerHandler("pasting",[t])&&(i=this._pasteInBlockEl,t)){if(this._pastePlainText)if(i.is("table")){for(c=(v=t.split("\n")).pop(),d=0,g=v.length;d<g;d++)b=v[d],this.editor.selection.insertNode(document.createTextNode(b)),this.editor.selection.insertNode(e("<br/>"));this.editor.selection.insertNode(document.createTextNode(c))}else for(p=0,h=(P=(t=e("<div/>").text(t)).contents()).length;p<h;p++)_=P[p],this.editor.selection.insertNode(e(_)[0]);else if(i.is(this.editor.body))for(y=0,f=t.length;y<f;y++)_=t[y],this.editor.selection.insertNode(_);else{if(t.length<1)return;if(1===t.length)if(t.is("p")){if(n=t.contents(),i.is("h1, h2, h3, h4, h5")&&n.length&&n.css("font-size",""),1===n.length&&n.is("img")){if(/^data:image/.test((o=n).attr("src"))){if(!this.opts.pasteImage)return;return(r=this.editor.util.dataURLtoBlob(o.attr("src"))).name="Clipboard Image.png",(x={})[this.opts.pasteImage]=!0,void(null!=(C=this.editor.uploader)&&C.upload(r,x))}if(new RegExp("^blob:"+location.origin+"/").test(o.attr("src"))){if(!this.opts.pasteImage)return;return(x={})[this.opts.pasteImage]=!0,s=this.editor.util.dataURLtoBlob,k=this.editor.uploader,(a=new Image).onload=function(){var t;(t=document.createElement("canvas")).width=a.naturalWidth,t.height=a.naturalHeight,t.getContext("2d").drawImage(a,0,0),(r=s(t.toDataURL("image/png"))).name="Clipboard Image.png",null!==k&&k.upload(r,x)},void(a.src=o.attr("src"))}if(o.is('img[src^="webkit-fake-url://"]'))return}for(I=0,u=n.length;I<u;I++)_=n[I],this.editor.selection.insertNode(_)}else if(i.is("p")&&this.editor.util.isEmptyNode(i))i.replaceWith(t),this.editor.selection.setRangeAtEndOf(t);else if(t.is("ul, ol"))if(1===t.find("li").length)for(E=0,m=(B=(t=e("<div/>").text(t.text())).contents()).length;E<m;E++)_=B[E],this.editor.selection.insertNode(e(_)[0]);else i.is("li")?(i.parent().after(t),this.editor.selection.setRangeAtEndOf(t)):(i.after(t),this.editor.selection.setRangeAtEndOf(t));else i.after(t),this.editor.selection.setRangeAtEndOf(t);else i.is("li")&&(i=i.parent()),this.editor.selection.rangeAtStartOf(i)?l="before":this.editor.selection.rangeAtEndOf(i)?l="after":(this.editor.selection.breakBlockEl(i),l="before"),i[l](t),this.editor.selection.setRangeAtEndOf(t.last())}return this.editor.inputManager.throttledValueChanged()}},i.prototype._cleanPasteFontSize=function(i){var o,r;if((o=e(i)).length>0)return r=["1.5em","1.25em","0.75em","0.5em"],o.find('[style*="font-size"]').map(function(i,o){var n;if(n=e(o),t.inArray(n.css("font-size"),r)<0)return n.css("font-size","")})},i});
//# sourceMappingURL=sourcemaps/Clipboard.js.map
