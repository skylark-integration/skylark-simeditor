/**
 * skylark-simditor - A version of simditor.js that ported to running on skylarkjs
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylark-integration/skylark-simditor/
 * @license MIT
 */
define(["skylark-jquery","./_extend","./Module"],function(t,e,i){var o=i.inherit({});return o.pluginName="Clipboard",o.prototype.opts={pasteImage:!1,cleanPaste:!1},o.prototype._init=function(){return this.editor=this._module,this.opts.pasteImage&&"string"!=typeof this.opts.pasteImage&&(this.opts.pasteImage="inline"),this.editor.body.on("paste",(t=this,function(e){var i;if(!t.pasting&&!t._pasteBin)return!1!==t.editor.triggerHandler(e)&&(i=t.editor.selection.deleteRangeContents(),t.editor.body.html()?i.collapsed||i.collapse(!0):(t.editor.formatter.format(),t.editor.selection.setRangeAtStartOf(t.editor.body.find("p:first"))),!t._processPasteByClipboardApi(e)&&(t.editor.inputManager.throttledValueChanged.clear(),t.editor.inputManager.throttledSelectionChanged.clear(),t.editor.undoManager.throttledPushState.clear(),t.editor.selection.reset(),t.editor.undoManager.resetCaretPosition(),t.pasting=!0,t._getPasteContent(function(e){return t._processPasteContent(e),t._pasteInBlockEl=null,t._pastePlainText=null,t.pasting=!1})))}));var t},o.prototype._processPasteByClipboardApi=function(t){var e,i,o,r;if(!this.editor.util.browser.edge&&t.originalEvent.clipboardData&&t.originalEvent.clipboardData.items&&t.originalEvent.clipboardData.items.length>0&&(i=t.originalEvent.clipboardData.items[0],/^image\//.test(i.type))){if(null==(e=i.getAsFile())||!this.opts.pasteImage)return;if(e.name||(e.name="Clipboard Image.png"),!1===this.editor.triggerHandler("pasting",[e]))return;return(r={})[this.opts.pasteImage]=!0,null!=(o=this.editor.uploader)&&o.upload(e,r),!0}},o.prototype._getPasteContent=function(e){var i,o;return this._pasteBin=t('<div contenteditable="true" />').addClass("simditor-paste-bin").attr("tabIndex","-1").appendTo(this.editor.el),i={html:this.editor.body.html(),caret:this.editor.undoManager.caretPosition()},this._pasteBin.focus(),setTimeout((o=this,function(){var r;return o.editor.hidePopover(),o.editor.body.get(0).innerHTML=i.html,o.editor.undoManager.caretPosition(i.caret),o.editor.body.focus(),o.editor.selection.reset(),o.editor.selection.range(),o._pasteInBlockEl=o.editor.selection.blockNodes().last(),o._pastePlainText=o.opts.cleanPaste||o._pasteInBlockEl.is("pre, table"),o._pastePlainText?r=o.editor.formatter.clearHtml(o._pasteBin.html(),!0):((r=t("<div/>").append(o._pasteBin.contents())).find("style").remove(),r.find("table colgroup").remove(),o._cleanPasteFontSize(r),o.editor.formatter.format(r),o.editor.formatter.decorate(r),o.editor.formatter.beautify(r.children()),r=r.contents()),o._pasteBin.remove(),o._pasteBin=null,e(r)}),0)},o.prototype._processPasteContent=function(e){var i,o,r,n,s,a,l,d,p,c,h,g,f,u,m,b,_,v,y,I,P,E,C,B,x,A;if(!1!==this.editor.triggerHandler("pasting",[e])&&(i=this._pasteInBlockEl,e)){if(this._pastePlainText)if(i.is("table")){for(c=(_=e.split("\n")).pop(),d=0,h=_.length;d<h;d++)b=_[d],this.editor.selection.insertNode(document.createTextNode(b)),this.editor.selection.insertNode(t("<br/>"));this.editor.selection.insertNode(document.createTextNode(c))}else for(p=0,g=(E=(e=t("<div/>").text(e)).contents()).length;p<g;p++)y=E[p],this.editor.selection.insertNode(t(y)[0]);else if(i.is(this.editor.body))for(v=0,f=e.length;v<f;v++)y=e[v],this.editor.selection.insertNode(y);else{if(e.length<1)return;if(1===e.length)if(e.is("p")){if(n=e.contents(),i.is("h1, h2, h3, h4, h5")&&n.length&&n.css("font-size",""),1===n.length&&n.is("img")){if(/^data:image/.test((o=n).attr("src"))){if(!this.opts.pasteImage)return;return(r=this.editor.util.dataURLtoBlob(o.attr("src"))).name="Clipboard Image.png",(x={})[this.opts.pasteImage]=!0,void(null!=(C=this.editor.uploader)&&C.upload(r,x))}if(new RegExp("^blob:"+location.origin+"/").test(o.attr("src"))){if(!this.opts.pasteImage)return;return(x={})[this.opts.pasteImage]=!0,s=this.editor.util.dataURLtoBlob,A=this.editor.uploader,(a=new Image).onload=function(){var t;(t=document.createElement("canvas")).width=a.naturalWidth,t.height=a.naturalHeight,t.getContext("2d").drawImage(a,0,0),(r=s(t.toDataURL("image/png"))).name="Clipboard Image.png",null!==A&&A.upload(r,x)},void(a.src=o.attr("src"))}if(o.is('img[src^="webkit-fake-url://"]'))return}for(I=0,u=n.length;I<u;I++)y=n[I],this.editor.selection.insertNode(y)}else if(i.is("p")&&this.editor.util.isEmptyNode(i))i.replaceWith(e),this.editor.selection.setRangeAtEndOf(e);else if(e.is("ul, ol"))if(1===e.find("li").length)for(P=0,m=(B=(e=t("<div/>").text(e.text())).contents()).length;P<m;P++)y=B[P],this.editor.selection.insertNode(t(y)[0]);else i.is("li")?(i.parent().after(e),this.editor.selection.setRangeAtEndOf(e)):(i.after(e),this.editor.selection.setRangeAtEndOf(e));else i.after(e),this.editor.selection.setRangeAtEndOf(e);else i.is("li")&&(i=i.parent()),this.editor.selection.rangeAtStartOf(i)?l="before":this.editor.selection.rangeAtEndOf(i)?l="after":(this.editor.selection.breakBlockEl(i),l="before"),i[l](e),this.editor.selection.setRangeAtEndOf(e.last())}return this.editor.inputManager.throttledValueChanged()}},o.prototype._cleanPasteFontSize=function(e){var i,o;if((i=t(e)).length>0)return o=["1.5em","1.25em","0.75em","0.5em"],i.find('[style*="font-size"]').map(function(e,i){var r;if(r=t(i),t.inArray(r.css("font-size"),o)<0)return r.css("font-size","")})},o});
//# sourceMappingURL=sourcemaps/Clipboard.js.map
