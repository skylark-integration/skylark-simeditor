/**
 * skylark-simditor - A version of simditor.js that ported to running on skylarkjs
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylark-integration/skylark-simditor/
 * @license MIT
 */
define(["skylark-jquery","../Toolbar","../Simditor","../Button","./ImagePopover"],function(e,t,o,i,r){var a=i.inherit({});return a.prototype.name="image",a.prototype.icon="picture-o",a.prototype.htmlTag="img",a.prototype.disableTag="pre, table",a.prototype.defaultImage="",a.prototype.needFocus=!1,a.prototype._init=function(){var t,o,r,a,n;if(this.editor.opts.imageButton)if(Array.isArray(this.editor.opts.imageButton))for(this.menu=[],o=0,r=(a=this.editor.opts.imageButton).length;o<r;o++)t=a[o],this.menu.push({name:t+"-image",text:this._t(t+"Image")});else this.menu=!1;else null!=this.editor.uploader?this.menu=[{name:"upload-image",text:this._t("uploadImage")},{name:"external-image",text:this._t("externalImage")}]:this.menu=!1;return this.defaultImage=this.editor.opts.defaultImage,this.editor.body.on("click","img:not([data-non-image])",(n=this,function(t){var o,i;return o=e(t.currentTarget),(i=document.createRange()).selectNode(o[0]),n.editor.selection.range(i),n.editor.util.support.onselectionchange||n.editor.trigger("selectionchanged"),!1})),this.editor.body.on("mouseup","img:not([data-non-image])",function(e){return!1}),this.editor.on("selectionchanged.image",function(t){return function(){var o,i,r;if(null!=(r=t.editor.selection.range()))return 1===(o=e(r.cloneContents()).contents()).length&&o.is("img:not([data-non-image])")?(i=e(r.startContainer).contents().eq(r.startOffset),t.popover.show(i)):t.popover.hide()}}(this)),this.editor.on("valuechanged.image",function(t){return function(){var o;if((o=t.editor.wrapper.find(".simditor-image-loading")).length>0)return o.each(function(o,i){var r,a,n;if(!((r=(a=e(i)).data("img"))&&r.parent().length>0)&&(a.remove(),r&&(n=r.data("file"))&&(t.editor.uploader.cancel(n),t.editor.body.find("img.uploading").length<1)))return t.editor.uploader.trigger("uploadready",[n])})}}(this)),i.prototype._init.call(this)},a.prototype.render=function(){var e;if(e=1<=arguments.length?Array.prototype.slice.call(arguments,0):[],i.prototype.render.apply(this,e),this.popover=new r({button:this}),"upload"===this.editor.opts.imageButton)return this._initUploader(this.el)},a.prototype.renderMenu=function(){return i.prototype.renderMenu.call(this),this._initUploader()},a.prototype._initUploader=function(t){var o,i,r,a;if(null==t&&(t=this.menuEl.find(".menu-item-upload-image")),null!=this.editor.uploader)return o=null,a=this,(i=function(){return o&&o.remove(),o=e("<input/>",{type:"file",title:a._t("uploadImage"),multiple:!0,accept:"image/gif,image/jpeg,image/jpg,image/png,image/svg"}).appendTo(t)})(),t.on("click mousedown","input[type=file]",function(e){return e.stopPropagation()}),t.on("change","input[type=file]",function(e){return function(t){return e.editor.inputManager.focused?(e.editor.uploader.upload(o,{inline:!0}),i()):(e.editor.one("focus",function(t){return e.editor.uploader.upload(o,{inline:!0}),i()}),e.editor.focus()),e.wrapper.removeClass("menu-on")}}(this)),this.editor.uploader.on("beforeupload",function(t){return function(o,i){var r;if(i.inline)return i.img?r=e(i.img):(r=t.createImage(i.name),i.img=r),r.addClass("uploading"),r.data("file",i),t.editor.uploader.readImageFile(i.obj,function(e){var o;if(r.hasClass("uploading"))return o=e?e.src:t.defaultImage,t.loadImage(r,o,function(){if(t.popover.active)return t.popover.refresh(),t.popover.srcEl.val(t._t("uploading")).prop("disabled",!0)})})}}(this)),r=e.proxy(this.editor.util.throttle(function(e,t,o,i){var r,a,n;if(t.inline&&(a=t.img.data("mask"))){if((r=a.data("img")).hasClass("uploading")&&r.parent().length>0)return(n=(100*(n=o/i)).toFixed(0))>99&&(n=99),a.find(".progress").height(100-n+"%");a.remove()}},500),this),this.editor.uploader.on("uploadprogress",r),this.editor.uploader.on("uploadsuccess",function(t){return function(o,i,r){var a,n,s;if(i.inline&&(a=i.img).hasClass("uploading")&&a.parent().length>0){if("object"!=typeof r)try{r=e.parseJSON(r)}catch(e){e,r={success:!1}}return!1===r.success?(s=r.msg||t._t("uploadFailed"),alert(s),n=t.defaultImage):n=r.file_path,t.loadImage(a,n,function(){var e;if(a.removeData("file"),a.removeClass("uploading").removeClass("loading"),(e=a.data("mask"))&&e.remove(),a.removeData("mask"),t.editor.trigger("valuechanged"),t.editor.body.find("img.uploading").length<1)return t.editor.uploader.trigger("uploadready",[i,r])}),t.popover.active?(t.popover.srcEl.prop("disabled",!1),t.popover.srcEl.val(r.file_path)):void 0}}}(this)),this.editor.uploader.on("uploaderror",function(t){return function(o,i,r){var a,n;if(i.inline&&"abort"!==r.statusText){if(r.responseText)try{(n=e.parseJSON(r.responseText)).msg}catch(e){e,t._t("uploadError")}if((a=i.img).hasClass("uploading")&&a.parent().length>0)return t.loadImage(a,t.defaultImage,function(){var e;return a.removeData("file"),a.removeClass("uploading").removeClass("loading"),(e=a.data("mask"))&&e.remove(),a.removeData("mask")}),t.popover.active&&(t.popover.srcEl.prop("disabled",!1),t.popover.srcEl.val(t.defaultImage)),t.editor.trigger("valuechanged"),t.editor.body.find("img.uploading").length<1?t.editor.uploader.trigger("uploadready",[i,n]):void 0}}}(this));this.el.find(".btn-upload").remove()},a.prototype._status=function(){return this._disableStatus()},a.prototype.loadImage=function(t,o,i){var r,a,n,s;return s=this,n=function(){var e,o;return e=t.offset(),o=s.editor.wrapper.offset(),r.css({top:e.top-o.top,left:e.left-o.left,width:t.width(),height:t.height()}).show()},t.addClass("loading"),(r=t.data("mask"))||(r=e('<div class="simditor-image-loading">\n  <div class="progress"></div>\n</div>').hide().appendTo(this.editor.wrapper),n(),t.data("mask",r),r.data("img",t)),(a=new Image).onload=function(s){return function(){var d,l;if(t.hasClass("loading")||t.hasClass("uploading"))return l=a.width,d=a.height,t.attr({src:o,width:l,height:d,"data-image-size":l+","+d}).removeClass("loading"),t.hasClass("uploading")?(s.editor.util.reflow(s.editor.body),n()):(r.remove(),t.removeData("mask")),e.isFunction(i)?i(a):void 0}}(this),a.onerror=function(){return e.isFunction(i)&&i(!1),r.remove(),t.removeData("mask").removeClass("loading")},a.src=o},a.prototype.createImage=function(t){var o,i;return null==t&&(t="Image"),this.editor.inputManager.focused||this.editor.focus(),(i=this.editor.selection.range()).deleteContents(),this.editor.selection.range(i),o=e("<img/>").attr("alt",t),i.insertNode(o[0]),this.editor.selection.setRangeAfter(o,i),this.editor.trigger("valuechanged"),o},a.prototype.command=function(e){var t,o;return t=this.createImage(),this.loadImage(t,e||this.defaultImage,(o=this,function(){return o.editor.trigger("valuechanged"),o.editor.util.reflow(t),t.click(),o.popover.one("popovershow",function(){return o.popover.srcEl.focus(),o.popover.srcEl[0].select()})}))},o.Toolbar.addButton(a),a});
//# sourceMappingURL=../sourcemaps/buttons/ImageButton.js.map
