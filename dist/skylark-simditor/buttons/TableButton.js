/**
 * skylark-simditor - A version of simditor.js that ported to running on skylarkjs
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylark-integration/skylark-simditor/
 * @license MIT
 */
define(["skylark-langx/langx","skylark-utils-dom/tables","skylark-utils-dom/query","../Toolbar","../Simditor","../Button"],function(t,e,n,i,r,a){var o=a.inherit({});return o.prototype.name="table",o.prototype.icon="table",o.prototype.htmlTag="table",o.prototype.disableTag="pre, li, blockquote",o.prototype.menu=!0,o.prototype._init=function(){var e;return a.prototype._init.call(this),t.merge(this.editor.formatter._allowedTags,["thead","th","tbody","tr","td","colgroup","col"]),t.extend(this.editor.formatter._allowedAttributes,{td:["rowspan","colspan"],col:["width"]}),t.extend(this.editor.formatter._allowedStyles,{td:["text-align"],th:["text-align"]}),this._initShortcuts(),this._initResize(),this.editor.on("decorate",(e=this,function(t,i){return i.find("table").each(function(t,i){return e.decorate(n(i))})})),this.editor.on("undecorate",function(t){return function(e,i){return i.find("table").each(function(e,i){return t.undecorate(n(i))})}}(this)),this.editor.on("selectionchanged.table",function(t){return function(e){var n,i;if(t.editor.body.find(".simditor-table td, .simditor-table th").removeClass("active"),i=t.editor.selection.range())return n=t.editor.selection.containerNode(),i.collapsed&&n.is(".simditor-table")&&t.editor.selection.setRangeAtEndOf(n),n.closest("td, th",t.editor.body).addClass("active")}}(this)),this.editor.on("blur.table",function(t){return function(e){return t.editor.body.find(".simditor-table td, .simditor-table th").removeClass("active")}}(this)),this.editor.keystroke.add("up","td",function(t){return function(e,n){return t._tdNav(n,"up"),!0}}(this)),this.editor.keystroke.add("up","th",function(t){return function(e,n){return t._tdNav(n,"up"),!0}}(this)),this.editor.keystroke.add("down","td",function(t){return function(e,n){return t._tdNav(n,"down"),!0}}(this)),this.editor.keystroke.add("down","th",function(t){return function(e,n){return t._tdNav(n,"down"),!0}}(this))},o.prototype._tdNav=function(t,e){var n,i,r,a,o;return null==e&&(e="up"),r="up"===e?"prev":"next",(o="up"===e?["tbody","thead"]:["thead","tbody"])[0],o[1],i=t.parent("tr"),!((n=this["_"+r+"Row"](i)).length>0)||(a=i.find("td, th").index(t),this.editor.selection.setRangeAtEndOf(n.find("td, th").eq(a)))},o.prototype._initResize=function(){e.resizable(document,{cssClasses:{resizeHandle:"simditor-resize-handle",wrapper:"simditor-table"}})},o.prototype._initShortcuts=function(){var t;return this.editor.hotkeys.add("ctrl+alt+up",(t=this,function(e){return t.editMenu.find(".menu-item[data-param=insertRowAbove]").click(),!1})),this.editor.hotkeys.add("ctrl+alt+down",function(t){return function(e){return t.editMenu.find(".menu-item[data-param=insertRowBelow]").click(),!1}}(this)),this.editor.hotkeys.add("ctrl+alt+left",function(t){return function(e){return t.editMenu.find(".menu-item[data-param=insertColLeft]").click(),!1}}(this)),this.editor.hotkeys.add("ctrl+alt+right",function(t){return function(e){return t.editMenu.find(".menu-item[data-param=insertColRight]").click(),!1}}(this))},o.prototype.renderMenu=function(){var t,e;return n('<div class="menu-create-table">\n</div>\n<div class="menu-edit-table">\n  <ul>\n    <li>\n      <a tabindex="-1" unselectable="on" class="menu-item"\n        href="javascript:;" data-param="deleteRow">\n        <span>'+this._t("deleteRow")+'</span>\n      </a>\n    </li>\n    <li>\n      <a tabindex="-1" unselectable="on" class="menu-item"\n        href="javascript:;" data-param="insertRowAbove">\n        <span>'+this._t("insertRowAbove")+' ( Ctrl + Alt + ↑ )</span>\n      </a>\n    </li>\n    <li>\n      <a tabindex="-1" unselectable="on" class="menu-item"\n        href="javascript:;" data-param="insertRowBelow">\n        <span>'+this._t("insertRowBelow")+' ( Ctrl + Alt + ↓ )</span>\n      </a>\n    </li>\n    <li><span class="separator"></span></li>\n    <li>\n      <a tabindex="-1" unselectable="on" class="menu-item"\n        href="javascript:;" data-param="deleteCol">\n        <span>'+this._t("deleteColumn")+'</span>\n      </a>\n    </li>\n    <li>\n      <a tabindex="-1" unselectable="on" class="menu-item"\n        href="javascript:;" data-param="insertColLeft">\n        <span>'+this._t("insertColumnLeft")+' ( Ctrl + Alt + ← )</span>\n      </a>\n    </li>\n    <li>\n      <a tabindex="-1" unselectable="on" class="menu-item"\n        href="javascript:;" data-param="insertColRight">\n        <span>'+this._t("insertColumnRight")+' ( Ctrl + Alt + → )</span>\n      </a>\n    </li>\n    <li><span class="separator"></span></li>\n    <li>\n      <a tabindex="-1" unselectable="on" class="menu-item"\n        href="javascript:;" data-param="deleteTable">\n        <span>'+this._t("deleteTable")+"</span>\n      </a>\n    </li>\n  </ul>\n</div>").appendTo(this.menuWrapper),this.createMenu=this.menuWrapper.find(".menu-create-table"),this.editMenu=this.menuWrapper.find(".menu-edit-table"),t=this.createTable(6,6).appendTo(this.createMenu),this.createMenu.on("mouseenter","td, th",(e=this,function(i){var r,a,o,s;return e.createMenu.find("td, th").removeClass("selected"),s=(a=(r=n(i.currentTarget)).parent()).find("td, th").index(r)+1,o=a.prevAll("tr").addBack(),a.parent().is("tbody")&&(o=o.add(t.find("thead tr"))),o.find("td:lt("+s+"), th:lt("+s+")").addClass("selected")})),this.createMenu.on("mouseleave",function(t){return n(t.currentTarget).find("td, th").removeClass("selected")}),this.createMenu.on("mousedown","td, th",function(e){return function(i){var r,a,o,s,d;if(e.wrapper.removeClass("menu-on"),e.editor.inputManager.focused)return s=(o=(a=n(i.currentTarget)).parent()).find("td").index(a)+1,d=o.prevAll("tr").length+1,o.parent().is("tbody")&&(d+=1),t=e.createTable(d,s,!0),r=e.editor.selection.blockNodes().last(),e.editor.util.isEmptyNode(r)?r.replaceWith(t):r.after(t),e.decorate(t),e.editor.selection.setRangeAtStartOf(t.find("th:first")),e.editor.trigger("valuechanged"),!1}}(this))},o.prototype.decorate=function(t){return n(e.decorate(t[0],{tableDecorate:"simditor-table",resizeHandle:"simditor-resize-handle"}))},o.prototype.undecorate=function(t){return n(e.undecorate(t[0],{tableDecorate:"simditor-table",resizeHandle:"simditor-resize-handle"}))},o.prototype.createTable=function(t,i,r){return n(e.createTable(t,i,r?this.editor.util.phBr:null))},o.prototype.refreshTableWidth=function(t){return table.refreshTableWidth(t[0])},o.prototype.setActive=function(t){return a.prototype.setActive.call(this,t),t?(this.createMenu.hide(),this.editMenu.show()):(this.createMenu.show(),this.editMenu.hide())},o.prototype.deleteRow=function(t){var i,r=this;return e.deleteRow(t[0],function(t,e){t&&(i=r.editor.selection.setRangeAtEndOf(n(t).find("td, th").eq(e)))}),i},o.prototype.insertRow=function(t,i){var r,a=this;return e.insertRow(t[0],i,a.editor.util.phBr,function(t,e){r=a.editor.selection.setRangeAtStartOf(n(t).find("td, th").eq(e))}),r},o.prototype.deleteCol=function(t){var i,r=this;return e.deleteCol(t[0],function(t){t&&(i=r.editor.selection.setRangeAtEndOf(n(t)))}),i},o.prototype.insertCol=function(t,i){var r,a=this;return e.insertCol(t[0],i,a.editor.util.phBr,function(t){r=a.editor.selection.setRangeAtStartOf(n(t))}),r},o.prototype.deleteTable=function(t){var n=this;e.deleteTable(t[0],function(t){if(t.length>0)return n.editor.selection.setRangeAtStartOf(t)})},o.prototype.command=function(t){var e;if((e=this.editor.selection.containerNode().closest("td, th")).length>0){if("deleteRow"===t)this.deleteRow(e);else if("insertRowAbove"===t)this.insertRow(e,"before");else if("insertRowBelow"===t)this.insertRow(e);else if("deleteCol"===t)this.deleteCol(e);else if("insertColLeft"===t)this.insertCol(e,"before");else if("insertColRight"===t)this.insertCol(e);else{if("deleteTable"!==t)return;this.deleteTable(e)}return this.editor.trigger("valuechanged")}},r.Toolbar.addButton(o),o});
//# sourceMappingURL=../sourcemaps/buttons/TableButton.js.map
