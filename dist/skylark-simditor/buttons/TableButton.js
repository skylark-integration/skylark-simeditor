/**
 * skylark-simditor - A version of simditor.js that ported to running on skylarkjs
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylark-integration/skylark-simditor/
 * @license MIT
 */
define(["skylark-utils-dom/tables","skylark-jquery","../_extend","../Module","../Toolbar","../Simditor","../Button"],function(t,e,n,i,r,o,a){var s=a.inherit({});return s.prototype.name="table",s.prototype.icon="table",s.prototype.htmlTag="table",s.prototype.disableTag="pre, li, blockquote",s.prototype.menu=!0,s.prototype._init=function(){var t;return a.prototype._init.call(this),e.merge(this.editor.formatter._allowedTags,["thead","th","tbody","tr","td","colgroup","col"]),e.extend(this.editor.formatter._allowedAttributes,{td:["rowspan","colspan"],col:["width"]}),e.extend(this.editor.formatter._allowedStyles,{td:["text-align"],th:["text-align"]}),this._initShortcuts(),this._initResize(),this.editor.on("decorate",(t=this,function(n,i){return i.find("table").each(function(n,i){return t.decorate(e(i))})})),this.editor.on("undecorate",function(t){return function(n,i){return i.find("table").each(function(n,i){return t.undecorate(e(i))})}}(this)),this.editor.on("selectionchanged.table",function(t){return function(e){var n,i;if(t.editor.body.find(".simditor-table td, .simditor-table th").removeClass("active"),i=t.editor.selection.range())return n=t.editor.selection.containerNode(),i.collapsed&&n.is(".simditor-table")&&t.editor.selection.setRangeAtEndOf(n),n.closest("td, th",t.editor.body).addClass("active")}}(this)),this.editor.on("blur.table",function(t){return function(e){return t.editor.body.find(".simditor-table td, .simditor-table th").removeClass("active")}}(this)),this.editor.keystroke.add("up","td",function(t){return function(e,n){return t._tdNav(n,"up"),!0}}(this)),this.editor.keystroke.add("up","th",function(t){return function(e,n){return t._tdNav(n,"up"),!0}}(this)),this.editor.keystroke.add("down","td",function(t){return function(e,n){return t._tdNav(n,"down"),!0}}(this)),this.editor.keystroke.add("down","th",function(t){return function(e,n){return t._tdNav(n,"down"),!0}}(this))},s.prototype._tdNav=function(t,e){var n,i,r,o,a;return null==e&&(e="up"),r="up"===e?"prev":"next",(a="up"===e?["tbody","thead"]:["thead","tbody"])[0],a[1],i=t.parent("tr"),!((n=this["_"+r+"Row"](i)).length>0)||(o=i.find("td, th").index(t),this.editor.selection.setRangeAtEndOf(n.find("td, th").eq(o)))},s.prototype._initResize=function(){var t;return t=this.editor,e(document).on("mousemove.simditor-table",".simditor-table td, .simditor-table th",function(t){var n,i,r,o,a,s,d,l;if(r=(a=e(this).parents(".simditor-table")).find(".simditor-resize-handle"),i=a.find("colgroup"),!a.hasClass("resizing"))if(o=e(t.currentTarget),t.pageX-e(t.currentTarget).offset().left<5&&o.prev().length>0&&(o=o.prev()),o.next("td, th").length<1)r.hide();else if(null!=(d=r.data("td"))&&d.is(o))r.show();else{if(s=o.parent().find("td, th").index(o),n=i.find("col").eq(s),null==(l=r.data("col"))||!l.is(n))return r.css("left",o.position().left+o.outerWidth()-5).data("td",o).data("col",n).show();r.show()}}),e(document).on("mouseleave.simditor-table",".simditor-table",function(t){return e(this).find(".simditor-resize-handle").hide()}),e(document).on("mousedown.simditor-resize-handle",".simditor-resize-handle",function(n){var i,r,o,a,s,d,l,u,c,h,f;return d=e(this).parent(".simditor-table"),o=(i=e(n.currentTarget)).data("td"),r=i.data("col"),s=o.next("td, th"),a=r.next("col"),h=n.pageX,u=1*o.outerWidth(),c=1*s.outerWidth(),l=parseFloat(i.css("left")),f=o.closest("table").width(),50,e(document).on("mousemove.simditor-resize-table",function(t){var e,n,o;return e=t.pageX-h,o=c-e,(n=u+e)<50?(n=50,o=c-(e=50-u)):o<50&&(o=50,n=u+(e=c-50)),r.attr("width",n/f*100+"%"),a.attr("width",o/f*100+"%"),i.css("left",l+e)}),e(document).one("mouseup.simditor-resize-table",function(n){return t.sync(),e(document).off(".simditor-resize-table"),d.removeClass("resizing")}),d.addClass("resizing"),!1})},s.prototype._initShortcuts=function(){var t;return this.editor.hotkeys.add("ctrl+alt+up",(t=this,function(e){return t.editMenu.find(".menu-item[data-param=insertRowAbove]").click(),!1})),this.editor.hotkeys.add("ctrl+alt+down",function(t){return function(e){return t.editMenu.find(".menu-item[data-param=insertRowBelow]").click(),!1}}(this)),this.editor.hotkeys.add("ctrl+alt+left",function(t){return function(e){return t.editMenu.find(".menu-item[data-param=insertColLeft]").click(),!1}}(this)),this.editor.hotkeys.add("ctrl+alt+right",function(t){return function(e){return t.editMenu.find(".menu-item[data-param=insertColRight]").click(),!1}}(this))},s.prototype.renderMenu=function(){var t,n;return e('<div class="menu-create-table">\n</div>\n<div class="menu-edit-table">\n  <ul>\n    <li>\n      <a tabindex="-1" unselectable="on" class="menu-item"\n        href="javascript:;" data-param="deleteRow">\n        <span>'+this._t("deleteRow")+'</span>\n      </a>\n    </li>\n    <li>\n      <a tabindex="-1" unselectable="on" class="menu-item"\n        href="javascript:;" data-param="insertRowAbove">\n        <span>'+this._t("insertRowAbove")+' ( Ctrl + Alt + ↑ )</span>\n      </a>\n    </li>\n    <li>\n      <a tabindex="-1" unselectable="on" class="menu-item"\n        href="javascript:;" data-param="insertRowBelow">\n        <span>'+this._t("insertRowBelow")+' ( Ctrl + Alt + ↓ )</span>\n      </a>\n    </li>\n    <li><span class="separator"></span></li>\n    <li>\n      <a tabindex="-1" unselectable="on" class="menu-item"\n        href="javascript:;" data-param="deleteCol">\n        <span>'+this._t("deleteColumn")+'</span>\n      </a>\n    </li>\n    <li>\n      <a tabindex="-1" unselectable="on" class="menu-item"\n        href="javascript:;" data-param="insertColLeft">\n        <span>'+this._t("insertColumnLeft")+' ( Ctrl + Alt + ← )</span>\n      </a>\n    </li>\n    <li>\n      <a tabindex="-1" unselectable="on" class="menu-item"\n        href="javascript:;" data-param="insertColRight">\n        <span>'+this._t("insertColumnRight")+' ( Ctrl + Alt + → )</span>\n      </a>\n    </li>\n    <li><span class="separator"></span></li>\n    <li>\n      <a tabindex="-1" unselectable="on" class="menu-item"\n        href="javascript:;" data-param="deleteTable">\n        <span>'+this._t("deleteTable")+"</span>\n      </a>\n    </li>\n  </ul>\n</div>").appendTo(this.menuWrapper),this.createMenu=this.menuWrapper.find(".menu-create-table"),this.editMenu=this.menuWrapper.find(".menu-edit-table"),t=this.createTable(6,6).appendTo(this.createMenu),this.createMenu.on("mouseenter","td, th",(n=this,function(i){var r,o,a,s;return n.createMenu.find("td, th").removeClass("selected"),s=(o=(r=e(i.currentTarget)).parent()).find("td, th").index(r)+1,a=o.prevAll("tr").addBack(),o.parent().is("tbody")&&(a=a.add(t.find("thead tr"))),a.find("td:lt("+s+"), th:lt("+s+")").addClass("selected")})),this.createMenu.on("mouseleave",function(t){return e(t.currentTarget).find("td, th").removeClass("selected")}),this.createMenu.on("mousedown","td, th",function(n){return function(i){var r,o,a,s,d;if(n.wrapper.removeClass("menu-on"),n.editor.inputManager.focused)return s=(a=(o=e(i.currentTarget)).parent()).find("td").index(o)+1,d=a.prevAll("tr").length+1,a.parent().is("tbody")&&(d+=1),t=n.createTable(d,s,!0),r=n.editor.selection.blockNodes().last(),n.editor.util.isEmptyNode(r)?r.replaceWith(t):r.after(t),n.decorate(t),n.editor.selection.setRangeAtStartOf(t.find("th:first")),n.editor.trigger("valuechanged"),!1}}(this))},s.prototype.decorate=function(n){return e(t.decorate(n[0],{tableDecorate:"simditor-table",resizeHandle:"simditor-resize-handle"}))},s.prototype.undecorate=function(n){return e(t.undecorate(n[0],{tableDecorate:"simditor-table",resizeHandle:"simditor-resize-handle"}))},s.prototype.createTable=function(n,i,r){return e(t.createTable(n,i,r?this.editor.util.phBr:null))},s.prototype.refreshTableWidth=function(t){return table.refreshTableWidth(t[0])},s.prototype.setActive=function(t){return a.prototype.setActive.call(this,t),t?(this.createMenu.hide(),this.editMenu.show()):(this.createMenu.show(),this.editMenu.hide())},s.prototype.deleteRow=function(n){var i,r=this;return t.deleteRow(n[0],function(t,n){t&&(i=r.editor.selection.setRangeAtEndOf(e(t).find("td, th").eq(n)))}),i},s.prototype.insertRow=function(n,i){var r,o=this;return t.insertRow(n[0],i,o.editor.util.phBr,function(t,n){r=o.editor.selection.setRangeAtStartOf(e(t).find("td, th").eq(n))}),r},s.prototype.deleteCol=function(n){var i,r=this;return t.deleteCol(n[0],function(t){t&&(i=r.editor.selection.setRangeAtEndOf(e(t)))}),i},s.prototype.insertCol=function(n,i){var r,o=this;return t.insertCol(n[0],i,o.editor.util.phBr,function(t){r=o.editor.selection.setRangeAtStartOf(e(t))}),r},s.prototype.deleteTable=function(e){var n=this;t.deleteTable(e[0],function(t){if(t.length>0)return n.editor.selection.setRangeAtStartOf(t)})},s.prototype.command=function(t){var e;if((e=this.editor.selection.containerNode().closest("td, th")).length>0){if("deleteRow"===t)this.deleteRow(e);else if("insertRowAbove"===t)this.insertRow(e,"before");else if("insertRowBelow"===t)this.insertRow(e);else if("deleteCol"===t)this.deleteCol(e);else if("insertColLeft"===t)this.insertCol(e,"before");else if("insertColRight"===t)this.insertCol(e);else{if("deleteTable"!==t)return;this.deleteTable(e)}return this.editor.trigger("valuechanged")}},o.Toolbar.addButton(s),s});
//# sourceMappingURL=../sourcemaps/buttons/TableButton.js.map
