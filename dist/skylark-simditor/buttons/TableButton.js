/**
 * skylark-simditor - A version of simditor.js that ported to running on skylarkjs
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylark-integration/skylark-simditor/
 * @license MIT
 */
define(["skylark-jquery","../_extend","../Module","../Toolbar","../Simditor","../Button"],function(t,e,n,r,i,a){var o=a.inherit({});return o.prototype.name="table",o.prototype.icon="table",o.prototype.htmlTag="table",o.prototype.disableTag="pre, li, blockquote",o.prototype.menu=!0,o.prototype._init=function(){var e;return a.prototype._init.call(this),t.merge(this.editor.formatter._allowedTags,["thead","th","tbody","tr","td","colgroup","col"]),t.extend(this.editor.formatter._allowedAttributes,{td:["rowspan","colspan"],col:["width"]}),t.extend(this.editor.formatter._allowedStyles,{td:["text-align"],th:["text-align"]}),this._initShortcuts(),this._initResize(),this.editor.on("decorate",(e=this,function(n,r){return r.find("table").each(function(n,r){return e.decorate(t(r))})})),this.editor.on("undecorate",function(e){return function(n,r){return r.find("table").each(function(n,r){return e.undecorate(t(r))})}}(this)),this.editor.on("selectionchanged.table",function(t){return function(e){var n,r;if(t.editor.body.find(".simditor-table td, .simditor-table th").removeClass("active"),r=t.editor.selection.range())return n=t.editor.selection.containerNode(),r.collapsed&&n.is(".simditor-table")&&t.editor.selection.setRangeAtEndOf(n),n.closest("td, th",t.editor.body).addClass("active")}}(this)),this.editor.on("blur.table",function(t){return function(e){return t.editor.body.find(".simditor-table td, .simditor-table th").removeClass("active")}}(this)),this.editor.keystroke.add("up","td",function(t){return function(e,n){return t._tdNav(n,"up"),!0}}(this)),this.editor.keystroke.add("up","th",function(t){return function(e,n){return t._tdNav(n,"up"),!0}}(this)),this.editor.keystroke.add("down","td",function(t){return function(e,n){return t._tdNav(n,"down"),!0}}(this)),this.editor.keystroke.add("down","th",function(t){return function(e,n){return t._tdNav(n,"down"),!0}}(this))},o.prototype._tdNav=function(t,e){var n,r,i,a,o;return null==e&&(e="up"),i="up"===e?"prev":"next",(o="up"===e?["tbody","thead"]:["thead","tbody"])[0],o[1],r=t.parent("tr"),!((n=this["_"+i+"Row"](r)).length>0)||(a=r.find("td, th").index(t),this.editor.selection.setRangeAtEndOf(n.find("td, th").eq(a)))},o.prototype._nextRow=function(t){var e;return(e=t.next("tr")).length<1&&t.parent("thead").length>0&&(e=t.parent("thead").next("tbody").find("tr:first")),e},o.prototype._prevRow=function(t){var e;return(e=t.prev("tr")).length<1&&t.parent("tbody").length>0&&(e=t.parent("tbody").prev("thead").find("tr")),e},o.prototype._initResize=function(){var e;return e=this.editor,t(document).on("mousemove.simditor-table",".simditor-table td, .simditor-table th",function(e){var n,r,i,a,o,d,s,l;if(i=(o=t(this).parents(".simditor-table")).find(".simditor-resize-handle"),r=o.find("colgroup"),!o.hasClass("resizing"))if(a=t(e.currentTarget),e.pageX-t(e.currentTarget).offset().left<5&&a.prev().length>0&&(a=a.prev()),a.next("td, th").length<1)i.hide();else if(null!=(s=i.data("td"))&&s.is(a))i.show();else{if(d=a.parent().find("td, th").index(a),n=r.find("col").eq(d),null==(l=i.data("col"))||!l.is(n))return i.css("left",a.position().left+a.outerWidth()-5).data("td",a).data("col",n).show();i.show()}}),t(document).on("mouseleave.simditor-table",".simditor-table",function(e){return t(this).find(".simditor-resize-handle").hide()}),t(document).on("mousedown.simditor-resize-handle",".simditor-resize-handle",function(n){var r,i,a,o,d,s,l,h,u,c,p;return s=t(this).parent(".simditor-table"),a=(r=t(n.currentTarget)).data("td"),i=r.data("col"),d=a.next("td, th"),o=i.next("col"),c=n.pageX,h=1*a.outerWidth(),u=1*d.outerWidth(),l=parseFloat(r.css("left")),p=a.closest("table").width(),50,t(document).on("mousemove.simditor-resize-table",function(t){var e,n,a;return e=t.pageX-c,a=u-e,(n=h+e)<50?(n=50,a=u-(e=50-h)):a<50&&(a=50,n=h+(e=u-50)),i.attr("width",n/p*100+"%"),o.attr("width",a/p*100+"%"),r.css("left",l+e)}),t(document).one("mouseup.simditor-resize-table",function(n){return e.sync(),t(document).off(".simditor-resize-table"),s.removeClass("resizing")}),s.addClass("resizing"),!1})},o.prototype._initShortcuts=function(){var t;return this.editor.hotkeys.add("ctrl+alt+up",(t=this,function(e){return t.editMenu.find(".menu-item[data-param=insertRowAbove]").click(),!1})),this.editor.hotkeys.add("ctrl+alt+down",function(t){return function(e){return t.editMenu.find(".menu-item[data-param=insertRowBelow]").click(),!1}}(this)),this.editor.hotkeys.add("ctrl+alt+left",function(t){return function(e){return t.editMenu.find(".menu-item[data-param=insertColLeft]").click(),!1}}(this)),this.editor.hotkeys.add("ctrl+alt+right",function(t){return function(e){return t.editMenu.find(".menu-item[data-param=insertColRight]").click(),!1}}(this))},o.prototype.decorate=function(e){var n,r,i,a,o;return e.parent(".simditor-table").length>0&&this.undecorate(e),e.wrap('<div class="simditor-table"></div>'),o=e.parent(".simditor-table"),n=e.find("colgroup"),e.find("thead").length<1&&(a=t("<thead />"),r=e.find("tr").first(),a.append(r),this._changeCellTag(r,"th"),(i=e.find("tbody")).length>0?i.before(a):e.prepend(a)),n.length<1&&(n=t("<colgroup/>").prependTo(e),e.find("thead tr th").each(function(e,r){return t("<col/>").appendTo(n)}),this.refreshTableWidth(e)),t("<div />",{class:"simditor-resize-handle",contenteditable:"false"}).appendTo(o),e.parent()},o.prototype.undecorate=function(t){if(t.parent(".simditor-table").length>0)return t.parent().replaceWith(t)},o.prototype.renderMenu=function(){var e,n;return t('<div class="menu-create-table">\n</div>\n<div class="menu-edit-table">\n  <ul>\n    <li>\n      <a tabindex="-1" unselectable="on" class="menu-item"\n        href="javascript:;" data-param="deleteRow">\n        <span>'+this._t("deleteRow")+'</span>\n      </a>\n    </li>\n    <li>\n      <a tabindex="-1" unselectable="on" class="menu-item"\n        href="javascript:;" data-param="insertRowAbove">\n        <span>'+this._t("insertRowAbove")+' ( Ctrl + Alt + ↑ )</span>\n      </a>\n    </li>\n    <li>\n      <a tabindex="-1" unselectable="on" class="menu-item"\n        href="javascript:;" data-param="insertRowBelow">\n        <span>'+this._t("insertRowBelow")+' ( Ctrl + Alt + ↓ )</span>\n      </a>\n    </li>\n    <li><span class="separator"></span></li>\n    <li>\n      <a tabindex="-1" unselectable="on" class="menu-item"\n        href="javascript:;" data-param="deleteCol">\n        <span>'+this._t("deleteColumn")+'</span>\n      </a>\n    </li>\n    <li>\n      <a tabindex="-1" unselectable="on" class="menu-item"\n        href="javascript:;" data-param="insertColLeft">\n        <span>'+this._t("insertColumnLeft")+' ( Ctrl + Alt + ← )</span>\n      </a>\n    </li>\n    <li>\n      <a tabindex="-1" unselectable="on" class="menu-item"\n        href="javascript:;" data-param="insertColRight">\n        <span>'+this._t("insertColumnRight")+' ( Ctrl + Alt + → )</span>\n      </a>\n    </li>\n    <li><span class="separator"></span></li>\n    <li>\n      <a tabindex="-1" unselectable="on" class="menu-item"\n        href="javascript:;" data-param="deleteTable">\n        <span>'+this._t("deleteTable")+"</span>\n      </a>\n    </li>\n  </ul>\n</div>").appendTo(this.menuWrapper),this.createMenu=this.menuWrapper.find(".menu-create-table"),this.editMenu=this.menuWrapper.find(".menu-edit-table"),e=this.createTable(6,6).appendTo(this.createMenu),this.createMenu.on("mouseenter","td, th",(n=this,function(r){var i,a,o,d;return n.createMenu.find("td, th").removeClass("selected"),d=(a=(i=t(r.currentTarget)).parent()).find("td, th").index(i)+1,o=a.prevAll("tr").addBack(),a.parent().is("tbody")&&(o=o.add(e.find("thead tr"))),o.find("td:lt("+d+"), th:lt("+d+")").addClass("selected")})),this.createMenu.on("mouseleave",function(e){return t(e.currentTarget).find("td, th").removeClass("selected")}),this.createMenu.on("mousedown","td, th",function(n){return function(r){var i,a,o,d,s;if(n.wrapper.removeClass("menu-on"),n.editor.inputManager.focused)return d=(o=(a=t(r.currentTarget)).parent()).find("td").index(a)+1,s=o.prevAll("tr").length+1,o.parent().is("tbody")&&(s+=1),e=n.createTable(s,d,!0),i=n.editor.selection.blockNodes().last(),n.editor.util.isEmptyNode(i)?i.replaceWith(e):i.after(e),n.decorate(e),n.editor.selection.setRangeAtStartOf(e.find("th:first")),n.editor.trigger("valuechanged"),!1}}(this))},o.prototype.createTable=function(e,n,r){var i,a,o,d,s,l,h,u,c,p;for(i=t("<table/>"),d=t("<thead/>").appendTo(i),a=t("<tbody/>").appendTo(i),u=l=0,c=e;0<=c?l<c:l>c;u=0<=c?++l:--l)for((s=t("<tr/>")).appendTo(0===u?d:a),h=0,p=n;0<=p?h<p:h>p;0<=p?++h:--h)o=t(0===u?"<th/>":"<td/>").appendTo(s),r&&o.append(this.editor.util.phBr);return i},o.prototype.refreshTableWidth=function(e){return setTimeout(function(){var n,r;return r=e.width(),n=e.find("col"),e.find("thead tr th").each(function(e,i){return n.eq(e).attr("width",t(i).outerWidth()/r*100+"%")})},0)},o.prototype.setActive=function(t){return a.prototype.setActive.call(this,t),t?(this.createMenu.hide(),this.editMenu.show()):(this.createMenu.show(),this.editMenu.hide())},o.prototype._changeCellTag=function(e,n){return e.find("td, th").each(function(e,r){var i;return(i=t(r)).replaceWith("<"+n+">"+i.html()+"</"+n+">")})},o.prototype.deleteRow=function(t){var e,n,r;return(n=t.parent("tr")).closest("table").find("tr").length<1?this.deleteTable(t):((e=this._nextRow(n)).length>0||(e=this._prevRow(n)),r=n.find("td, th").index(t),n.parent().is("thead")&&(e.appendTo(n.parent()),this._changeCellTag(e,"th")),n.remove(),this.editor.selection.setRangeAtEndOf(e.find("td, th").eq(r)))},o.prototype.insertRow=function(e,n){var r,i,a,o,d,s,l,h;for(null==n&&(n="after"),i=(a=e.parent("tr")).closest("table"),d=0,i.find("tr").each(function(e,n){return d=Math.max(d,t(n).find("td").length)}),s=a.find("td, th").index(e),r=t("<tr/>"),o="td","after"===n&&a.parent().is("thead")?a.parent().next("tbody").prepend(r):"before"===n&&a.parent().is("thead")?(a.before(r),a.parent().next("tbody").prepend(a),this._changeCellTag(a,"td"),o="th"):a[n](r),l=1,h=d;1<=h?l<=h:l>=h;1<=h?++l:--l)t("<"+o+"/>").append(this.editor.util.phBr).appendTo(r);return this.editor.selection.setRangeAtStartOf(r.find("td, th").eq(s))},o.prototype.deleteCol=function(e){var n,r,i,a,o,d;return d=(i=e.parent("tr")).closest("table").find("tr").length<2,o=e.siblings("td, th").length<1,d&&o?this.deleteTable(e):(a=i.find("td, th").index(e),(n=e.next("td, th")).length>0||(n=i.prev("td, th")),(r=i.closest("table")).find("col").eq(a).remove(),r.find("tr").each(function(e,n){return t(n).find("td, th").eq(a).remove()}),this.refreshTableWidth(r),this.editor.selection.setRangeAtEndOf(n))},o.prototype.insertCol=function(e,n){var r,i,a,o,d,s,l,h,u;return null==n&&(n="after"),d=e.parent("tr"),s=d.find("td, th").index(e),r=(o=e.closest("table")).find("col").eq(s),o.find("tr").each((u=this,function(e,r){var i,a;return a=t(r).parent().is("thead")?"th":"td",i=t("<"+a+"/>").append(u.editor.util.phBr),t(r).find("td, th").eq(s)[n](i)})),i=t("<col/>"),r[n](i),l=o.width(),h=Math.max(parseFloat(r.attr("width"))/2,50/l*100),r.attr("width",h+"%"),i.attr("width",h+"%"),this.refreshTableWidth(o),a="after"===n?e.next("td, th"):e.prev("td, th"),this.editor.selection.setRangeAtStartOf(a)},o.prototype.deleteTable=function(t){var e,n;if(e=(n=t.closest(".simditor-table")).next("p"),n.remove(),e.length>0)return this.editor.selection.setRangeAtStartOf(e)},o.prototype.command=function(t){var e;if((e=this.editor.selection.containerNode().closest("td, th")).length>0){if("deleteRow"===t)this.deleteRow(e);else if("insertRowAbove"===t)this.insertRow(e,"before");else if("insertRowBelow"===t)this.insertRow(e);else if("deleteCol"===t)this.deleteCol(e);else if("insertColLeft"===t)this.insertCol(e,"before");else if("insertColRight"===t)this.insertCol(e);else{if("deleteTable"!==t)return;this.deleteTable(e)}return this.editor.trigger("valuechanged")}},i.Toolbar.addButton(o),o});
//# sourceMappingURL=../sourcemaps/buttons/TableButton.js.map
