/**
 * skylark-simditor - A version of simditor.js that ported to running on skylarkjs
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylark-integration/skylark-simditor/
 * @license MIT
 */
define([],function(){"use strict";var t={},i={};function e(t){return"object"!=typeof t||Array.isArray(t)||!function(t){var i;for(i in t)return!1;return!0}(t)}return define(["skylark-jquery","./_extend","./Module","./hotkeys","./uploader","./Util","./InputManager","./Selection","./UndoManager","./Keystroke","./Formatter","./Toolbar","./Indentation","./Clipboard","./i18n"],function(t,i,e,r,s,o,a,n,h,d,l,p,u,c,f){var m=e.inherit({});return m.count=0,m.prototype.opts={textarea:null,placeholder:"",defaultImage:"images/image.png",params:{},upload:!1,indentWidth:40},m.prototype._init=function(){var i,e,f;if(this.util=new o(this),this.textarea=t(this.opts.textarea),this.opts.placeholder=this.opts.placeholder||this.textarea.attr("placeholder"),!this.textarea.length)throw new Error("simditor: param textarea is required.");if(null!=(i=this.textarea.data("simditor"))&&i.destroy(),this.id=++m.count,this._render(),!r)throw new Error("simditor: simple-hotkeys is required.");if(this.hotkeys=r({el:this.body}),this.opts.upload&&s&&(e="object"==typeof this.opts.upload?this.opts.upload:{},this.uploader=s(e)),this.on("initialized",(f=this,function(){if(f.opts.placeholder&&f.on("valuechanged",function(){return f._placeholder()}),f.setValue(f.textarea.val().trim()||""),f.textarea.attr("autofocus"))return f.focus()})),this.util.browser.mozilla){this.util.reflow();try{return document.execCommand("enableObjectResizing",!1,!1),document.execCommand("enableInlineTableEditing",!1,!1)}catch(t){t}}this.inputManager=new a(this),this.selection=new n(this),this.undoManager=new h(this),this.keystroke=new d(this),this.formatter=new l(this),this.toolbar=new p(this),this.indentation=new u(this),this.clipboard=new c(this)},m.prototype._tpl='<div class="simditor">\n  <div class="simditor-wrapper">\n    <div class="simditor-placeholder"></div>\n    <div class="simditor-body" contenteditable="true">\n    </div>\n  </div>\n</div>',m.prototype._render=function(){var i,e,r,s;if(this.el=t(this._tpl).insertBefore(this.textarea),this.wrapper=this.el.find(".simditor-wrapper"),this.body=this.wrapper.find(".simditor-body"),this.placeholderEl=this.wrapper.find(".simditor-placeholder").append(this.opts.placeholder),this.el.data("simditor",this),this.wrapper.append(this.textarea),this.textarea.data("simditor",this).blur(),this.body.attr("tabindex",this.textarea.attr("tabindex")),this.util.os.mac?this.el.addClass("simditor-mac"):this.util.os.linux&&this.el.addClass("simditor-linux"),this.util.os.mobile&&this.el.addClass("simditor-mobile"),this.opts.params){for(i in r=[],e=this.opts.params)s=e[i],r.push(t("<input/>",{type:"hidden",name:i,value:s}).insertAfter(this.textarea));return r}},m.prototype._placeholder=function(){var t;return 0===(t=this.body.children()).length||1===t.length&&this.util.isEmptyNode(t)&&parseInt(t.css("margin-left")||0)<this.opts.indentWidth?this.placeholderEl.show():this.placeholderEl.hide()},m.prototype.setValue=function(t){return this.hidePopover(),this.textarea.val(t),this.body.get(0).innerHTML=t,this.formatter.format(),this.formatter.decorate(),this.util.reflow(this.body),this.inputManager.lastCaretPosition=null,this.trigger("valuechanged")},m.prototype.getValue=function(){return this.sync()},m.prototype.sync=function(){var i,e,r,s,o,a;for(e=this.body.clone(),this.formatter.undecorate(e),this.formatter.format(e),this.formatter.autolink(e),o=(i=e.children()).last("p"),s=i.first("p");o.is("p")&&this.util.isEmptyNode(o);)r=o,o=o.prev("p"),r.remove();for(;s.is("p")&&this.util.isEmptyNode(s);)r=s,s=o.next("p"),r.remove();return e.find("img.uploading").remove(),a=t.trim(e.html()),this.textarea.val(a),a},m.prototype.focus=function(){var i,e;if(this.body.is(":visible")&&this.body.is("[contenteditable]"))return this.inputManager.lastCaretPosition?(this.undoManager.caretPosition(this.inputManager.lastCaretPosition),this.inputManager.lastCaretPosition=null):((i=this.body.children().last()).is("p")||(i=t("<p/>").append(this.util.phBr).appendTo(this.body)),e=document.createRange(),this.selection.setRangeAtEndOf(i,e));this.el.find("textarea:visible").focus()},m.prototype.blur=function(){return this.body.is(":visible")&&this.body.is("[contenteditable]")?this.body.blur():this.body.find("textarea:visible").blur()},m.prototype.hidePopover=function(){return this.el.find(".simditor-popover").each(function(i,e){if((e=t(e).data("popover")).active)return e.hide()})},m.prototype.destroy=function(){return this.triggerHandler("destroy"),this.textarea.closest("form").off(".simditor .simditor-"+this.id),this.selection.clear(),this.inputManager.focused=!1,this.textarea.insertBefore(this.el).hide().val("").removeData("simditor"),this.el.remove(),t(document).off(".simditor-"+this.id),t(window).off(".simditor-"+this.id),this.off()},m.Toolbar=p,m.i18n=f,m}),e(i)?i:e(t)?t:void 0});
//# sourceMappingURL=sourcemaps/Simditor.js.map
