/**
 * skylark-simditor - A version of simditor.js that ported to running on skylarkjs
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylark-integration/skylark-simditor/
 * @license MIT
 */
define([],function(){"use strict";var t={},i={};function e(t){return"object"!=typeof t||Array.isArray(t)||!function(t){var i;for(i in t)return!1;return!0}(t)}return define(["skylark-langx/langx","skylark-utils-dom/query","skylark-ui-contents/hotkeys","skylark-ui-contents/Util","skylark-ui-contents/InputManager","skylark-ui-contents/Selection","skylark-ui-contents/UndoManager","skylark-ui-contents/Keystroke","skylark-ui-contents/Formatter","skylark-ui-contents/Indentation","skylark-ui-contents/Clipboard","./Toolbar","./uploader","./i18n"],function(t,i,e,r,s,o,a,n,l,h,d,p,u,c){var f=t.Evented.inherit({init:function(c){this.opts=t.extend({},this.opts,c);var m,y,b={classPrefix:"simditor-"};if(this.util=new r(this,b),this.textarea=i(this.opts.textarea),this.opts.placeholder=this.opts.placeholder||this.textarea.attr("placeholder"),!this.textarea.length)throw new Error("simditor: param textarea is required.");if(null!=(m=this.textarea.data("simditor"))&&m.destroy(),this.id=++f.count,this._render(),!e)throw new Error("simditor: simple-hotkeys is required.");this.hotkeys=e({el:this.body}),this.opts.upload&&u&&(y="object"==typeof this.opts.upload?this.opts.upload:{},this.uploader=u(y)),this.inputManager=new s(this,b),this.selection=new o(this,b),this.undoManager=new a(this,b),this.keystroke=new n(this,b),this.formatter=new l(this,b),this.toolbar=new p(this,{toolbar:this.opts.toolbar,toolbarFloat:this.opts.toolbarFloat,toolbarHidden:this.opts.toolbarHidden,toolbarFloatOffset:this.opts.toolbarFloatOffset}),this.indentation=new h(this,b),this.clipboard=new d(this,b);var v=this;if(this.opts.placeholder&&this.on("valuechanged",function(){return v._placeholder()}),this.setValue(this.textarea.val().trim()||""),this.textarea.attr("autofocus"))return v.focus();if(this.util.browser.mozilla){this.util.reflow();try{return document.execCommand("enableObjectResizing",!1,!1),document.execCommand("enableInlineTableEditing",!1,!1)}catch(t){t}}}});return f.prototype.triggerHandler=f.prototype.trigger=function(i,e){var r;return r=[i],e&&(r=r.concat(e)),t.Evented.prototype.trigger.apply(this,r),this},f.count=0,f.prototype.opts={textarea:null,placeholder:"",defaultImage:"images/image.png",params:{},upload:!1,indentWidth:40},f.prototype._tpl='<div class="simditor">\n  <div class="simditor-wrapper">\n    <div class="simditor-placeholder"></div>\n    <div class="simditor-body" contenteditable="true">\n    </div>\n  </div>\n</div>',f.prototype._render=function(){var t,e,r,s;if(this.el=i(this._tpl).insertBefore(this.textarea),this.wrapper=this.el.find(".simditor-wrapper"),this.body=this.wrapper.find(".simditor-body"),this.placeholderEl=this.wrapper.find(".simditor-placeholder").append(this.opts.placeholder),this.el.data("simditor",this),this.wrapper.append(this.textarea),this.textarea.data("simditor",this).blur(),this.body.attr("tabindex",this.textarea.attr("tabindex")),this.util.os.mac?this.el.addClass("simditor-mac"):this.util.os.linux&&this.el.addClass("simditor-linux"),this.util.os.mobile&&this.el.addClass("simditor-mobile"),this.opts.params){for(t in r=[],e=this.opts.params)s=e[t],r.push(i("<input/>",{type:"hidden",name:t,value:s}).insertAfter(this.textarea));return r}},f.prototype._placeholder=function(){var t;return 0===(t=this.body.children()).length||1===t.length&&this.util.isEmptyNode(t)&&parseInt(t.css("margin-left")||0)<this.opts.indentWidth?this.placeholderEl.show():this.placeholderEl.hide()},f.prototype.setValue=function(t){return this.hidePopover(),this.textarea.val(t),this.body.get(0).innerHTML=t,this.formatter.format(),this.formatter.decorate(),this.util.reflow(this.body),this.inputManager.lastCaretPosition=null,this.trigger("valuechanged")},f.prototype.getValue=function(){return this.sync()},f.prototype.sync=function(){var i,e,r,s,o,a;for(e=this.body.clone(),this.formatter.undecorate(e),this.formatter.format(e),this.formatter.autolink(e),o=(i=e.children()).last("p"),s=i.first("p");o.is("p")&&this.util.isEmptyNode(o);)r=o,o=o.prev("p"),r.remove();for(;s.is("p")&&this.util.isEmptyNode(s);)r=s,s=o.next("p"),r.remove();return e.find("img.uploading").remove(),a=t.trim(e.html()),this.textarea.val(a),a},f.prototype.focus=function(){var t,e;if(this.body.is(":visible")&&this.body.is("[contenteditable]"))return this.inputManager.lastCaretPosition?(this.undoManager.caretPosition(this.inputManager.lastCaretPosition),this.inputManager.lastCaretPosition=null):((t=this.body.children().last()).is("p")||(t=i("<p/>").append(this.util.phBr).appendTo(this.body)),e=document.createRange(),this.selection.setRangeAtEndOf(t,e));this.el.find("textarea:visible").focus()},f.prototype.blur=function(){return this.body.is(":visible")&&this.body.is("[contenteditable]")?this.body.blur():this.body.find("textarea:visible").blur()},f.prototype.hidePopover=function(){return this.el.find(".simditor-popover").each(function(t,e){if((e=i(e).data("popover")).active)return e.hide()})},f.prototype.destroy=function(){return this.triggerHandler("destroy"),this.textarea.closest("form").off(".simditor .simditor-"+this.id),this.selection.clear(),this.inputManager.focused=!1,this.textarea.insertBefore(this.el).hide().val("").removeData("simditor"),this.el.remove(),i(document).off(".simditor-"+this.id),i(window).off(".simditor-"+this.id),this.off()},f.Toolbar=p,f.i18n=c,f}),e(i)?i:e(t)?t:void 0});
//# sourceMappingURL=sourcemaps/Simditor.js.map
